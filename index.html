<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conteo de Inventario PXG</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style id="app-style">
    /* Ocultar elementos exclusivos del administrador por defecto */
.admin-only {
    display: none !important;
}

/* Mostrar elementos exclusivos del administrador si el usuario es admin */
.is-admin .admin-only {
    display: block !important;
}
    
    .bg-navy {
      background-color: #0a192f;
    }
    .text-navy {
      color: #0a192f;
    }
    .border-navy {
      border-color: #0a192f;
    }
    .hover-bg-navy:hover {
      background-color: #0a192f;
      color: white;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-hover tr:hover {
      background-color: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .loader {
      border-top-color: #0a192f;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-navy shadow-md">
    <div class="container mx-auto px-4 py-5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-warehouse text-white text-3xl mr-3"></i>
          <h1 class="text-2xl font-bold text-white">Sistema de Conteo de Inventario PXG</h1>
        </div>
        <div>
          <button id="logout-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded-md text-sm transition-all">
        <i class="fas fa-sign-out-alt mr-1"></i>Cerrar Sesi√≥n
    </button>
          <button id="reset-data-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
            <i class="fas fa-trash-alt mr-2"></i>Reiniciar Datos
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- Add tab navigation -->
<!-- Modifica las pesta√±as del men√∫ -->
<div class="flex border-b border-gray-200">
  <button id="tab-admin" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
    <i class="fas fa-cog"></i> Administraci√≥n
  </button>
  <button id="tab-inventory" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
    <i class="fas fa-boxes"></i> Conteo de Inventario
  </button>
  <button id="tab-view" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
    <i class="fas fa-tasks"></i> Vista de Asignaciones
  </button>
  <button id="tab-inventory-numbers" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
    <i class="fas fa-list"></i> N√∫meros de Inventario
  </button>
</div>
  <!-- Main Content with two tab containers -->
  <main class="container mx-auto px-4 py-6">
    <!-- Tab 1: Administraci√≥n -->
    <div id="content-admin" class="block">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Left Column - User Assignment Form -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignaci√≥n de Usuario para Conteo</h2>

          <form id="assignment-form" class="space-y-4">
            <div>
              <label for="user-assignment" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input type="text" id="user-assignment" name="user-assignment" list="user-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
               <datalist id="user-list"> </datalist>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack-assignment" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack-assignment" name="rack-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                  <option value="AREA_KITEO">AREA KITEO</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location-assignment" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                <select id="location-assignment" name="location-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicaci√≥n</option>
                </select>
              </div>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number-assignment" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
              <input type="text" id="part-number-assignment" name="part-number-assignment" list="part-number-list-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese n√∫mero de parte">
              <datalist id="part-number-list-assignment">
                <!-- Se llenar√° con JavaScript -->
              </datalist>
            </div>

 <!-- Asignaci√≥n Pendiente -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">¬øEs una asignaci√≥n pendiente?</label>
      <div class="flex items-center space-x-4">
        <label class="flex items-center">
          <input type="radio" name="es_asignacion" value="true" checked class="mr-2">
          S√≠
        </label>
        <label class="flex items-center">
          <input type="radio" name="es_asignacion" value="false" class="mr-2">
          No
        </label>
      </div>
    </div>

            
            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="assignment-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
                Asignar Usuario
              </button>
            </div>
          </form>
        </div>

        <!-- Right Column - User Registration -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de Usuarios para Conteo</h2>

          <form id="user-register-form" class="mb-6 flex items-end space-x-2">
            <div class="flex-1">
              <label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
              <input type="text" id="new-user-name" name="new-user-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre del usuario">
            </div>
            <div class="flex-1">
              <label for="new-user-area" class="block text-sm font-medium text-gray-700 mb-1">√Årea</label>
              <input type="text" id="new-user-area" name="new-user-area" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="√Årea o puesto">
            </div>
            <button type="submit" class="bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Usuario
            </button>
          </form>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-hover">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√Årea</th>
                </tr>
              </thead>
              <tbody id="user-registry" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Lupta</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Kiteo</div>
                  </td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Alan Ramos</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Producci√≥n</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

<!-- Tab 4: N√∫meros de Inventario -->
<div id="content-inventory-numbers" class="hidden">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de N√∫meros de Inventario</h2>
    <form id="inventory-numbers-form" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Select de N√∫mero de Inventario -->
        <div>
          <label for="inventory-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Inventario</label>
          <select id="inventory-number" name="inventory-number" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione un n√∫mero de inventario</option>
            <!-- Opciones se cargar√°n din√°micamente desde Supabase -->
          </select>
        </div>
        <!-- Select de Rack -->
        <div>
          <label for="inventory-rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
          <select id="inventory-rack" name="inventory-rack" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione un Rack</option>
            <option value="A">Rack A</option>
            <option value="B">Rack B</option>
            <option value="C">Rack C</option>
            <option value="D">Rack D</option>
            <option value="E">Rack E</option>
            <option value="F">Rack F</option>
            <option value="G">Rack G</option>
            <option value="AREA_KITEO">AREA KITEO</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Select de Ubicaci√≥n -->
        <div>
          <label for="inventory-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
          <select id="inventory-location" name="inventory-location" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione ubicaci√≥n</option>
          </select>
        </div>
        <!-- Input de Usuario -->
        <div>
          <label for="inventory-user" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
          <input type="text" id="inventory-user" name="inventory-user" list="user-list-inventory-numbers" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Seleccione o ingrese usuario">
          <datalist id="user-list-inventory-numbers">
            <!-- Opciones se cargar√°n din√°micamente -->
          </datalist>
        </div>
      </div>
      <!-- Input de Cantidad -->
      <div>
        <label for="inventory-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
        <input type="number" id="inventory-quantity" name="inventory-quantity" min="1" required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Ingrese cantidad">
      </div>
      <!-- Bot√≥n de Registrar -->
      <div class="pt-2">
        <button type="submit" id="inventory-numbers-submit-btn"
          class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
          Registrar N√∫mero de Inventario
        </button>
      </div>
    </form>
  </div>
</div>




    
    <!-- Tab 2: Conteo de Inventario -->
    <div id="content-inventory" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Form Column -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro Manual de Inventario</h2>

          <form id="inventory-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack" name="rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                  <option value="AREA_KITEO">AREA KITEO</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                <select id="location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicaci√≥n</option>
                </select>
              </div>
            </div>

            <!-- User Assignment -->
            <div>
              <label for="user" class="block text-sm font-medium text-gray-700 mb-1">Usuario Asignado</label>
              <input type="text" id="user" name="user" list="user-list-inventory" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
              <datalist id="user-list-inventory">
                <option value="Lupta (Kiteo)">
                <option value="Alan Ramos (Producci√≥n)">
                <option value="Carlos M√©ndez (Almac√©n)">
                <option value="Maria Gonz√°lez (Inventario)">
              </datalist>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
              <input type="text" id="part-number" name="part-number" list="part-number-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese n√∫mero de parte">
              <datalist id="part-number-list">
                <!-- Se llenar√° con JavaScript -->
              </datalist>
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
              <input type="text" id="description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese descripci√≥n del producto">
            </div>

            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input type="number" id="quantity" name="quantity" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad contada">
            </div>

            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all flex items-center justify-center">
                <span id="submit-text">Registrar Conteo</span>
                <span id="submit-loader" class="hidden ml-2">
                  <div class="loader h-5 w-5 rounded-full border-2 border-white border-t-4"></div>
                </span>
              </button>
            </div>
          </form>
        </div>

<!-- Tabla de Total por N√∫mero de Parte -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6" style="width: 740px; height: auto;">
  <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Total por N√∫mero de Parte</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 table-hover">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero de Parte</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
        </tr>
      </thead>
      <tbody id="total-by-part-number" class="bg-white divide-y divide-gray-200">
        <!-- Los datos se llenar√°n con JavaScript -->
        <tr>
          <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>



        
       <!-- Summary Column -->
        <div class="md:col-span-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Resumen por Rack</h2>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-hover">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total √çtems</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                     <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Actualizacion</th>
                  </tr>
                </thead>
                <tbody id="rack-summary-body" class="bg-white divide-y divide-gray-200">
                  <!-- Rack summary data will be inserted here via JavaScript -->
                  <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>


      <!-- User Assignment Summary -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Conteo por Usuario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√çtems Contados</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√öltimo Conteo</th>
              </tr>
            </thead>
            <tbody id="user-summary" class="bg-white divide-y divide-gray-200">
              <!-- User summary data will be inserted here via JavaScript -->
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>


<div class="flex space-x-2 mb-4">
  <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-all">
    <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
  </button>
  <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
    <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
  </button>
</div>


      
<div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-4">
  <!-- Filtro por Usuario -->
  <div class="flex-1 mb-2 md:mb-0">
    <label for="filter-user" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Usuario</label>
    <input type="text" id="filter-user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Alan Ramos">
  </div>

  <!-- Filtro por N√∫mero de Parte -->
  <div class="flex-1 mb-2 md:mb-0">
    <label for="filter-part" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por N√∫mero de Parte</label>
    <input type="text" id="filter-part" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: ABC123">
  </div>

  <!-- Bot√≥n para limpiar filtros -->
  <div class="flex items-end mb-2 md:mb-0">
    <button id="clear-filters-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-all h-10">
      <i class="fas fa-times mr-2"></i>Limpiar
    </button>
  </div>
</div>
    
      <!-- Inventory Records -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registros de Inventario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicaci√≥n</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="inventory-records" class="bg-white divide-y divide-gray-200">
              <!-- Inventory records will be inserted here via JavaScript -->
              <tr>
                <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Cargando registros...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
   <!-- Tab 3: Vista de Asignaciones -->
<div id="content-view" class="hidden">
  <div class="bg-white rounded-lg shadow-md p-2">
    <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignaciones Pendientes</h2>
    <div class="overflow-x-auto">
      <table class="w-full divide-y divide-gray-200 table-hover">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Rack</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Ubicaci√≥n</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">N√∫mero de Parte</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Descripci√≥n</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Usuario Asignado</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Cantidad Contada</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-2">Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="assignment-list" class="bg-white divide-y divide-gray-200">
          <!-- Assignment data will be inserted here -->
          <tr>
            <td colspan="7" class="py-4 text-center text-sm text-gray-500">
              No hay asignaciones disponibles
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
  </main>
  <!-- Footer -->
  <footer class="bg-navy text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Sistema de Conteo de Inventario PXG | Todos los derechos reservados</p>
      <p>&copy; En caso de necesitar asistencia t√©cnica, ponte en contacto con el administrador del sistema IT: Julio</p>
    </div>
  </footer>
  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script id="app-script">
 // CONFIGURACI√ìN SUPABASE (Repetida aqu√≠ para el script de autenticaci√≥n)
    const SUPABASE_URL_AUTH = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
    const SUPABASE_ANON_KEY_AUTH = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';

    // Inicializar cliente Supabase solo para autenticaci√≥n
    const authSupabase = window.supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH, {
        auth: {
            persistSession: true, // Muy importante para mantener la sesi√≥n
            autoRefreshToken: true
        }
    });


    
function showTab(activeTab, activeContent, otherTabs, otherContents) {
    // Verificar que activeTab y activeTab.id existan
    if (!activeTab || !activeTab.id) {
        console.error('Error: activeTab o activeTab.id no est√°n definidos.');
        return;
    }

    // Verificar si el usuario es "viewer" y est√° intentando acceder a una pesta√±a no permitida
    if (!document.body.classList.contains('is-admin') && ['tab-admin', 'tab-inventory'].includes(activeTab.id)) {
        Swal.fire({
            icon: 'error',
            title: 'Acceso denegado',
            text: 'No tienes permiso para acceder a esta secci√≥n.',
        });
        return;
    }

    // Limpiar estilos de todas las pesta√±as
    const allTabs = [activeTab, ...otherTabs];
    allTabs.forEach(tab => {
        if (tab) { // Verificar que tab no sea null o undefined
            tab.classList.remove('border-b-2', 'border-navy', 'text-navy');
            tab.classList.add('text-gray-500');
        }
    });

    // Aplicar estilo a la pesta√±a activa
    activeTab.classList.add('border-b-2', 'border-navy', 'text-navy');
    activeTab.classList.remove('text-gray-500');

    // Mostrar/ocultar contenido
    const allContents = [activeContent, ...otherContents];
    allContents.forEach(content => {
        if (content) { // Verificar que content no sea null o undefined
            content.classList.add('hidden');
            content.classList.remove('block');
        }
    });

    if (activeContent) { // Verificar que activeContent no sea null o undefined
        activeContent.classList.remove('hidden');
        activeContent.classList.add('block');
    }
}


    

    // Verificar sesi√≥n al cargar la p√°gina
   document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîê Verificando sesi√≥n de usuario y cargando datos iniciales...');

    try {
        // --- 1. Verificar sesi√≥n de usuario ---
        const { data: { session }, error } = await authSupabase.auth.getSession();
        if (error) {
            console.error('Error obteniendo sesi√≥n:', error.message);
            window.location.href = 'login_completo.html';
            return;
        }
        if (!session) {
            console.warn('‚ö†Ô∏è No hay sesi√≥n activa. Redirigiendo al login...');
            window.location.href = 'login_completo.html';
            return;
        }
        console.log('‚úÖ Usuario autenticado:', session.user.email);

        // --- 2. Verificar rol del usuario ---
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('role')
            .eq('email', session.user.email)
            .single();

        if (userError || !userData) {
            console.error('Error al obtener el rol del usuario:', userError);
            return;
        }

        // Aplicar clase al body seg√∫n el rol
        if (userData.role === 'admin') {
            document.body.classList.add('is-admin');
            console.log('‚úÖ Usuario es administrador. Mostrando todas las opciones.');
        } else {
            document.body.classList.remove('is-admin');
            console.log('‚ÑπÔ∏è Usuario es "viewer". Restringiendo acceso a pesta√±as.');
        }

        // --- 3. Configurar pesta√±as seg√∫n el rol ---
        const tabAdmin = document.getElementById('tab-admin');
        const tabInventory = document.getElementById('tab-inventory');
        const tabView = document.getElementById('tab-view');
        const tabInventoryNumbers = document.getElementById('tab-inventory-numbers');
        const contentAdmin = document.getElementById('content-admin');
        const contentInventory = document.getElementById('content-inventory');
        const contentView = document.getElementById('content-view');
        const contentInventoryNumbers = document.getElementById('content-inventory-numbers');

        // Si el usuario es "viewer", ocultar las pesta√±as de admin
        if (userData.role !== 'admin') {
            tabAdmin.style.display = 'none';
            tabInventory.style.display = 'none';
        }

        // --- 4. Mostrar la pesta√±a adecuada seg√∫n el rol ---
        if (userData.role === 'admin') {
            // Mostrar la pesta√±a de Administraci√≥n por defecto
            showTab(tabAdmin, contentAdmin, [tabInventory, tabView, tabInventoryNumbers], [contentInventory, contentView, contentInventoryNumbers]);
        } else {
            // Mostrar la pesta√±a de Vista de Asignaciones por defecto
            showTab(tabView, contentView, [tabAdmin, tabInventory, tabInventoryNumbers], [contentAdmin, contentInventory, contentInventoryNumbers]);
            loadAssignments();
        }

        // --- 5. Configurar los eventos de clic para las pesta√±as ---
        tabAdmin?.addEventListener('click', function() {
            showTab(tabAdmin, contentAdmin, [tabInventory, tabView, tabInventoryNumbers], [contentInventory, contentView, contentInventoryNumbers]);
        });

        tabInventory?.addEventListener('click', function() {
            showTab(tabInventory, contentInventory, [tabAdmin, tabView, tabInventoryNumbers], [contentAdmin, contentView, contentInventoryNumbers]);
        });

        tabView?.addEventListener('click', function() {
            showTab(tabView, contentView, [tabAdmin, tabInventory, tabInventoryNumbers], [contentAdmin, contentInventory, contentInventoryNumbers]);
            loadAssignments();
        });

        tabInventoryNumbers?.addEventListener('click', function() {
            showTab(tabInventoryNumbers, contentInventoryNumbers, [tabAdmin, tabInventory, tabView], [contentAdmin, contentInventory, contentView]);
            loadInventoryNumbers();
            loadUserData();
        });

        // --- 6. Cargar datos iniciales ---
        loadInventoryData();
        loadUserData();
        loadPartNumbers('part-number-list');
        loadPartNumbers('part-number-list-assignment');

    } catch (err) {
        console.error('Error inesperado al cargar la p√°gina:', err);
        Swal.fire('Error', 'Ocurri√≥ un error al cargar la aplicaci√≥n.', 'error');
    }
});

    // CONFIGURACI√ìN SUPABASE
    const SUPABASE_URL = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // Variables globales
    let inventoryData = [];
    let userData = [];
    const rackLocations = {
      'A': 48, 'B': 48, 'C': 48, 'D': 42, 'E': 42, 'F': 21, 'G': 32
    };

    // FUNCIONES DE SUPABASE PARA INVENTARIO
    async function getAllInventoryRecords() {
      try {
        console.log('Obteniendo registros de Supabase...');
        const { data, error } = await supabase
          .from('conteoinventario')
          .select('*')
          .order('fecha_creacion', { ascending: false });

        if (error) {
          console.error('Error de Supabase:', error);
          throw error;
        }
        console.log('Registros obtenidos:', data?.length || 0);
        return data || [];
      } catch (error) {
        console.error('Error getting records:', error);
        Swal.fire('Error', 'No se pudieron cargar los datos de la base de datos', 'error');
        return [];
      }
    }

    async function insertInventoryRecord(record) {
      try {
        const supabaseRecord = {
          rack: record.rack,
          ubicacion: record.location,
          usuario_asignado: record.user,
          numero_parte: record.partNumber,
          descripcion: record.description,
          cantidad: record.quantity
        };

        console.log('Insertando registro:', supabaseRecord);
        const { data, error } = await supabase
          .from('conteoinventario')
          .insert([supabaseRecord])
          .select();

        if (error) throw error;

        console.log('Registro insertado:', data[0]);
        return {
          id: data[0].id,
          ...record,
          fecha_creacion: data[0].fecha_creacion
        };
      } catch (error) {
        console.error('Error inserting record:', error);
        throw error;
      }
    }

    async function updateInventoryRecord(updatedRecord) {
  try {
    // Obtener el registro actual para comparar la cantidad
    const { data: currentRecord, error: fetchError } = await supabase
      .from('conteoinventario')
      .select('cantidad, modificaciones')
      .eq('id', updatedRecord.id)
      .single();

    if (fetchError) throw fetchError;

    // Incrementar el conteo de modificaciones si la cantidad cambi√≥
    let modificaciones = currentRecord.modificaciones || 0;
    if (currentRecord.cantidad !== updatedRecord.quantity) {
      modificaciones += 1;
    }

    const supabaseRecord = {
      rack: updatedRecord.rack,
      ubicacion: updatedRecord.location,
      usuario_asignado: updatedRecord.user,
      numero_parte: updatedRecord.partNumber,
      descripcion: updatedRecord.description,
      cantidad: updatedRecord.quantity,
      modificaciones: modificaciones, // Actualizar el conteo de modificaciones
      fecha_actualizacion: new Date().toISOString()
    };

    const { error } = await supabase
      .from('conteoinventario')
      .update(supabaseRecord)
      .eq('id', updatedRecord.id);

    if (error) throw error;
    return updatedRecord;
  } catch (error) {
    console.error('Error al actualizar el registro:', error);
    throw error;
  }
}

    async function deleteInventoryRecords(id = null) {
      try {
        if (id) {
          const { error } = await supabase
            .from('conteoinventario')
            .delete()
            .eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('conteoinventario')
            .delete()
            .neq('id', 0);
          if (error) throw error;
        }
        return { success: true };
      } catch (error) {
        console.error('Error deleting records:', error);
        throw error;
      }
    }

    // FUNCIONES DE SUPABASE PARA USUARIOS
    async function getAllUsers() {
      try {
        const { data, error } = await supabase
          .from('usuarioconteo')
          .select('*')
          .order('nombre', { ascending: true });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error getting users:', error);
        return [];
      }
    }

    async function insertUser(userData) {
      try {
        const { data, error } = await supabase
          .from('usuarioconteo')
          .insert([userData])
          .select();

        if (error) throw error;
        return data[0];
      } catch (error) {
        console.error('Error inserting user:', error);
        throw error;
      }
    }

    // FUNCIONES PARA N√öMEROS DE PARTE Y DESCRIPCI√ìN
  async function getPartDescription(partNumber) {
  try {
    const { data, error } = await supabase
      .from('numerosinventario')
      .select('descripcion')
      .eq('inventario_id', partNumber) // Cambia 'numero_parte' por 'inventario_id'
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 = No rows found
      throw error;
    }
    return data?.descripcion || '';
  } catch (error) {
    console.error('Error al buscar la descripci√≥n:', error);
    return '';
  }
}

// Funci√≥n para cargar n√∫meros de inventario desde Supabase
async function loadInventoryNumbers() {
  try {
    const { data, error } = await supabase
      .from('numerosinventario')
      .select('inventario_id, descripcion')
      .order('inventario_id', { ascending: true });
    if (error) throw error;
    const select = document.getElementById('inventory-number');
    select.innerHTML = '<option value="">Seleccione un n√∫mero de inventario</option>';
    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item.inventario_id;
      option.textContent = `${item.inventario_id} - ${item.descripcion}`;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error al cargar n√∫meros de inventario:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar los n√∫meros de inventario'
    });
  }
}



    

    async function loadPartNumbers(datalistId) {
  try {
    const { data, error } = await supabase
      .from('numerosinventario')
      .select('inventario_id, descripcion'); // Cambia 'numero_parte' por 'inventario_id'

    if (error) throw error;

    const datalist = document.getElementById(datalistId);
    datalist.innerHTML = '';

    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item.inventario_id; // Cambia 'numero_parte' por 'inventario_id'
      option.textContent = `${item.inventario_id} - ${item.descripcion}`;
      datalist.appendChild(option);
    });
  } catch (error) {
    console.error('Error al cargar n√∫meros de parte:', error);
  }
}

    // FUNCIONES DE LA UI
    function updateUI() {
      updateRackSummary();
      updateUserSummary();
      updateInventoryRecords();
      updateTotalByPartNumber(); // Agregar esta l√≠nea
    }

// ACTUALIZAR RESUMEN POR RACK (CORREGIDA Y MODIFICADA PARA INCLUIR KITEO)
function updateRackSummary() {
    console.log('--- Iniciando updateRackSummary ---');
    console.log('Longitud de inventoryData:', inventoryData ? inventoryData.length : 'inventoryData es undefined/null');
    
    // Selecciona el tbody espec√≠fico de la tabla de Resumen por Rack usando su ID
    const summaryTableBody = document.getElementById('rack-summary-body');

    // Verificaci√≥n de existencia del elemento
    if (!summaryTableBody) {
        console.warn('‚ùå No se encontr√≥ el tbody del resumen por rack (tbody#rack-summary-body).');
        console.log('--- Finalizando updateRackSummary (sin elemento) ---');
        return;
    }

    console.log('‚úÖ Elemento #rack-summary-body encontrado.');

    // Limpiar contenido existente
    summaryTableBody.innerHTML = '';
    console.log('üßπ Contenido del tbody limpiado.');

    // Verificar si inventoryData est√° disponible y no est√° vac√≠o
    if (!inventoryData || inventoryData.length === 0) {
        console.log('‚ö†Ô∏è inventoryData est√° vac√≠o o no definido. Mostrando mensaje "No hay datos".');
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos de inventario registrados a√∫n.</td>`;
        summaryTableBody.appendChild(noDataRow);
        console.log('--- Finalizando updateRackSummary (sin datos) ---');
        return;
    }

    // 1. Procesar Racks normales (A-G) y AREA_KITEO
    const racksToProcess = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'AREA_KITEO'];
    const rackSummaries = {};

    console.log('üìä Procesando racks:', racksToProcess);
    racksToProcess.forEach(rackKey => {
        // Filtrar datos de inventario por rack
        const rackItems = inventoryData.filter(item => item.rack === rackKey);
        const totalItems = rackItems.length;
        let totalQuantity = 0;
        let latestTimestamp = null;

        // Calcular totales si hay items
        if (totalItems > 0) {
            totalQuantity = rackItems.reduce((sum, item) => sum + (item.cantidad || 0), 0);
            // Encontrar la fecha m√°s reciente entre fecha_creacion y fecha_actualizacion
            try {
                latestTimestamp = rackItems.reduce((latest, item) => {
                    // Priorizar fecha_actualizacion, luego fecha_creacion
                    const itemDateStr = item.fecha_actualizacion || item.fecha_creacion || null;
                    if (!itemDateStr) return latest; // Si no hay fecha, mantener la anterior
                    const itemDate = new Date(itemDateStr);
                    const latestDate = new Date(latest);
                    // Comparar fechas v√°lidas
                    if (isNaN(itemDate.getTime()) || isNaN(latestDate.getTime())) {
                         console.warn(`Fecha inv√°lida encontrada para item ID ${item.id}:`, itemDateStr);
                         return latest; // Mantener la √∫ltima v√°lida
                    }
                    return itemDate > latestDate ? itemDateStr : latest;
                }, (rackItems[0].fecha_actualizacion || rackItems[0].fecha_creacion || null));
            } catch (dateError) {
                 console.error(`Error al procesar fechas para el rack ${rackKey}:`, dateError);
                 latestTimestamp = null; // En caso de error, no mostrar fecha
            }
        }

        // Almacenar el resumen para este rack/√°rea
        rackSummaries[rackKey] = {
            totalItems,
            totalQuantity,
            latestTimestamp
        };
        console.log(`  Rack/√Årea ${rackKey}: Items=${totalItems}, Cantidad=${totalQuantity}, √öltima=${latestTimestamp}`);
    });

    // Bandera para saber si se agreg√≥ alguna fila
    let hasDataToShow = false;

    // 2. Generar HTML para Racks normales (A-G)
    console.log('üìù Generando filas para racks normales...');
    ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(rack => {
        const summary = rackSummaries[rack];
        if (summary.totalItems > 0) { // Solo mostrar si hay datos
            hasDataToShow = true;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Rack ${rack}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${summary.totalItems}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${summary.totalQuantity}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${summary.latestTimestamp ? new Date(summary.latestTimestamp).toLocaleString() : 'N/A'}
                </td>
            `;
            summaryTableBody.appendChild(row);
            console.log(`  ‚úÖ Fila agregada para Rack ${rack}`);
        } else {
            console.log(`  ‚ûñ Sin datos para Rack ${rack}, fila omitida.`);
        }
    });

    // 3. Generar HTML para KITEO (si hay datos)
    console.log('üìù Generando fila para KITEO (√Årea)...');
    const kiteoSummary = rackSummaries['AREA_KITEO'];
    if (kiteoSummary && kiteoSummary.totalItems > 0) {
        hasDataToShow = true;
        const row = document.createElement('tr');
        // Podr√≠as usar un estilo diferente si quieres distinguirlo visualmente
        row.classList.add('bg-blue-50'); // Ejemplo de estilo opcional
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">KITEO (√Årea)</div> <!-- Nombre descriptivo -->
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${kiteoSummary.totalItems}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${kiteoSummary.totalQuantity}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${kiteoSummary.latestTimestamp ? new Date(kiteoSummary.latestTimestamp).toLocaleString() : 'N/A'}
            </td>
        `;
        summaryTableBody.appendChild(row);
        console.log('  ‚úÖ Fila agregada para KITEO (√Årea)');
    } else {
         console.log('  ‚ûñ Sin datos para KITEO (√Årea), fila omitida.');
    }

    // 4. Mensaje si no hay datos en ning√∫n lado (ya se manej√≥ arriba si inventoryData est√° vac√≠o)
    // Este bloque solo se ejecutar√≠a si inventoryData tiene datos pero ninguno coincide con los racks/√°reas procesados.
    if (hasDataToShow === false && inventoryData.length > 0) {
        console.log('‚ö†Ô∏è inventoryData tiene elementos, pero ninguno corresponde a los racks/√°reas definidos.');
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = `<td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos de inventario para los racks/√°reas definidos.</td>`;
        summaryTableBody.appendChild(noDataRow);
    }

    console.log('‚úÖ Resumen por rack actualizado.');
    console.log('--- Finalizando updateRackSummary ---');
}
// <-- Fin de la funci√≥n updateRackSummary


// Funci√≥n para calcular y mostrar el total por n√∫mero de parte
function updateTotalByPartNumber() {
  const totalByPartNumberBody = document.getElementById('total-by-part-number');
  if (!totalByPartNumberBody) return;

  if (inventoryData.length === 0) {
    totalByPartNumberBody.innerHTML = `
      <tr>
        <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros disponibles</td>
      </tr>
    `;
    return;
  }

  // Crear un objeto para agrupar por n√∫mero de parte
  const totals = {};
  inventoryData.forEach(record => {
    const partNumber = record.numero_parte;
    if (!totals[partNumber]) {
      totals[partNumber] = {
        descripcion: record.descripcion || 'Sin descripci√≥n',
        total: 0
      };
    }
    totals[partNumber].total += record.cantidad;
  });

  // Generar el HTML para la tabla
  let html = '';
  for (const partNumber in totals) {
    const { descripcion, total } = totals[partNumber];
    html += `
      <tr>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${partNumber}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm text-gray-900">${descripcion}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm text-gray-900">${total}</div>
        </td>
      </tr>
    `;
  }

  totalByPartNumberBody.innerHTML = html;
}




    

function filterInventoryRecords() {
  const userFilter = document.getElementById('filter-user').value.toLowerCase();
  const partFilter = document.getElementById('filter-part').value.toLowerCase();
  const rows = document.querySelectorAll('#inventory-records tr');

  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length === 0) return; // Saltar si no hay celdas (ej: fila de "No hay registros")

    const userCell = cells[6]?.textContent.toLowerCase() || ''; // Columna "Usuario"
    const partCell = cells[3]?.textContent.toLowerCase() || ''; // Columna "N√∫mero de Parte"

    const matchesUser = userFilter === '' || userCell.includes(userFilter);
    const matchesPart = partFilter === '' || partCell.includes(partFilter);

    if (matchesUser && matchesPart) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}



    
    function updateUserSummary() {
      const userSummary = document.getElementById('user-summary');

      let html = '';

      if (inventoryData.length === 0) {
        html = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos disponibles</td></tr>';
      } else {
        const users = [...new Set(inventoryData.map(item => item.usuario_asignado))];

        users.forEach(user => {
          const userRacks = [...new Set(inventoryData.filter(item => item.usuario_asignado === user).map(item => item.rack))];

          userRacks.forEach(rack => {
            const rackItems = inventoryData.filter(item => item.usuario_asignado === user && item.rack === rack);
            const totalItems = rackItems.length;
            const totalQuantity = rackItems.reduce((sum, item) => sum + item.cantidad, 0);

            const latestTimestamp = rackItems.reduce((latest, item) => {
              return new Date(item.fecha_creacion) > new Date(latest) ? item.fecha_creacion : latest;
            }, rackItems[0].fecha_creacion);

            html += `
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${user}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">Rack ${rack}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${totalItems}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${totalQuantity}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-500">${moment(latestTimestamp).format('DD/MM/YYYY HH:mm')}</div>
                </td>
              </tr>
            `;
          });
        });
      }

      userSummary.innerHTML = html;
    }

   function updateInventoryRecords() {
  const inventoryRecords = document.getElementById('inventory-records');
  let html = '';
  if (inventoryData.length === 0) {
    html = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros disponibles</td></tr>';
  } else {
    inventoryData.forEach(record => {
      // Determinar el texto de modificaciones
      let modificacionesText = '';
      if (record.modificaciones > 0) {
        modificacionesText = record.modificaciones === 1
          ? 'Modificado 1 vez'
          : `Modificado ${record.modificaciones} veces`;
      }
      html += `
        <tr>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-500">${moment(record.fecha_creacion).format('DD/MM/YYYY HH:mm')}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">Rack ${record.rack}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${record.ubicacion}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${record.numero_parte}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${record.descripcion || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${record.cantidad}</div>
            ${modificacionesText ? `<div class="text-xs text-gray-500">${modificacionesText}</div>` : ''}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${record.usuario_asignado}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <button onclick="editRecord(${record.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteRecord(${record.id})" class="text-red-600 hover:text-red-900 mr-3">
              <i class="fas fa-trash"></i>
            </button>
            <button onclick="reconteoRecord(${record.id})" class="text-yellow-600 hover:text-yellow-900">
              <i class="fas fa-redo"></i>
            </button>
          </td>
        </tr>
      `;
    });
  }
  inventoryRecords.innerHTML = html;
  filterInventoryRecords(); // Aplicar filtro despu√©s de actualizar
}

    function updateUserRegistry() {
      const userRegistry = document.getElementById('user-registry');

      let html = '';

      if (userData.length === 0) {
        html = `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Lupta</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">Kiteo</div>
            </td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Alan Ramos</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">Producci√≥n</div>
            </td>
          </tr>
        `;
      } else {
        userData.forEach(user => {
          html += `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${user.nombre}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${user.puesto}</div>
              </td>
            </tr>
          `;
        });
      }

      userRegistry.innerHTML = html;
    }
    
 // Funci√≥n para exportar a Excel
  function exportToExcel() {
    const tables = document.querySelectorAll('table.min-w-full.divide-y.divide-gray-200.table-hover');
    if (tables.length === 0) {
      alert('Error: No se encontraron tablas con la clase especificada.');
      return;
    }

    // Selecciona la tabla 4 (√≠ndice 4)
    const table = tables[4];

    const rows = table.querySelectorAll('tr');
    const data = [];

    // Encabezados
    data.push([
      'Fecha/Hora',
      'Rack',
      'Ubicaci√≥n',
      'N√∫mero de Parte',
      'Descripci√≥n',
      'Cantidad',
      'Usuario'
    ]);

    // Filas de datos
    rows.forEach((row, index) => {
      if (index === 0) return; // Saltar encabezados
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        data.push([
          cells[0]?.textContent.trim(), // Fecha/Hora
          cells[1]?.textContent.trim(), // Rack
          cells[2]?.textContent.trim(), // Ubicaci√≥n
          cells[3]?.textContent.trim(), // N√∫mero de Parte
          cells[4]?.textContent.trim(), // Descripci√≥n
          cells[5]?.textContent.trim(), // Cantidad
          cells[6]?.textContent.trim()  // Usuario
        ]);
      }
    });

    // Crear el archivo de Excel
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Registros de Inventario');
    XLSX.writeFile(wb, `Registros_Inventario_${moment().format('YYYYMMDD_HHmmss')}.xlsx`);
  }

    
   // Funci√≥n para exportar a PDF
  function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tables = document.querySelectorAll('table.min-w-full.divide-y.divide-gray-200.table-hover');
    if (tables.length === 0) {
      alert('Error: No se encontraron tablas con la clase especificada.');
      return;
    }

    // Selecciona la tabla 4 (√≠ndice 4)
    const table = tables[4];

    const rows = table.querySelectorAll('tr');
    const data = [];

    // Encabezados
    const headers = [
      'Fecha/Hora',
      'Rack',
      'Ubicaci√≥n',
      'N√∫mero de Parte',
      'Descripci√≥n',
      'Cantidad',
      'Usuario'
    ];

    // Filas de datos
    rows.forEach((row, index) => {
      if (index === 0) return; // Saltar encabezados
      const cells = row.querySelectorAll('td');
      if (cells.length > 0) {
        data.push([
          cells[0]?.textContent.trim(),
          cells[1]?.textContent.trim(),
          cells[2]?.textContent.trim(),
          cells[3]?.textContent.trim(),
          cells[4]?.textContent.trim(),
          cells[5]?.textContent.trim(),
          cells[6]?.textContent.trim()
        ]);
      }
    });

    // Agregar la tabla al PDF
    doc.autoTable({
      head: [headers],
      body: data,
      startY: 25,
      styles: { fontSize: 8, cellPadding: 1 },
      headStyles: { fillColor: [41, 128, 185], textColor: 255 }
    });

    // Descargar el PDF
    doc.save(`Registros_Inventario_${moment().format('YYYYMMDD_HHmmss')}.pdf`);
  };



window.reconteoRecord = async function(id) {
  const record = inventoryData.find(item => item.id === id);
  if (!record) return;

  const result = await Swal.fire({
    title: '¬øRecontar este registro?',
    text: `El registro ser√° marcado como pendiente y aparecer√° en "Asignaciones Pendientes" para que ${record.usuario_asignado} vuelva a ingresar la cantidad contada.`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'S√≠, recontar',
    cancelButtonText: 'Cancelar'
  });

  if (result.isConfirmed) {
    try {
      // Actualizar el registro en Supabase para marcarlo como pendiente
      const { error } = await supabase
        .from('conteoinventario')
        .update({
          cantidad: 0, // Reiniciar la cantidad
          cantidad_contada: false, // Marcar como pendiente
          es_asignacion: true, // Marcar como asignaci√≥n pendiente
          es_reconteo: true, // Marcar como reconteo (nuevo campo)
          fecha_actualizacion: new Date().toISOString()
        })
        .eq('id', id);

      if (error) throw error;

      // Recargar los datos
      await loadAssignments();
      await loadInventoryData();

      Swal.fire({
        icon: 'success',
        title: 'Reconteo registrado',
        text: 'El registro ha sido marcado como pendiente y aparecer√° en "Asignaciones Pendientes".',
        timer: 2000,
        showConfirmButton: false
      });
    } catch (error) {
      console.error('Error al registrar reconteo:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo registrar el reconteo'
      });
    }
  }
};





    
    // FUNCIONES GLOBALES PARA EDICI√ìN Y ELIMINACI√ìN
   window.editRecord = async function(id) {
  const record = inventoryData.find(item => item.id === id);
  if (!record) return;

  const { value: formValues } = await Swal.fire({
    title: 'Editar Registro',
    html: `
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
          <input id="edit-rack" class="swal2-input" value="${record.rack}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
          <input id="edit-location" class="swal2-input" value="${record.ubicacion}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
          <input id="edit-user" class="swal2-input" value="${record.usuario_asignado}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
          <input id="edit-part" class="swal2-input" value="${record.numero_parte}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
          <input id="edit-description" class="swal2-input" value="${record.descripcion || ''}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
          <input id="edit-quantity" type="number" class="swal2-input" value="${record.cantidad}">
        </div>
      </div>
    `,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: 'Actualizar',
    cancelButtonText: 'Cancelar',
    preConfirm: () => ({
      id: record.id,
      rack: document.getElementById('edit-rack').value,
      location: document.getElementById('edit-location').value,
      user: document.getElementById('edit-user').value,
      partNumber: document.getElementById('edit-part').value,
      description: document.getElementById('edit-description').value,
      quantity: parseInt(document.getElementById('edit-quantity').value)
    })
  });

  if (formValues) {
    try {
      await updateInventoryRecord(formValues);
      await loadInventoryData();
      Swal.fire({
        icon: 'success',
        title: 'Actualizado',
        text: 'Registro actualizado correctamente',
        timer: 2000,
        showConfirmButton: false
      });
    } catch (error) {
      console.error('Error al actualizar el registro:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo actualizar el registro'
      });
    }
  }
};

 window.deleteRecord = async function(id) {
  const result = await Swal.fire({
    title: '¬øEliminar registro?',
    text: 'Esta acci√≥n no se puede deshacer',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'S√≠, eliminar',
    cancelButtonText: 'Cancelar'
  });

  if (result.isConfirmed) {
    try {
      await deleteInventoryRecords(id);
      await loadInventoryData();
      Swal.fire({
        icon: 'success',
        title: 'Eliminado',
        text: 'Registro eliminado correctamente',
        timer: 2000,
        showConfirmButton: false
      });
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo eliminar el registro'
      });
    }
  }
};

    // FUNCIONES PRINCIPALES DE CARGA DE DATOS
    async function loadInventoryData() {
      console.log('Cargando datos de inventario...');
      inventoryData = await getAllInventoryRecords();
      updateUI();
      console.log('Datos cargados:', inventoryData.length, 'registros');
    }

    async function loadUserData() {
      console.log('Cargando datos de usuarios...');
      userData = await getAllUsers();
      updateUserRegistry();
      updateUserDataLists();
      console.log('Usuarios cargados:', userData.length, 'usuarios');
    }

   function updateUserDataLists() {
  // Obtener los elementos datalist
  const userList = document.getElementById('user-list');
  const userListInventory = document.getElementById('user-list-inventory');
  const userListInventoryNumbers = document.getElementById('user-list-inventory-numbers');

  // Limpiar opciones existentes (excepto las por defecto)
  userList.innerHTML = `
    <option value="Lupta (Kiteo)">
    <option value="Alan Ramos (Producci√≥n)">
    <option value="Carlos M√©ndez (Almac√©n)">
    <option value="Maria Gonz√°lez (Inventario)">
  `;

  userListInventory.innerHTML = `
    <option value="Lupta (Kiteo)">
    <option value="Alan Ramos (Producci√≥n)">
    <option value="Carlos M√©ndez (Almac√©n)">
    <option value="Maria Gonz√°lez (Inventario)">
  `;

  userListInventoryNumbers.innerHTML = `
    <option value="Lupta (Kiteo)">
    <option value="Alan Ramos (Producci√≥n)">
    <option value="Carlos M√©ndez (Almac√©n)">
    <option value="Maria Gonz√°lez (Inventario)">
  `;

  // Agregar usuarios de la base de datos
  userData.forEach(user => {
    const option1 = document.createElement('option');
    option1.value = `${user.nombre} (${user.puesto})`;
    userList.appendChild(option1);

    const option2 = document.createElement('option');
    option2.value = `${user.nombre} (${user.puesto})`;
    userListInventory.appendChild(option2);

    const option3 = document.createElement('option');
    option3.value = `${user.nombre} (${user.puesto})`;
    userListInventoryNumbers.appendChild(option3);
  });
}
      // FUNCI√ìN PARA CARGAS DE ASIGNACIONES
 async function loadAssignments() {
  try {
    const { data, error } = await supabase
      .from('conteoinventario')
      .select('*')
      .or('es_asignacion.eq.true,es_reconteo.eq.true') // Condici√≥n OR
      .order('fecha_actualizacion', { ascending: false });

    if (error) throw error;
    console.log('Asignaciones y reconteos:', data);
    updateAssignmentList(data);
  } catch (error) {
    console.error('Error al cargar asignaciones:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las asignaciones'
    });
  }
}





    
 function updateAssignmentList(assignments) {
  const assignmentList = document.getElementById('assignment-list');

  if (assignments && assignments.length > 0) {
    let assignmentHTML = '';

    assignments.forEach(assignment => {
      assignmentHTML += `
        <tr data-assignment-id="${assignment.id}">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">Rack ${assignment.rack}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.ubicacion}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.numero_parte}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${assignment.descripcion || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.usuario_asignado}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="number" min="1" placeholder="Cantidad" class="count-input px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <button
              onclick="registerCount(${assignment.id})"
              class="bg-navy text-white py-1 px-3 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Conteo
            </button>
          </td>
        </tr>
      `;
    });

    assignmentList.innerHTML = assignmentHTML;
  } else {
    assignmentList.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
          No hay asignaciones pendientes para reconteo
        </td>
      </tr>
    `;
  }
}



window.registerCount = async function(id) {
  const row = document.querySelector(`tr[data-assignment-id="${id}"]`);
  if (!row) return;

  const countInput = row.querySelector('.count-input');
  const quantity = parseInt(countInput.value);

  if (!quantity || quantity <= 0) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Ingresa una cantidad v√°lida mayor a cero'
    });
    return;
  }

  try {
    const button = row.querySelector('button');
    button.disabled = true;
    button.textContent = 'Procesando...';

    // Actualizar el registro en Supabase
    const { error } = await supabase
      .from('conteoinventario')
      .update({
        cantidad: quantity,
        cantidad_contada: true, // Marcar como contado
        es_asignacion: false, // Desmarcar como asignaci√≥n pendiente
        es_reconteo: false, // Desmarcar como reconteo
        fecha_actualizacion: new Date().toISOString()
      })
      .eq('id', id);

    if (error) throw error;

    // Recargar los datos
    await loadAssignments();
    await loadInventoryData();

    Swal.fire({
      icon: 'success',
      title: 'Conteo registrado',
      text: 'La cantidad ha sido registrada correctamente',
      timer: 2000,
      showConfirmButton: false
    });
  } catch (error) {
    console.error('Error al registrar conteo:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo registrar el conteo'
    });
  } finally {
    const button = row.querySelector('button');
    button.disabled = false;
    button.textContent = 'Registrar Conteo';
  }
};





















    
    window.startCountingAssignment = async function(id) {
      const row = document.querySelector(`tr[data-assignment-id="${id}"]`);
      if (!row) return;

      const rack = row.cells[0].querySelector('div').textContent.replace('Rack ', '');
      const location = row.cells[1].querySelector('div').textContent;
      const partNumber = row.cells[2].querySelector('div').textContent;
      const description = row.cells[3].querySelector('div').textContent === '-' ? '' : row.cells[3].querySelector('div').textContent;
      const user = row.cells[4].querySelector('div').textContent;
      const countInput = row.querySelector('.count-input');
      const quantity = parseInt(countInput.value);

      if (!quantity || quantity <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Por favor ingrese una cantidad v√°lida mayor a cero'
        });
        return;
      }

      const newRecord = {
        rack,
        location,
        partNumber,
        description,
        quantity,
        user
      };

      try {
        row.classList.add('bg-gray-100');
        const button = row.querySelector('button');
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Procesando...';

        await insertInventoryRecord(newRecord);
        countInput.value = '';
        await loadInventoryData();

        Swal.fire({
          icon: 'success',
          title: '√âxito',
          text: 'Conteo registrado correctamente',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error saving inventory record:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al guardar el registro de inventario'
        });
      } finally {
        row.classList.remove('bg-gray-100');
        const button = row.querySelector('button');
        button.disabled = false;
        button.textContent = 'Registrar Conteo';
      }
    };

// Manejar el env√≠o del formulario de n√∫meros de inventario
document.getElementById('inventory-numbers-form')?.addEventListener('submit', async function(e) {
  e.preventDefault();
  const submitBtn = document.getElementById('inventory-numbers-submit-btn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Procesando...';
  const formData = {
    inventario_id: document.getElementById('inventory-number').value,
    rack: document.getElementById('inventory-rack').value,
    location: document.getElementById('inventory-location').value,
    user: document.getElementById('inventory-user').value,
    quantity: parseInt(document.getElementById('inventory-quantity').value),
  };
  try {
    // Insertar en la tabla de conteo de inventario
    const { error } = await supabase
      .from('conteoinventario')
      .insert([
        {
          rack: formData.rack,
          ubicacion: formData.location,
          usuario_asignado: formData.user,
          numero_parte: formData.inventario_id,
          descripcion: document.querySelector(`#inventory-number option[value="${formData.inventario_id}"]`).textContent.split(' - ')[1],
          cantidad: formData.quantity,
          cantidad_contada: true,
          es_asignacion: false,
        }
      ]);
    if (error) throw error;
    Swal.fire({
      icon: 'success',
      title: '√âxito',
      text: 'N√∫mero de inventario registrado correctamente',
      timer: 2000,
      showConfirmButton: false
    });
    this.reset();
    await loadInventoryData();
  } catch (error) {
    console.error('Error al registrar n√∫mero de inventario:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo registrar el n√∫mero de inventario'
    });
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Registrar N√∫mero de Inventario';
  }
});



    

// Manejar cierre de sesi√≥n
document.getElementById('logout-btn')?.addEventListener('click', async function () {
    try {
        console.log('üö™ Cerrando sesi√≥n...');
        const { error } = await authSupabase.auth.signOut(); // Usar el cliente de autenticaci√≥n
        if (error) throw error;
        console.log('‚úÖ Sesi√≥n cerrada correctamente.');
        // Limpiar datos de sesi√≥n almacenados localmente si es necesario
        // sessionStorage.removeItem('currentUser'); // Si lo usaste
        // Redirigir al login
        window.location.href = 'login_completo.html';
    } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error.message);
        Swal.fire('Error', 'No se pudo cerrar la sesi√≥n.', 'error');
    }
});

    
   // INICIALIZACI√ìN DEL DOCUMENTO
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar selects de ubicaciones para ambos formularios
      function setupLocationSelects(rackSelectId, locationSelectId) {
        const rackSelect = document.getElementById(rackSelectId);
        const locationSelect = document.getElementById(locationSelectId);
        rackSelect.addEventListener('change', function() {
          locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
          const selectedRack = this.value;

          if (selectedRack === 'AREA_KITEO') {
            // Caso especial para AREA KITEO
            const ubicacionesKiteo = ['area piking', 'area kiteo'];
            ubicacionesKiteo.forEach(ubicacion => {
                const option = document.createElement('option');
                option.value = ubicacion; // O un ID √∫nico si prefieres
                option.textContent = ubicacion;
                locationSelect.appendChild(option);
            });
        } else if (selectedRack && rackLocations[selectedRack]) {
            // L√≥gica original para los racks A-G
            for (let i = 1; i <= rackLocations[selectedRack]; i++) {
                const option = document.createElement('option');
                // Formato: Rack-Ubicacion (e.g., A-1, B-12)
                option.value = `${selectedRack}-${i}`;
                option.textContent = `${selectedRack}-${i}`;
                locationSelect.appendChild(option);
            }
        }
        // Si no se selecciona nada o rack no reconocido, deja solo la opci√≥n por defecto
    });
}
      
      // Configurar ambos pares de selects
      setupLocationSelects('rack', 'location');
      setupLocationSelects('rack-assignment', 'location-assignment');
      setupLocationSelects('inventory-rack', 'inventory-location');

   // CONFIGURACI√ìN DE PESTA√ëAS
const tabAdmin = document.getElementById('tab-admin');
const tabInventory = document.getElementById('tab-inventory');
const tabView = document.getElementById('tab-view');
const tabInventoryNumbers = document.getElementById('tab-inventory-numbers'); // Nueva pesta√±a
const contentAdmin = document.getElementById('content-admin');
const contentInventory = document.getElementById('content-inventory');
const contentView = document.getElementById('content-view');
const contentInventoryNumbers = document.getElementById('content-inventory-numbers'); // Nuevo contenido



// Eventos de clic para todas las pesta√±as
tabAdmin?.addEventListener('click', function() {
    if (!document.body.classList.contains('is-admin')) {
        Swal.fire({
            icon: 'error',
            title: 'Acceso denegado',
            text: 'No tienes permiso para acceder a esta secci√≥n.',
        });
        return;
    }
    showTab(tabAdmin, contentAdmin, [tabInventory, tabView, tabInventoryNumbers], [contentInventory, contentView, contentInventoryNumbers]);
});

tabInventory?.addEventListener('click', function() {
    if (!document.body.classList.contains('is-admin')) {
        Swal.fire({
            icon: 'error',
            title: 'Acceso denegado',
            text: 'No tienes permiso para acceder a esta secci√≥n.',
        });
        return;
    }
    showTab(tabInventory, contentInventory, [tabAdmin, tabView, tabInventoryNumbers], [contentAdmin, contentView, contentInventoryNumbers]);
});

tabView?.addEventListener('click', function() {
    showTab(tabView, contentView, [tabAdmin, tabInventory, tabInventoryNumbers], [contentAdmin, contentInventory, contentInventoryNumbers]);
    loadAssignments(); // Cargar asignaciones al abrir la pesta√±a
});

tabInventoryNumbers?.addEventListener('click', function() {
    showTab(tabInventoryNumbers, contentInventoryNumbers, [tabAdmin, tabInventory, tabView], [contentAdmin, contentInventory, contentView]);
    loadInventoryNumbers(); // Cargar n√∫meros de inventario al abrir la pesta√±a
    loadUserData(); // Asegurar que los usuarios est√©n cargados
});


      // FORMULARIO DE INVENTARIO
      document.getElementById('inventory-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoader = document.getElementById('submit-loader');

        // Mostrar loading
        submitText.textContent = 'Procesando...';
        submitLoader.classList.remove('hidden');
        submitBtn.disabled = true;
        const formData = {
          rack: document.getElementById('rack').value,
          location: document.getElementById('location').value,
          user: document.getElementById('user').value,
          partNumber: document.getElementById('part-number').value,
          description: document.getElementById('description').value,
          quantity: parseInt(document.getElementById('quantity').value)
        };
        try {
          await insertInventoryRecord(formData);
          await loadInventoryData();
          this.reset();
          Swal.fire({
            icon: 'success',
            title: '√âxito',
            text: 'Conteo registrado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo guardar el registro: ' + error.message
          });
        } finally {
          submitText.textContent = 'Registrar Conteo';
          submitLoader.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });

      // FORMULARIO DE REGISTRO DE USUARIOS
      document.getElementById('user-register-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const userName = document.getElementById('new-user-name').value;
        const userArea = document.getElementById('new-user-area').value;

        if (userName && userArea) {
          try {
            const newUser = {
              nombre: userName,
              puesto: userArea
            };

            await insertUser(newUser);
            await loadUserData();
            this.reset();

            Swal.fire({
              icon: 'success',
              title: 'Usuario Registrado',
              text: 'El usuario ha sido agregado correctamente',
              timer: 2000,
              showConfirmButton: false
            });
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo registrar el usuario'
            });
          }
        }
      });

    // FORMULARIO DE ASIGNACIONES
    document.getElementById('assignment-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const user = document.getElementById('user-assignment').value.trim();
      const rack = document.getElementById('rack-assignment').value.trim();
      const location = document.getElementById('location-assignment').value.trim();
      const partNumber = document.getElementById('part-number-assignment').value.trim();
      const esAsignacion = document.querySelector('input[name="es_asignacion"]:checked').value === 'true';

      console.log('Usuario:', user);
      console.log('Rack:', rack);
      console.log('Ubicaci√≥n:', location);
      console.log('N√∫mero de parte:', partNumber);
      console.log('¬øEs asignaci√≥n pendiente?:', esAsignacion);

      if (!user || !rack || !location || !partNumber) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Todos los campos son obligatorios'
        });
        return;
      }

      const description = await getPartDescription(partNumber);
      console.log('Descripci√≥n:', description);

      try {
        const { error } = await supabase
          .from('conteoinventario')
          .insert([
            {
              rack: rack,
              ubicacion: location,
              usuario_asignado: user,
              numero_parte: partNumber,
              descripcion: description,
              cantidad: 0,
              cantidad_contada: false,
              es_asignacion: true
            }
          ]);

        if (error) throw error;

        Swal.fire({
          icon: 'success',
          title: 'Asignaci√≥n registrada',
          text: `Se asign√≥ a ${user} para contar el rack ${rack}, ubicaci√≥n ${location}, parte ${partNumber}`,
          confirmButtonColor: '#0a192f'
        });

        await loadAssignments();
        this.reset();
      } catch (error) {
        console.error('Error al registrar asignaci√≥n:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'No se pudo registrar la asignaci√≥n'
        });
      }
    });

      // CARGAR DATOS INICIALES
      loadInventoryData();
      loadUserData();

      // CARGAR N√öMEROS DE PARTE PARA AUTOCOMPLETAR
      loadPartNumbers('part-number-list');
      loadPartNumbers('part-number-list-assignment');

      // AUTOCOMPLETAR DESCRIPCI√ìN AL SELECCIONAR N√öMERO DE PARTE
      document.getElementById('part-number').addEventListener('blur', async function() {
        const partNumber = this.value.trim();
        if (partNumber) {
          const description = await getPartDescription(partNumber);
          if (!description) {
            Swal.fire({
              icon: 'warning',
              title: 'N√∫mero de parte no encontrado',
              text: 'El n√∫mero de parte ingresado no existe en la base de datos.',
            });
            document.getElementById('description').value = '';
          } else {
            document.getElementById('description').value = description;
          }
        }
      });

      // Event Listeners para filtros
      document.getElementById('filter-user').addEventListener('input', filterInventoryRecords);
      document.getElementById('filter-part').addEventListener('input', filterInventoryRecords);
      document.getElementById('clear-filters-btn').addEventListener('click', function() {
        document.getElementById('filter-user').value = '';
        document.getElementById('filter-part').value = '';
        filterInventoryRecords();
      });

      // Event Listeners para exportar
      document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
      document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);

      // Event Listeners para autocompletar
      document.getElementById('part-number-assignment').addEventListener('blur', async function() {
        const partNumber = this.value.trim();
        if (partNumber) {
          const description = await getPartDescription(partNumber);
          if (!description) {
            Swal.fire({
              icon: 'warning',
              title: 'N√∫mero de parte no encontrado',
              text: 'El n√∫mero de parte ingresado no existe en la base de datos.',
            });
            document.getElementById('description').value = '';
          }
        }
      });
    }); // <-- CERRAR EL EVENT LISTENER DOMContentLoaded PRINCIPAL
 </script>
</body>
</html>
