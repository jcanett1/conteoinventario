<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conteo de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .bg-navy {
      background-color: #0a192f;
    }
    .text-navy {
      color: #0a192f;
    }
    .border-navy {
      border-color: #0a192f;
    }
    .hover-bg-navy:hover {
      background-color: #0a192f;
      color: white;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-hover tr:hover {
      background-color: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .loader {
      border-top-color: #0a192f;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-navy shadow-md">
    <div class="container mx-auto px-4 py-5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-warehouse text-white text-3xl mr-3"></i>
          <h1 class="text-2xl font-bold text-white">Sistema de Conteo de Inventario</h1>
        </div>
        <div>
          <button id="reset-data-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
            <i class="fas fa-trash-alt mr-2"></i>Reiniciar Datos
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
      <!-- Left Column - Form -->
      <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro Manual de Inventario</h2>
        
        <form id="inventory-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Rack Selection -->
            <div>
              <label for="rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
              <select id="rack" name="rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione un Rack</option>
                <option value="A">Rack A</option>
                <option value="B">Rack B</option>
                <option value="C">Rack C</option>
                <option value="D">Rack D</option>
                <option value="E">Rack E</option>
                <option value="F">Rack F</option>
                <option value="G">Rack G</option>
              </select>
            </div>
            
            <!-- Location Selection -->
            <div>
              <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
              <select id="location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione ubicación</option>
              </select>
            </div>
          </div>
          
          <!-- User Assignment -->
          <div>
            <label for="user" class="block text-sm font-medium text-gray-700 mb-1">Usuario Asignado</label>
            <input type="text" id="user" name="user" list="user-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
            <datalist id="user-list">
              <option value="Lupta (Kiteo)">
              <option value="Alan Ramos (Producción)">
              <option value="Carlos Méndez (Almacén)">
              <option value="Maria González (Inventario)">
            </datalist>
          </div>
          
          <!-- Part Information -->
          <div>
            <label for="part-number" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
            <input type="text" id="part-number" name="part-number" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese número de parte">
          </div>
          
          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
            <input type="text" id="description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese descripción del producto">
          </div>
          
          <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
            <input type="number" id="quantity" name="quantity" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad contada">
          </div>
          
          <!-- Submit Button -->
          <div class="pt-2">
            <button type="submit" id="submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all flex items-center justify-center">
              <span id="submit-text">Registrar Conteo</span>
              <span id="submit-loader" class="hidden ml-2">
                <div class="loader h-5 w-5 rounded-full border-2 border-white border-t-4"></div>
              </span>
            </button>
          </div>
        </form>
      </div>
      
      <!-- Right Column - Bulk Import -->
      <div class="md:col-span-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Importación por Archivo</h2>
          
          <div class="space-y-4">
            <p class="text-gray-600">Importe datos masivos desde un archivo CSV o Excel.</p>
            
            <div class="flex items-center justify-center w-full">
              <label for="file-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                  <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click para seleccionar</span> o arrastre un archivo</p>
                  <p class="text-xs text-gray-500">CSV o Excel (máx. 10MB)</p>
                </div>
                <input id="file-upload" type="file" class="hidden" accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
              </label>
            </div>
            
            <div id="file-info" class="hidden">
              <div class="flex items-center justify-between bg-blue-50 p-3 rounded-md">
                <div class="flex items-center">
                  <i class="fas fa-file-excel text-blue-500 mr-2"></i>
                  <span id="file-name" class="text-sm font-medium"></span>
                </div>
                <button id="remove-file" class="text-red-500 hover:text-red-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              
              <button id="process-file" class="mt-3 w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-all flex items-center justify-center">
                <i class="fas fa-upload mr-2"></i>
                <span>Procesar Archivo</span>
              </button>
            </div>
            
            <div id="import-progress" class="hidden">
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p id="progress-text" class="text-sm text-gray-600 mt-2 text-center">Procesando...</p>
            </div>
          </div>
        </div>
        
        <!-- Dashboard - Summary by Rack -->
        <div class="bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Resumen por Rack</h2>
          
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Ítems</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                </tr>
              </thead>
              <tbody id="rack-summary" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- User Assignment Summary -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
      <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Conteo por Usuario</h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ítems Contados</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Conteo</th>
            </tr>
          </thead>
          <tbody id="user-summary" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Inventory Records -->
    <div class="bg-white rounded-lg shadow-md p-6 mt-6">
      <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registros de Inventario</h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número de Parte</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody id="inventory-records" class="bg-white divide-y divide-gray-200">
            <tr>
              <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Cargando registros...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-navy text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Sistema de Conteo de Inventario | Todos los derechos reservados</p>
    </div>
  </footer>

  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
  // CONFIGURACIÓN
  const SUPABASE_URL = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';

  // Inicializar Supabase
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Variables globales
  let inventoryData = [];
  const rackLocations = {
    'A': 48, 'B': 48, 'C': 48, 'D': 42, 'E': 42, 'F': 21, 'G': 32
  };

  // FUNCIONES DE SUPABASE
  async function getAllInventoryRecords() {
    try {
      console.log('Obteniendo registros de Supabase...');
      const { data, error } = await supabase
        .from('conteoinventario')
        .select('*')
        .order('fecha_creacion', { ascending: false });
      
      if (error) {
        console.error('Error de Supabase:', error);
        throw error;
      }
      console.log('Registros obtenidos:', data?.length || 0);
      return data || [];
    } catch (error) {
      console.error('Error getting records:', error);
      Swal.fire('Error', 'No se pudieron cargar los datos de la base de datos', 'error');
      return [];
    }
  }

  async function insertInventoryRecord(record) {
    try {
      const supabaseRecord = {
        rack: record.rack,
        ubicacion: record.location,
        usuario_asignado: record.user,
        numero_parte: record.partNumber,
        descripcion: record.description,
        cantidad: record.quantity
      };
      
      console.log('Insertando registro:', supabaseRecord);
      const { data, error } = await supabase
        .from('conteoinventario')
        .insert([supabaseRecord])
        .select();
      
      if (error) throw error;
      
      console.log('Registro insertado:', data[0]);
      return { 
        id: data[0].id, 
        ...record,
        fecha_creacion: data[0].fecha_creacion
      };
    } catch (error) {
      console.error('Error inserting record:', error);
      throw error;
    }
  }

  async function updateInventoryRecord(updatedRecord) {
    try {
      const supabaseRecord = {
        rack: updatedRecord.rack,
        ubicacion: updatedRecord.location,
        usuario_asignado: updatedRecord.user,
        numero_parte: updatedRecord.partNumber,
        descripcion: updatedRecord.description,
        cantidad: updatedRecord.quantity,
        fecha_actualizacion: new Date().toISOString()
      };
      
      const { error } = await supabase
        .from('conteoinventario')
        .update(supabaseRecord)
        .eq('id', updatedRecord.id);
      
      if (error) throw error;
      return updatedRecord;
    } catch (error) {
      console.error('Error updating record:', error);
      throw error;
    }
  }

  async function deleteInventoryRecords(id = null) {
    try {
      if (id) {
        const { error } = await supabase
          .from('conteoinventario')
          .delete()
          .eq('id', id);
        if (error) throw error;
      } else {
        const { error } = await supabase
          .from('conteoinventario')
          .delete()
          .neq('id', 0);
        if (error) throw error;
      }
      return { success: true };
    } catch (error) {
      console.error('Error deleting records:', error);
      throw error;
    }
  }

  // FUNCIONES DE LA UI
  function updateUI() {
    updateRackSummary();
    updateUserSummary();
    updateInventoryRecords();
  }

  function updateRackSummary() {
    const rackSummary = document.getElementById('rack-summary');
    const racks = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    
    let html = '';
    
    if (inventoryData.length === 0) {
      html = '<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos disponibles</td></tr>';
    } else {
      racks.forEach(rack => {
        const rackItems = inventoryData.filter(item => item.rack === rack);
        const totalItems = rackItems.length;
        const totalQuantity = rackItems.reduce((sum, item) => sum + item.cantidad, 0);
        
        html += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Rack ${rack}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${totalItems}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${totalQuantity}</div>
            </td>
          </tr>
        `;
      });
    }
    
    rackSummary.innerHTML = html;
  }

  function updateUserSummary() {
    const userSummary = document.getElementById('user-summary');
    
    let html = '';
    
    if (inventoryData.length === 0) {
      html = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos disponibles</td></tr>';
    } else {
      const users = [...new Set(inventoryData.map(item => item.usuario_asignado))];
      
      users.forEach(user => {
        const userItems = inventoryData.filter(item => item.usuario_asignado === user);
        const totalItems = userItems.length;
        const totalQuantity = userItems.reduce((sum, item) => sum + item.cantidad, 0);
        const latestTimestamp = userItems.reduce((latest, item) => 
          new Date(item.fecha_creacion) > new Date(latest) ? item.fecha_creacion : latest, 
        userItems[0].fecha_creacion);
        
        html += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${user}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">Varios</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${totalItems}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${totalQuantity}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${moment(latestTimestamp).format('DD/MM/YYYY HH:mm')}</div>
            </td>
          </tr>
        `;
      });
    }
    
    userSummary.innerHTML = html;
  }

  function updateInventoryRecords() {
    const inventoryRecords = document.getElementById('inventory-records');
    
    let html = '';
    
    if (inventoryData.length === 0) {
      html = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros disponibles</td></tr>';
    } else {
      inventoryData.forEach(record => {
        html += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${moment(record.fecha_creacion).format('DD/MM/YYYY HH:mm')}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Rack ${record.rack}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${record.ubicacion}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${record.numero_parte}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-900">${record.descripcion}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${record.cantidad}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${record.usuario_asignado}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button onclick="editRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteRecord('${record.id}')" class="text-red-600 hover:text-red-900">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }
    
    inventoryRecords.innerHTML = html;
  }

  // FUNCIONES GLOBALES
  window.editRecord = async function(id) {
    const record = inventoryData.find(item => item.id === id);
    if (!record) return;

    const { value: formValues } = await Swal.fire({
      title: 'Editar Registro',
      html: `
        <input id="edit-rack" class="swal2-input" placeholder="Rack" value="${record.rack}">
        <input id="edit-location" class="swal2-input" placeholder="Ubicación" value="${record.ubicacion}">
        <input id="edit-user" class="swal2-input" placeholder="Usuario" value="${record.usuario_asignado}">
        <input id="edit-part" class="swal2-input" placeholder="Número de Parte" value="${record.numero_parte}">
        <input id="edit-description" class="swal2-input" placeholder="Descripción" value="${record.descripcion}">
        <input id="edit-quantity" type="number" class="swal2-input" placeholder="Cantidad" value="${record.cantidad}">
      `,
      focusConfirm: false,
      showCancelButton: true,
      preConfirm: () => ({
        id: record.id,
        rack: document.getElementById('edit-rack').value,
        location: document.getElementById('edit-location').value,
        user: document.getElementById('edit-user').value,
        partNumber: document.getElementById('edit-part').value,
        description: document.getElementById('edit-description').value,
        quantity: parseInt(document.getElementById('edit-quantity').value)
      })
    });

    if (formValues) {
      try {
        await updateInventoryRecord(formValues);
        await loadInventoryData();
        Swal.fire('Éxito', 'Registro actualizado', 'success');
      } catch (error) {
        Swal.fire('Error', 'No se pudo actualizar', 'error');
      }
    }
  };

  window.deleteRecord = async function(id) {
    const result = await Swal.fire({
      title: '¿Eliminar registro?',
      text: 'Esta acción no se puede deshacer',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sí, eliminar',
      cancelButtonText: 'Cancelar'
    });

    if (result.isConfirmed) {
      try {
        await deleteInventoryRecords(id);
        await loadInventoryData();
        Swal.fire('Eliminado', 'Registro eliminado', 'success');
      } catch (error) {
        Swal.fire('Error', 'No se pudo eliminar', 'error');
      }
    }
  };

  // INICIALIZACIÓN
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar select de ubicaciones
    const rackSelect = document.getElementById('rack');
    const locationSelect = document.getElementById('location');

    rackSelect.addEventListener('change', function() {
      locationSelect.innerHTML = '<option value="">Seleccione ubicación</option>';
      const selectedRack = this.value;
      
      if (selectedRack && rackLocations[selectedRack]) {
        for (let i = 1; i <= rackLocations[selectedRack]; i++) {
          const option = document.createElement('option');
          option.value = `${selectedRack}-${i}`;
          option.textContent = `${selectedRack}-${i}`;
          locationSelect.appendChild(option);
        }
      }
    });

    // Submit del formulario
    document.getElementById('inventory-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submit-btn');
      const submitText = document.getElementById('submit-text');
      const submitLoader = document.getElementById('submit-loader');
      
      // Mostrar loading
      submitText.textContent = 'Procesando...';
      submitLoader.classList.remove('hidden');
      submitBtn.disabled = true;

      const formData = {
        rack: document.getElementById('rack').value,
        location: document.getElementById('location').value,
        user: document.getElementById('user').value,
        partNumber: document.getElementById('part-number').value,
        description: document.getElementById('description').value,
        quantity: parseInt(document.getElementById('quantity').value)
      };

      try {
        await insertInventoryRecord(formData);
        await loadInventoryData();
        this.reset();
        Swal.fire('Éxito', 'Registro guardado en Supabase', 'success');
      } catch (error) {
        Swal.fire('Error', 'No se pudo guardar el registro: ' + error.message, 'error');
      } finally {
        // Ocultar loading
        submitText.textContent = 'Registrar Conteo';
        submitLoader.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // Botón de reinicio
    document.getElementById('reset-data-btn').addEventListener('click', function() {
      Swal.fire({
        title: '¿Está seguro?',
        text: 'Esta acción eliminará TODOS los registros de la base de datos',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar todo',
        cancelButtonText: 'Cancelar'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await deleteInventoryRecords();
            await loadInventoryData();
            Swal.fire('Eliminado', 'Todos los registros han sido eliminados', 'success');
          } catch (error) {
            Swal.fire('Error', 'No se pudieron eliminar los registros', 'error');
          }
        }
      });
    });

    // Cargar datos iniciales
    loadInventoryData();
  });

  // Función principal para cargar datos
  async function loadInventoryData() {
    console.log('Cargando datos de inventario...');
    inventoryData = await getAllInventoryRecords();
    updateUI();
    console.log('Datos cargados:', inventoryData.length, 'registros');
  }
  </script>
</body>
</html>
