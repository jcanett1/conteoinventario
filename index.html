<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conteo de Inventario</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style id="app-style">
    .bg-navy {
      background-color: #0a192f;
    }
    .text-navy {
      color: #0a192f;
    }
    .border-navy {
      border-color: #0a192f;
    }
    .hover-bg-navy:hover {
      background-color: #0a192f;
      color: white;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-hover tr:hover {
      background-color: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .loader {
      border-top-color: #0a192f;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-navy shadow-md">
    <div class="container mx-auto px-4 py-5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-warehouse text-white text-3xl mr-3"></i>
          <h1 class="text-2xl font-bold text-white">Sistema de Conteo de Inventario</h1>
        </div>
        <div>
          <button id="reset-data-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
            <i class="fas fa-trash-alt mr-2"></i>Reiniciar Datos
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- Add tab navigation -->
  <div class="container mx-auto px-4 mt-4">
    <div class="flex border-b border-gray-200">
      <button id="tab-admin" class="px-4 py-2 text-navy font-medium border-b-2 border-navy">
        Administración
      </button>
      <button id="tab-inventory" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
        Conteo de Inventario
      </button>
      <button id="tab-view" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
        Vista de Asignaciones
      </button>
    </div>
  </div>
  <!-- Main Content with two tab containers -->
  <main class="container mx-auto px-4 py-6">
    <!-- Tab 1: Administración -->
    <div id="content-admin" class="block">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Left Column - User Assignment Form -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignación de Usuario para Conteo</h2>

          <form id="assignment-form" class="space-y-4">
            <div>
              <label for="user-assignment" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input type="text" id="user-assignment" name="user-assignment" list="user-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
               <datalist id="user-list"> </datalist>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack-assignment" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack-assignment" name="rack-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location-assignment" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                <select id="location-assignment" name="location-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicación</option>
                </select>
              </div>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number-assignment" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
              <input type="text" id="part-number-assignment" name="part-number-assignment" list="part-number-list-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese número de parte">
              <datalist id="part-number-list-assignment">
                <!-- Se llenará con JavaScript -->
              </datalist>
            </div>

            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="assignment-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
                Asignar Usuario
              </button>
            </div>
          </form>
        </div>

        <!-- Right Column - User Registration -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de Usuarios para Conteo</h2>

          <form id="user-register-form" class="mb-6 flex items-end space-x-2">
            <div class="flex-1">
              <label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
              <input type="text" id="new-user-name" name="new-user-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre del usuario">
            </div>
            <div class="flex-1">
              <label for="new-user-area" class="block text-sm font-medium text-gray-700 mb-1">Área</label>
              <input type="text" id="new-user-area" name="new-user-area" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Área o puesto">
            </div>
            <button type="submit" class="bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Usuario
            </button>
          </form>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-hover">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Área</th>
                </tr>
              </thead>
              <tbody id="user-registry" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Lupta</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Kiteo</div>
                  </td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Alan Ramos</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Producción</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Conteo de Inventario -->
    <div id="content-inventory" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Form Column -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro Manual de Inventario</h2>

          <form id="inventory-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack" name="rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                <select id="location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicación</option>
                </select>
              </div>
            </div>

            <!-- User Assignment -->
            <div>
              <label for="user" class="block text-sm font-medium text-gray-700 mb-1">Usuario Asignado</label>
              <input type="text" id="user" name="user" list="user-list-inventory" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
              <datalist id="user-list-inventory">
                <option value="Lupta (Kiteo)">
                <option value="Alan Ramos (Producción)">
                <option value="Carlos Méndez (Almacén)">
                <option value="Maria González (Inventario)">
              </datalist>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
              <input type="text" id="part-number" name="part-number" list="part-number-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese número de parte">
              <datalist id="part-number-list">
                <!-- Se llenará con JavaScript -->
              </datalist>
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
              <input type="text" id="description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese descripción del producto">
            </div>

            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input type="number" id="quantity" name="quantity" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad contada">
            </div>

            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all flex items-center justify-center">
                <span id="submit-text">Registrar Conteo</span>
                <span id="submit-loader" class="hidden ml-2">
                  <div class="loader h-5 w-5 rounded-full border-2 border-white border-t-4"></div>
                </span>
              </button>
            </div>
          </form>
        </div>

        <!-- Summary Column -->
        <div class="md:col-span-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Resumen por Rack</h2>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-hover">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Ítems</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                  </tr>
                </thead>
                <tbody id="rack-summary" class="bg-white divide-y divide-gray-200">
                  <!-- Rack summary data will be inserted here via JavaScript -->
                  <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- User Assignment Summary -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Conteo por Usuario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ítems Contados</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Conteo</th>
              </tr>
            </thead>
            <tbody id="user-summary" class="bg-white divide-y divide-gray-200">
              <!-- User summary data will be inserted here via JavaScript -->
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Inventory Records -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registros de Inventario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="inventory-records" class="bg-white divide-y divide-gray-200">
              <!-- Inventory records will be inserted here via JavaScript -->
              <tr>
                <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Cargando registros...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Tab 3: Vista de Asignaciones -->
    <div id="content-view" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignaciones Pendientes</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario Asignado</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Contada</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th>
              </tr>
            </thead>
            <tbody id="assignment-list" class="bg-white divide-y divide-gray-200">
              <!-- Assignment data will be inserted here -->
              <tr>
                <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                  No hay asignaciones disponibles
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
  <!-- Footer -->
  <footer class="bg-navy text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Sistema de Conteo de Inventario | Todos los derechos reservados</p>
    </div>
  </footer>
  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script id="app-script">
    // CONFIGURACIÓN SUPABASE
    const SUPABASE_URL = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // Variables globales
    let inventoryData = [];
    let userData = [];
    const rackLocations = {
      'A': 48, 'B': 48, 'C': 48, 'D': 42, 'E': 42, 'F': 21, 'G': 32
    };

    // FUNCIONES DE SUPABASE PARA INVENTARIO
    async function getAllInventoryRecords() {
      try {
        console.log('Obteniendo registros de Supabase...');
        const { data, error } = await supabase
          .from('conteoinventario')
          .select('*')
          .order('fecha_creacion', { ascending: false });

        if (error) {
          console.error('Error de Supabase:', error);
          throw error;
        }
        console.log('Registros obtenidos:', data?.length || 0);
        return data || [];
      } catch (error) {
        console.error('Error getting records:', error);
        Swal.fire('Error', 'No se pudieron cargar los datos de la base de datos', 'error');
        return [];
      }
    }

    async function insertInventoryRecord(record) {
      try {
        const supabaseRecord = {
          rack: record.rack,
          ubicacion: record.location,
          usuario_asignado: record.user,
          numero_parte: record.partNumber,
          descripcion: record.description,
          cantidad: record.quantity
        };

        console.log('Insertando registro:', supabaseRecord);
        const { data, error } = await supabase
          .from('conteoinventario')
          .insert([supabaseRecord])
          .select();

        if (error) throw error;

        console.log('Registro insertado:', data[0]);
        return {
          id: data[0].id,
          ...record,
          fecha_creacion: data[0].fecha_creacion
        };
      } catch (error) {
        console.error('Error inserting record:', error);
        throw error;
      }
    }

    async function updateInventoryRecord(updatedRecord) {
      try {
        const supabaseRecord = {
          rack: updatedRecord.rack,
          ubicacion: updatedRecord.location,
          usuario_asignado: updatedRecord.user,
          numero_parte: updatedRecord.partNumber,
          descripcion: updatedRecord.description,
          cantidad: updatedRecord.quantity,
          fecha_actualizacion: new Date().toISOString()
        };

        const { error } = await supabase
          .from('conteoinventario')
          .update(supabaseRecord)
          .eq('id', updatedRecord.id);

        if (error) throw error;
        return updatedRecord;
      } catch (error) {
        console.error('Error updating record:', error);
        throw error;
      }
    }

    async function deleteInventoryRecords(id = null) {
      try {
        if (id) {
          const { error } = await supabase
            .from('conteoinventario')
            .delete()
            .eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('conteoinventario')
            .delete()
            .neq('id', 0);
          if (error) throw error;
        }
        return { success: true };
      } catch (error) {
        console.error('Error deleting records:', error);
        throw error;
      }
    }

    // FUNCIONES DE SUPABASE PARA USUARIOS
    async function getAllUsers() {
      try {
        const { data, error } = await supabase
          .from('usuarioconteo')
          .select('*')
          .order('nombre', { ascending: true });

        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Error getting users:', error);
        return [];
      }
    }

    async function insertUser(userData) {
      try {
        const { data, error } = await supabase
          .from('usuarioconteo')
          .insert([userData])
          .select();

        if (error) throw error;
        return data[0];
      } catch (error) {
        console.error('Error inserting user:', error);
        throw error;
      }
    }

    // FUNCIONES PARA NÚMEROS DE PARTE Y DESCRIPCIÓN
  async function getPartDescription(partNumber) {
  try {
    const { data, error } = await supabase
      .from('numerosinventario')
      .select('descripcion')
      .eq('inventario_id', partNumber) // Cambia 'numero_parte' por 'inventario_id'
      .single();

    if (error && error.code !== 'PGRST116') { // PGRST116 = No rows found
      throw error;
    }
    return data?.descripcion || '';
  } catch (error) {
    console.error('Error al buscar la descripción:', error);
    return '';
  }
}

    async function loadPartNumbers(datalistId) {
  try {
    const { data, error } = await supabase
      .from('numerosinventario')
      .select('inventario_id, descripcion'); // Cambia 'numero_parte' por 'inventario_id'

    if (error) throw error;

    const datalist = document.getElementById(datalistId);
    datalist.innerHTML = '';

    data.forEach(item => {
      const option = document.createElement('option');
      option.value = item.inventario_id; // Cambia 'numero_parte' por 'inventario_id'
      option.textContent = `${item.inventario_id} - ${item.descripcion}`;
      datalist.appendChild(option);
    });
  } catch (error) {
    console.error('Error al cargar números de parte:', error);
  }
}

    // FUNCIONES DE LA UI
    function updateUI() {
      updateRackSummary();
      updateUserSummary();
      updateInventoryRecords();
    }

    function updateRackSummary() {
      const rackSummary = document.getElementById('rack-summary');
      const racks = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];

      let html = '';

      if (inventoryData.length === 0) {
        html = '<tr><td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos disponibles</td></tr>';
      } else {
        racks.forEach(rack => {
          const rackItems = inventoryData.filter(item => item.rack === rack);
          const totalItems = rackItems.length;
          const totalQuantity = rackItems.reduce((sum, item) => sum + item.cantidad, 0);

          html += `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">Rack ${rack}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${totalItems}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${totalQuantity}</div>
              </td>
            </tr>
          `;
        });
      }

      rackSummary.innerHTML = html;
    }

    function updateUserSummary() {
      const userSummary = document.getElementById('user-summary');

      let html = '';

      if (inventoryData.length === 0) {
        html = '<tr><td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos disponibles</td></tr>';
      } else {
        const users = [...new Set(inventoryData.map(item => item.usuario_asignado))];

        users.forEach(user => {
          const userRacks = [...new Set(inventoryData.filter(item => item.usuario_asignado === user).map(item => item.rack))];

          userRacks.forEach(rack => {
            const rackItems = inventoryData.filter(item => item.usuario_asignado === user && item.rack === rack);
            const totalItems = rackItems.length;
            const totalQuantity = rackItems.reduce((sum, item) => sum + item.cantidad, 0);

            const latestTimestamp = rackItems.reduce((latest, item) => {
              return new Date(item.fecha_creacion) > new Date(latest) ? item.fecha_creacion : latest;
            }, rackItems[0].fecha_creacion);

            html += `
              <tr>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${user}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">Rack ${rack}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${totalItems}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">${totalQuantity}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-500">${moment(latestTimestamp).format('DD/MM/YYYY HH:mm')}</div>
                </td>
              </tr>
            `;
          });
        });
      }

      userSummary.innerHTML = html;
    }

    function updateInventoryRecords() {
      const inventoryRecords = document.getElementById('inventory-records');

      let html = '';

      if (inventoryData.length === 0) {
        html = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros disponibles</td></tr>';
      } else {
        inventoryData.forEach(record => {
          html += `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-500">${moment(record.fecha_creacion).format('DD/MM/YYYY HH:mm')}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">Rack ${record.rack}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${record.ubicacion}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${record.numero_parte}</div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900">${record.descripcion}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${record.cantidad}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${record.usuario_asignado}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="editRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteRecord('${record.id}')" class="text-red-600 hover:text-red-900">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }

      inventoryRecords.innerHTML = html;
    }

    function updateUserRegistry() {
      const userRegistry = document.getElementById('user-registry');

      let html = '';

      if (userData.length === 0) {
        html = `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Lupta</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">Kiteo</div>
            </td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">Alan Ramos</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">Producción</div>
            </td>
          </tr>
        `;
      } else {
        userData.forEach(user => {
          html += `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${user.nombre}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${user.puesto}</div>
              </td>
            </tr>
          `;
        });
      }

      userRegistry.innerHTML = html;
    }

    // FUNCIONES GLOBALES PARA EDICIÓN Y ELIMINACIÓN
    window.editRecord = async function(id) {
      const record = inventoryData.find(item => item.id === id);
      if (!record) return;
      const { value: formValues } = await Swal.fire({
        title: 'Editar Registro',
        html: `
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
              <input id="edit-rack" class="swal2-input" value="${record.rack}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
              <input id="edit-location" class="swal2-input" value="${record.ubicacion}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input id="edit-user" class="swal2-input" value="${record.usuario_asignado}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
              <input id="edit-part" class="swal2-input" value="${record.numero_parte}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
              <input id="edit-description" class="swal2-input" value="${record.descripcion}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input id="edit-quantity" type="number" class="swal2-input" value="${record.cantidad}">
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Actualizar',
        cancelButtonText: 'Cancelar',
        preConfirm: () => ({
          id: record.id,
          rack: document.getElementById('edit-rack').value,
          location: document.getElementById('edit-location').value,
          user: document.getElementById('edit-user').value,
          partNumber: document.getElementById('edit-part').value,
          description: document.getElementById('edit-description').value,
          quantity: parseInt(document.getElementById('edit-quantity').value)
        })
      });
      if (formValues) {
        try {
          await updateInventoryRecord(formValues);
          await loadInventoryData();
          Swal.fire({
            icon: 'success',
            title: 'Actualizado',
            text: 'Registro actualizado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo actualizar el registro'
          });
        }
      }
    };

    window.deleteRecord = async function(id) {
      const result = await Swal.fire({
        title: '¿Eliminar registro?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
      });
      if (result.isConfirmed) {
        try {
          await deleteInventoryRecords(id);
          await loadInventoryData();
          Swal.fire({
            icon: 'success',
            title: 'Eliminado',
            text: 'Registro eliminado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo eliminar el registro'
          });
        }
      }
    };

    // FUNCIONES PRINCIPALES DE CARGA DE DATOS
    async function loadInventoryData() {
      console.log('Cargando datos de inventario...');
      inventoryData = await getAllInventoryRecords();
      updateUI();
      console.log('Datos cargados:', inventoryData.length, 'registros');
    }

    async function loadUserData() {
      console.log('Cargando datos de usuarios...');
      userData = await getAllUsers();
      updateUserRegistry();
      updateUserDataLists();
      console.log('Usuarios cargados:', userData.length, 'usuarios');
    }

    function updateUserDataLists() {
      // Actualizar ambas listas de usuarios
      const userList = document.getElementById('user-list');
      const userListInventory = document.getElementById('user-list-inventory');

      // Limpiar opciones existentes (excepto las por defecto)
      userList.innerHTML = `
        <option value="Lupta (Kiteo)">
        <option value="Alan Ramos (Producción)">
        <option value="Carlos Méndez (Almacén)">
        <option value="Maria González (Inventario)">
      `;

      userListInventory.innerHTML = `
        <option value="Lupta (Kiteo)">
        <option value="Alan Ramos (Producción)">
        <option value="Carlos Méndez (Almacén)">
        <option value="Maria González (Inventario)">
      `;

      // Agregar usuarios de la base de datos
      userData.forEach(user => {
        const option1 = document.createElement('option');
        option1.value = `${user.nombre} (${user.puesto})`;
        userList.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = `${user.nombre} (${user.puesto})`;
        userListInventory.appendChild(option2);
      });
    }

    // FUNCIÓN PARA CARGAS DE ASIGNACIONES
  // FUNCIÓN PARA CARGAS DE ASIGNACIONES
  async function loadAssignments() {
  try {
    const { data, error } = await supabase
      .from('conteoinventario')
      .select('*')
      .eq('cantidad', 0) // Solo asignaciones pendientes (cantidad = 0)
      .eq('es_asignacion', true) // Solo las que son asignaciones, no registros manuales
      .order('fecha_creacion', { ascending: false });

    if (error) throw error;

    console.log('Asignaciones cargadas:', data); // Para debug
    updateAssignmentList(data); // Muestra los datos en la tabla
  } catch (error) {
    console.error('Error al cargar asignaciones:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudieron cargar las asignaciones'
    });
  }
}

 function updateAssignmentList(assignments) {
  const assignmentList = document.getElementById('assignment-list');

  if (assignments && assignments.length > 0) {
    let assignmentHTML = '';

    assignments.forEach(assignment => {
      assignmentHTML += `
        <tr data-assignment-id="${assignment.id}">
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${assignment.rack}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.ubicacion}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.numero_parte}</div>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm text-gray-900">${assignment.descripcion || '-'}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">${assignment.usuario_asignado}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <input type="number" min="1" placeholder="Cantidad" class="count-input px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <button
              onclick="registerCount('${assignment.id}')"
              class="bg-navy text-white py-1 px-3 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Conteo
            </button>
          </td>
        </tr>
      `;
    });

    assignmentList.innerHTML = assignmentHTML;
  } else {
    assignmentList.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
          No hay asignaciones pendientes
        </td>
      </tr>
    `;
  }
}



window.registerCount = async function(assignmentId) {
  const row = document.querySelector(`tr[data-assignment-id="${assignmentId}"]`);
  if (!row) return;

  const countInput = row.querySelector('.count-input');
  const quantity = parseInt(countInput.value);

  if (!quantity || quantity <= 0) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Ingresa una cantidad válida mayor a cero'
    });
    return;
  }

  try {
    const button = row.querySelector('button');
    button.disabled = true;
    button.textContent = 'Procesando...';

    // Actualiza el registro en Supabase
    const { error } = await supabase
      .from('conteoinventario')
      .update({
        cantidad: quantity,
        cantidad_contada: true, // Marca como contado
        fecha_actualizacion: new Date().toISOString()
      })
      .eq('id', assignmentId);

    if (error) throw error;

    // Recarga los datos
    await loadAssignments();
    await loadInventoryData();

    Swal.fire({
      icon: 'success',
      title: 'Conteo registrado',
      text: 'La cantidad ha sido registrada correctamente',
      timer: 2000,
      showConfirmButton: false
    });
  } catch (error) {
    console.error('Error al registrar conteo:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo registrar el conteo'
    });
  } finally {
    const button = row.querySelector('button');
    button.disabled = false;
    button.textContent = 'Registrar Conteo';
  }
};





















    
    window.startCountingAssignment = async function(id) {
      const row = document.querySelector(`tr[data-assignment-id="${id}"]`);
      if (!row) return;

      const rack = row.cells[0].querySelector('div').textContent.replace('Rack ', '');
      const location = row.cells[1].querySelector('div').textContent;
      const partNumber = row.cells[2].querySelector('div').textContent;
      const description = row.cells[3].querySelector('div').textContent === '-' ? '' : row.cells[3].querySelector('div').textContent;
      const user = row.cells[4].querySelector('div').textContent;
      const countInput = row.querySelector('.count-input');
      const quantity = parseInt(countInput.value);

      if (!quantity || quantity <= 0) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Por favor ingrese una cantidad válida mayor a cero'
        });
        return;
      }

      const newRecord = {
        rack,
        location,
        partNumber,
        description,
        quantity,
        user
      };

      try {
        row.classList.add('bg-gray-100');
        const button = row.querySelector('button');
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Procesando...';

        await insertInventoryRecord(newRecord);
        countInput.value = '';
        await loadInventoryData();

        Swal.fire({
          icon: 'success',
          title: 'Éxito',
          text: 'Conteo registrado correctamente',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error saving inventory record:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Error al guardar el registro de inventario'
        });
      } finally {
        row.classList.remove('bg-gray-100');
        const button = row.querySelector('button');
        button.disabled = false;
        button.textContent = 'Registrar Conteo';
      }
    };

    // INICIALIZACIÓN DEL DOCUMENTO
    document.addEventListener('DOMContentLoaded', function() {
      // Configurar selects de ubicaciones para ambos formularios
      function setupLocationSelects(rackSelectId, locationSelectId) {
        const rackSelect = document.getElementById(rackSelectId);
        const locationSelect = document.getElementById(locationSelectId);
        rackSelect.addEventListener('change', function() {
          locationSelect.innerHTML = '<option value="">Seleccione ubicación</option>';
          const selectedRack = this.value;

          if (selectedRack && rackLocations[selectedRack]) {
            for (let i = 1; i <= rackLocations[selectedRack]; i++) {
              const option = document.createElement('option');
              option.value = `${selectedRack}-${i}`;
              option.textContent = `${selectedRack}-${i}`;
              locationSelect.appendChild(option);
            }
          }
        });
      }
      // Configurar ambos pares de selects
      setupLocationSelects('rack', 'location');
      setupLocationSelects('rack-assignment', 'location-assignment');

      // CONFIGURACIÓN DE PESTAÑAS
      const tabAdmin = document.getElementById('tab-admin');
      const tabInventory = document.getElementById('tab-inventory');
      const tabView = document.getElementById('tab-view');
      const contentAdmin = document.getElementById('content-admin');
      const contentInventory = document.getElementById('content-inventory');
      const contentView = document.getElementById('content-view');

      function showTab(activeTab, activeContent, otherTabs, otherContents) {
        // Actualizar estilos de pestañas
        activeTab.classList.add('border-b-2', 'border-navy', 'text-navy');
        activeTab.classList.remove('text-gray-500');

        otherTabs.forEach(tab => {
          tab.classList.remove('border-b-2', 'border-navy', 'text-navy');
          tab.classList.add('text-gray-500');
        });

        // Mostrar/ocultar contenido
        activeContent.classList.remove('hidden');
        activeContent.classList.add('block');

        otherContents.forEach(content => {
          content.classList.add('hidden');
          content.classList.remove('block');
        });
      }

      tabAdmin.addEventListener('click', function() {
        showTab(tabAdmin, contentAdmin, [tabInventory, tabView], [contentInventory, contentView]);
      });

      tabInventory.addEventListener('click', function() {
        showTab(tabInventory, contentInventory, [tabAdmin, tabView], [contentAdmin, contentView]);
      });

      tabView.addEventListener('click', function() {
        showTab(tabView, contentView, [tabAdmin, tabInventory], [contentAdmin, contentInventory]);
        loadAssignments(); // Cargar asignaciones cuando se hace clic en la pestaña
      });

      // FORMULARIO DE INVENTARIO
      document.getElementById('inventory-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const submitLoader = document.getElementById('submit-loader');

        // Mostrar loading
        submitText.textContent = 'Procesando...';
        submitLoader.classList.remove('hidden');
        submitBtn.disabled = true;
        const formData = {
          rack: document.getElementById('rack').value,
          location: document.getElementById('location').value,
          user: document.getElementById('user').value,
          partNumber: document.getElementById('part-number').value,
          description: document.getElementById('description').value,
          quantity: parseInt(document.getElementById('quantity').value)
        };
        try {
          await insertInventoryRecord(formData);
          await loadInventoryData();
          this.reset();
          Swal.fire({
            icon: 'success',
            title: 'Éxito',
            text: 'Conteo registrado correctamente',
            timer: 2000,
            showConfirmButton: false
          });
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo guardar el registro: ' + error.message
          });
        } finally {
          submitText.textContent = 'Registrar Conteo';
          submitLoader.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });

      // FORMULARIO DE REGISTRO DE USUARIOS
      document.getElementById('user-register-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const userName = document.getElementById('new-user-name').value;
        const userArea = document.getElementById('new-user-area').value;

        if (userName && userArea) {
          try {
            const newUser = {
              nombre: userName,
              puesto: userArea
            };

            await insertUser(newUser);
            await loadUserData();
            this.reset();

            Swal.fire({
              icon: 'success',
              title: 'Usuario Registrado',
              text: 'El usuario ha sido agregado correctamente',
              timer: 2000,
              showConfirmButton: false
            });
          } catch (error) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'No se pudo registrar el usuario'
            });
          }
        }
      });

    // FORMULARIO DE ASIGNACIONES
document.getElementById('assignment-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const user = document.getElementById('user-assignment').value.trim();
  const rack = document.getElementById('rack-assignment').value.trim();
  const location = document.getElementById('location-assignment').value.trim();
  const partNumber = document.getElementById('part-number-assignment').value.trim();

  // Depuración: Muestra los valores en la consola
  console.log('Usuario:', user);
  console.log('Rack:', rack);
  console.log('Ubicación:', location);
  console.log('Número de parte:', partNumber);

  // Valida que los campos no estén vacíos
  if (!user || !rack || !location || !partNumber) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Todos los campos son obligatorios'
    });
    return;
  }

  // Obtén la descripción del número de parte
  const description = await getPartDescription(partNumber);
  console.log('Descripción:', description);

  try {
    // Inserta el registro en Supabase
    const { error } = await supabase
      .from('conteoinventario')
      .insert([
        {
          rack: rack,
          ubicacion: location,
          usuario_asignado: user,
          numero_parte: partNumber,
          descripcion: description,
          cantidad: 0, // Inicialmente 0
          cantidad_contada: false // Pendiente
        }
      ]);

    if (error) throw error;

    // Éxito
    Swal.fire({
      icon: 'success',
      title: 'Asignación registrada',
      text: `Se asignó a ${user} para contar el rack ${rack}, ubicación ${location}, parte ${partNumber}`,
      confirmButtonColor: '#0a192f'
    });

    // Recarga las asignaciones pendientes
    await loadAssignments();
    this.reset();
  } catch (error) {
    console.error('Error al registrar asignación:', error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo registrar la asignación'
    });
  }
});

      // CARGAR DATOS INICIALES
      loadInventoryData();
      loadUserData();

      // CARGAR NÚMEROS DE PARTE PARA AUTOCOMPLETAR
      loadPartNumbers('part-number-list');
      loadPartNumbers('part-number-list-assignment');

      // AUTOCOMPLETAR DESCRIPCIÓN AL SELECCIONAR NÚMERO DE PARTE
document.getElementById('part-number').addEventListener('blur', async function() {
  const partNumber = this.value.trim();
  if (partNumber) {
    const description = await getPartDescription(partNumber);
    if (!description) {
      Swal.fire({
        icon: 'warning',
        title: 'Número de parte no encontrado',
        text: 'El número de parte ingresado no existe en la base de datos.',
      });
      document.getElementById('description').value = '';
    } else {
      document.getElementById('description').value = description;
    }
  }
});

      // AUTOCOMPLETAR DESCRIPCIÓN EN FORMULARIO DE ASIGNACIÓN
      document.getElementById('part-number-assignment').addEventListener('blur', async function() {
        const partNumber = this.value.trim();
        if (partNumber) {
          const description = await getPartDescription(partNumber);
          if (!description) {
            Swal.fire({
              icon: 'warning',
              title: 'Número de parte no encontrado',
              text: 'El número de parte ingresado no existe en la base de datos.',
            });
          }
        }
      });
    });
  </script>
</body>
</html>
