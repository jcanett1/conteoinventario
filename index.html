<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conteo de Inventario PXG</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style id="app-style">
    /* Ocultar elementos exclusivos del administrador por defecto */
.admin-only {
    display: none !important;
}

/* Mostrar elementos exclusivos del administrador si el usuario es admin */
.is-admin .admin-only {
    display: block !important;
}
    
    .bg-navy {
      background-color: #0a192f;
    }
    .text-navy {
      color: #0a192f;
    }
    .border-navy {
      border-color: #0a192f;
    }
    .hover-bg-navy:hover {
      background-color: #0a192f;
      color: white;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-hover tr:hover {
      background-color: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .loader {
      border-top-color: #0a192f;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-navy shadow-md">
    <div class="container mx-auto px-4 py-5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-warehouse text-white text-3xl mr-3"></i>
          <h1 class="text-2xl font-bold text-white">Sistema de Conteo de Inventario PXG</h1>
        </div>
        <div>
          <button id="logout-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded-md text-sm transition-all">
        <i class="fas fa-sign-out-alt mr-1"></i>Cerrar Sesión
    </button>
          <button id="reset-data-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
            <i class="fas fa-trash-alt mr-2"></i>Reiniciar Datos
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- Add tab navigation -->
<!-- Modifica las pestañas del menú -->
<div class="flex border-b border-gray-200">
  <button id="tab-admin" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
    <i class="fas fa-cog"></i> Administración
  </button>
  <button id="tab-inventory" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
    <i class="fas fa-boxes"></i> Conteo de Inventario
  </button>
  <button id="tab-view" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
    <i class="fas fa-tasks"></i> Vista de Asignaciones
  </button>
  <button id="tab-inventory-numbers" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
    <i class="fas fa-list"></i> Números de Inventario
  </button>
  
 <!-- Nueva Pestaña Carga Masiva -->
    <button id="tab-bulk-upload" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
      <i class="fas fa-file-upload"></i> Carga Masiva
    </button>
  </div>


</div>
  <!-- Main Content with two tab containers -->
  <main class="container mx-auto px-4 py-6">
    <!-- Tab 1: Administración -->
    <div id="content-admin" class="block">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Left Column - User Assignment Form -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignación de Usuario para Conteo</h2>

          <form id="assignment-form" class="space-y-4">
            <div>
              <label for="user-assignment" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input type="text" id="user-assignment" name="user-assignment" list="user-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
               <datalist id="user-list"> </datalist>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack-assignment" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack-assignment" name="rack-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                  <option value="AREA_KITEO">AREA KITEO</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location-assignment" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                <select id="location-assignment" name="location-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicación</option>
                </select>
              </div>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number-assignment" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
              <input type="text" id="part-number-assignment" name="part-number-assignment" list="part-number-list-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese número de parte">
              <datalist id="part-number-list-assignment">
                <!-- Se llenará con JavaScript -->
              </datalist>
            </div>

 <!-- Asignación Pendiente -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">¿Es una asignación pendiente?</label>
      <div class="flex items-center space-x-4">
        <label class="flex items-center">
          <input type="radio" name="es_asignacion" value="true" checked class="mr-2">
          Sí
        </label>
        <label class="flex items-center">
          <input type="radio" name="es_asignacion" value="false" class="mr-2">
          No
        </label>
      </div>
    </div>

            
            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="assignment-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
                Asignar Usuario
              </button>
            </div>
          </form>
        </div>

        <!-- Right Column - User Registration -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de Usuarios para Conteo</h2>

          <form id="user-register-form" class="mb-6 flex items-end space-x-2">
            <div class="flex-1">
              <label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
              <input type="text" id="new-user-name" name="new-user-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre del usuario">
            </div>
            <div class="flex-1">
              <label for="new-user-area" class="block text-sm font-medium text-gray-700 mb-1">Área</label>
              <input type="text" id="new-user-area" name="new-user-area" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Área o puesto">
            </div>
            <button type="submit" class="bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Usuario
            </button>
          </form>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-hover">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Área</th>
                </tr>
              </thead>
              <tbody id="user-registry" class="bg-white divide-y divide-gray-200">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Lupta</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Kiteo</div>
                  </td>
                </tr>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">Alan Ramos</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">Producción</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

<!-- Tab 4: Números de Inventario -->
<div id="content-inventory-numbers" class="hidden">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de Números de Inventario</h2>
    <form id="inventory-numbers-form" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Select de Número de Inventario -->
        <div>
          <label for="inventory-number" class="block text-sm font-medium text-gray-700 mb-1">Número de Inventario</label>
          <select id="inventory-number" name="inventory-number" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione un número de inventario</option>
            <!-- Opciones se cargarán dinámicamente desde Supabase -->
          </select>
        </div>
        <!-- Select de Rack -->
        <div>
          <label for="inventory-rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
          <select id="inventory-rack" name="inventory-rack" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione un Rack</option>
            <option value="A">Rack A</option>
            <option value="B">Rack B</option>
            <option value="C">Rack C</option>
            <option value="D">Rack D</option>
            <option value="E">Rack E</option>
            <option value="F">Rack F</option>
            <option value="G">Rack G</option>
            <option value="AREA_KITEO">AREA KITEO</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Select de Ubicación -->
        <div>
          <label for="inventory-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
          <select id="inventory-location" name="inventory-location" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">Seleccione ubicación</option>
          </select>
        </div>
        <!-- Input de Usuario -->
        <div>
          <label for="inventory-user" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
          <input type="text" id="inventory-user" name="inventory-user" list="user-list-inventory-numbers" required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Seleccione o ingrese usuario">
          <datalist id="user-list-inventory-numbers">
            <!-- Opciones se cargarán dinámicamente -->
          </datalist>
        </div>
      </div>
      <!-- Input de Cantidad -->
      <div>
        <label for="inventory-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
        <input type="number" id="inventory-quantity" name="inventory-quantity" min="1" required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Ingrese cantidad">
      </div>
      <!-- Botón de Registrar -->
      <div class="pt-2">
        <button type="submit" id="inventory-numbers-submit-btn"
          class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
          Registrar Número de Inventario
        </button>
      </div>
    </form>
  </div>
</div>




    
    <!-- Tab 2: Conteo de Inventario -->
    <div id="content-inventory" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Form Column -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro Manual de Inventario</h2>

          <form id="inventory-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- Rack Selection -->
              <div>
                <label for="rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack" name="rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                  <option value="A">Rack A</option>
                  <option value="B">Rack B</option>
                  <option value="C">Rack C</option>
                  <option value="D">Rack D</option>
                  <option value="E">Rack E</option>
                  <option value="F">Rack F</option>
                  <option value="G">Rack G</option>
                  <option value="AREA_KITEO">AREA KITEO</option>
                </select>
              </div>

              <!-- Location Selection -->
              <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                <select id="location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicación</option>
                </select>
              </div>
            </div>

            <!-- User Assignment -->
            <div>
              <label for="user" class="block text-sm font-medium text-gray-700 mb-1">Usuario Asignado</label>
              <input type="text" id="user" name="user" list="user-list-inventory" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
              <datalist id="user-list-inventory">
                <option value="Lupta (Kiteo)">
                <option value="Alan Ramos (Producción)">
                <option value="Carlos Méndez (Almacén)">
                <option value="Maria González (Inventario)">
              </datalist>
            </div>

            <!-- Part Number -->
            <div>
              <label for="part-number" class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
              <input type="text" id="part-number" name="part-number" list="part-number-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese número de parte">
              <datalist id="part-number-list">
                <!-- Se llenará con JavaScript -->
              </datalist>
            </div>

            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
              <input type="text" id="description" name="description" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese descripción del producto">
            </div>

            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input type="number" id="quantity" name="quantity" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad contada">
            </div>

            <!-- Submit Button -->
            <div class="pt-2">
              <button type="submit" id="submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all flex items-center justify-center">
                <span id="submit-text">Registrar Conteo</span>
                <span id="submit-loader" class="hidden ml-2">
                  <div class="loader h-5 w-5 rounded-full border-2 border-white border-t-4"></div>
                </span>
              </button>
            </div>
          </form>
        </div>

<!-- Tabla de Total por Número de Parte -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6" style="width: 740px; height: auto;">
  <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Total por Número de Parte</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 table-hover">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número de Parte</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
        </tr>
      </thead>
      <tbody id="total-by-part-number" class="bg-white divide-y divide-gray-200">
        <!-- Los datos se llenarán con JavaScript -->
        <tr>
          <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>



        
       <!-- Summary Column -->
        <div class="md:col-span-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Resumen por Rack</h2>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-hover">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Ítems</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                     <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Actualizacion</th>
                  </tr>
                </thead>
                <tbody id="rack-summary-body" class="bg-white divide-y divide-gray-200">
                  <!-- Rack summary data will be inserted here via JavaScript -->
                  <tr>
                    <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>


      <!-- User Assignment Summary -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Conteo por Usuario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ítems Contados</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Conteo</th>
              </tr>
            </thead>
            <tbody id="user-summary" class="bg-white divide-y divide-gray-200">
              <!-- User summary data will be inserted here via JavaScript -->
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>


<div class="flex space-x-2 mb-4">
  <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-all">
    <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
  </button>
  <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
    <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
  </button>
</div>


      
<div class="flex flex-col md:flex-row md:items-center md:space-x-4 mb-4">
  <!-- Filtro por Usuario -->
  <div class="flex-1 mb-2 md:mb-0">
    <label for="filter-user" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Usuario</label>
    <input type="text" id="filter-user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Alan Ramos">
  </div>

  <!-- Filtro por Número de Parte -->
  <div class="flex-1 mb-2 md:mb-0">
    <label for="filter-part" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Número de Parte</label>
    <input type="text" id="filter-part" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: ABC123">
  </div>

  <!-- Botón para limpiar filtros -->
  <div class="flex items-end mb-2 md:mb-0">
    <button id="clear-filters-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-all h-10">
      <i class="fas fa-times mr-2"></i>Limpiar
    </button>
  </div>
</div>
    
      <!-- Inventory Records -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registros de Inventario</h2>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="inventory-records" class="bg-white divide-y divide-gray-200">
              <!-- Inventory records will be inserted here via JavaScript -->
              <tr>
                <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">Cargando registros...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
<!-- Tab 3: Vista de Asignaciones -->
<div id="content-view" class="hidden m-0 p-0">
  <div class="bg-white rounded-lg shadow-md m-0 p-0">
    <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2 pl-2">Asignaciones Pendientes</h2>
    <div class="overflow-x-auto m-0 p-0">
      <table class="w-full divide-y divide-gray-200 table-hover m-0">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Rack</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Ubicación</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Número de Parte</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Descripción</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Usuario Asignado</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Cantidad Contada</th>
            <th scope="col" class="py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider pl-1">Acción</th>
          </tr>
        </thead>
        <tbody id="assignment-list" class="bg-white divide-y divide-gray-200 m-0 p-0">
          <!-- Assignment data will be inserted here -->
          <tr>
            <td colspan="7" class="py-4 text-center text-sm text-gray-500 pl-1">
              No hay asignaciones disponibles
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

 <!-- Tab 5: Carga Masiva -->
    <div id="content-bulk-upload" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Carga Masiva de Asignaciones</h2>
        <p class="mb-4 text-sm text-gray-600">Sube un archivo Excel (.xlsx) con las columnas: Rack, Ubicación, Número de Parte, Descripción, Usuario Asignado. La Cantidad Contada se dejará en blanco para que sea ingresada posteriormente.</p>
        <form id="bulk-upload-form" class="space-y-4">
          <div>
            <label for="excel-file" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Archivo Excel</label>
            <input type="file" id="excel-file" name="excel-file" accept=".xlsx, .xls" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="pt-2">
            <button type="submit" id="upload-submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Subir y Procesar
            </button>
          </div>
        </form>
        <div id="upload-result" class="mt-6 p-4 bg-gray-50 rounded-md hidden">
          <h3 class="text-lg font-medium mb-2">Resultado de la Carga:</h3>
          <div id="upload-messages" class="text-sm"></div>
        </div>
      </div>
    </div>
  </main>
  <!-- Footer -->
  <footer class="bg-navy text-white py-4 mt-8">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Sistema de Conteo de Inventario PXG | Todos los derechos reservados</p>
      <p>&copy; En caso de necesitar asistencia técnica, ponte en contacto con el administrador del sistema IT: Julio</p>
    </div>
  </footer>
  <!-- JavaScript Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script id="app-script">
    // CONFIGURACIÓN SUPABASE (Repetida aquí para el script de autenticación)
    const SUPABASE_URL_AUTH = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
    const SUPABASE_ANON_KEY_AUTH = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';
    // Inicializar cliente Supabase solo para autenticación
    const authSupabase = window.supabase.createClient(SUPABASE_URL_AUTH, SUPABASE_ANON_KEY_AUTH, {
        auth: {
            persistSession: true, // Muy importante para mantener la sesión
            autoRefreshToken: true
        }
    });

    // FUNCIONES DE LA UI (showTab y otras funciones auxiliares)
    function showTab(activeTab, activeContent, otherTabs, otherContents) {
        // Ocultar contenido de otras pestañas
        otherContents.forEach(content => content.classList.add('hidden'));
        // Mostrar contenido de la pestaña activa
        activeContent.classList.remove('hidden');

        // Remover estilo activo de otras pestañas
        otherTabs.forEach(tab => tab.classList.remove('border-navy', 'text-navy', 'border-b-2'));
        // Aplicar estilo activo a la pestaña activa
        activeTab.classList.add('border-navy', 'text-navy', 'border-b-2');
    }

    // CONFIGURACIÓN SUPABASE
    const SUPABASE_URL = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';
    // Inicializar Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // Variables globales
    let inventoryData = [];
    let userData = []; // <-- Esta es la declaración original
    const rackLocations = {
      'A': 48, 'B': 48, 'C': 48, 'D': 42, 'E': 42, 'F': 21, 'G': 32
    };

    // FUNCIONES DE SUPABASE PARA INVENTARIO
    async function getAllInventoryRecords() {
        console.log('Obteniendo registros de Supabase...');
        try {
            const { data, error } = await supabase
                .from('conteoinventario')
                .select('*')
                .order('fecha_creacion', { ascending: false });
            if (error) {
                console.error('Error de Supabase:', error);
                throw error;
            }
            console.log('Registros obtenidos:', data?.length || 0);
            return data || [];
        } catch (error) {
            console.error('Error getting records:', error);
            Swal.fire('Error', 'No se pudieron cargar los datos de la base de datos', 'error');
            return [];
        }
    }

    async function insertInventoryRecord(record) {
        try {
            const supabaseRecord = {
                rack: record.rack,
                ubicacion: record.location,
                usuario_asignado: record.user,
                numero_parte: record.partNumber,
                descripcion: record.description,
                cantidad: record.quantity
            };
            console.log('Insertando registro:', supabaseRecord);
            const { data, error } = await supabase
                .from('conteoinventario')
                .insert([supabaseRecord])
                .select();
            if (error) throw error;
            console.log('Registro insertado:', data[0]);
            return { id: data[0].id, ...record, fecha_creacion: data[0].fecha_creacion };
        } catch (error) {
            console.error('Error inserting record:', error);
            throw error;
        }
    }

    async function updateInventoryRecord(updatedRecord) {
        try {
            // Obtener el registro actual para comparar la cantidad
            const { data: currentRecord, error: fetchError } = await supabase
                .from('conteoinventario')
                .select('cantidad, modificaciones')
                .eq('id', updatedRecord.id)
                .single();
            if (fetchError) throw fetchError;

            let newModificaciones = currentRecord.modificaciones || 0;
            // Comparar cantidades y aumentar el contador si son diferentes
            if (currentRecord.cantidad !== updatedRecord.quantity) {
                newModificaciones += 1;
            }

            console.log('Actualizando registro con modificaciones:', newModificaciones);
            const { data, error } = await supabase
                .from('conteoinventario')
                .update({
                    rack: updatedRecord.rack,
                    ubicacion: updatedRecord.location,
                    usuario_asignado: updatedRecord.user,
                    numero_parte: updatedRecord.partNumber,
                    descripcion: updatedRecord.description,
                    cantidad: updatedRecord.quantity,
                    modificaciones: newModificaciones,
                    fecha_actualizacion: new Date().toISOString()
                })
                .eq('id', updatedRecord.id);
            if (error) throw error;
            console.log('Registro actualizado:', data);
            return data;
        } catch (error) {
            console.error('Error updating record:', error);
            throw error;
        }
    }

    async function deleteInventoryRecords(id) {
        try {
            if (id) {
                const { error } = await supabase
                    .from('conteoinventario')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
            } else {
                const { error } = await supabase
                    .from('conteoinventario')
                    .delete()
                    .neq('id', 0); // Esto eliminará todos los registros, ten cuidado
                if (error) throw error;
            }
            return { success: true };
        } catch (error) {
            console.error('Error deleting records:', error);
            throw error;
        }
    }

    // FUNCIONES DE SUPABASE PARA USUARIOS
    async function getAllUsers() {
        try {
            const { data, error } = await supabase
                .from('usuarioconteo')
                .select('nombre')
                .order('nombre', { ascending: true });
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error getting users:', error);
            return [];
        }
    }

    async function insertUser(userData) {
        try {
            const { data, error } = await supabase
                .from('usuarioconteo')
                .insert([userData])
                .select();
            if (error) throw error;
            return data[0];
        } catch (error) {
            console.error('Error inserting user:', error);
            throw error;
        }
    }

    // FUNCIONES PARA NÚMEROS DE PARTE Y DESCRIPCIÓN
    async function getPartDescription(partNumber) {
        try {
            const { data, error } = await supabase
                .from('numerosinventario')
                .select('descripcion')
                .eq('inventario_id', partNumber) // Cambia 'numero_parte' por 'inventario_id'
                .single();
            if (error && error.code !== 'PGRST116') { // PGRST116 = No rows found
                throw error;
            }
            return data?.descripcion || '';
        } catch (error) {
            console.error('Error al buscar la descripción:', error);
            return '';
        }
    }

    // Función para cargar números de inventario desde Supabase
    async function loadInventoryNumbers() {
        try {
            const { data, error } = await supabase
                .from('numerosinventario')
                .select('inventario_id, descripcion')
                .order('inventario_id', { ascending: true });
            if (error) throw error;
            const select = document.getElementById('inventory-number');
            select.innerHTML = '<option value="">Seleccione un número de inventario</option>';
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.inventario_id;
                option.textContent = `${item.inventario_id} - ${item.descripcion}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error al cargar números de inventario:', error);
            Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudieron cargar los números de inventario' });
        }
    }

    // FUNCIONES DE LA UI
    function updateUI() {
        updateRackSummary();
        updateUserSummary();
        updateInventoryRecords();
        updateTotalByPartNumber(); // Agregar esta línea
    }

    // ACTUALIZAR RESUMEN POR RACK (CORREGIDA Y MODIFICADA PARA INCLUIR KITEO)
    function updateRackSummary() {
        console.log('- Iniciando updateRackSummary -');
        console.log('Longitud de inventoryData:', inventoryData ? inventoryData.length : 'inventoryData es undefined/null');

        const summaryDiv = document.getElementById('rack-summary');
        if (!summaryDiv) {
            console.error('No se encontró el div #rack-summary');
            return;
        }
        summaryDiv.innerHTML = ''; // Limpiar contenido anterior

        if (!inventoryData || inventoryData.length === 0) {
            console.log('inventoryData está vacío o no definido.');
            summaryDiv.innerHTML = '<p class="text-gray-500">No hay datos de inventario para mostrar.</p>';
            return;
        }

        const rackTotals = {};
        inventoryData.forEach(item => {
            const rack = item.rack;
            if (!rackTotals[rack]) {
                rackTotals[rack] = 0;
            }
            // Solo sumar si el conteo ha sido realizado (cantidad_contada es true o cantidad > 0)
            if (item.cantidad_contada || item.cantidad > 0) {
                 rackTotals[rack] += item.cantidad || 0;
            }
        });

        console.log('Totales por Rack calculados:', rackTotals);

        // Crear un array de racks y ordenarlo
        const sortedRacks = Object.keys(rackTotals).sort((a, b) => {
            // Ordenar A-G y luego AREA_KITEO al final
            if (a === 'AREA_KITEO') return 1;
            if (b === 'AREA_KITEO') return -1;
            return a.localeCompare(b);
        });

        sortedRacks.forEach(rack => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4';
            div.innerHTML = `
                <h3 class="font-semibold text-navy">Rack ${rack}</h3>
                <p class="text-2xl font-bold">${rackTotals[rack]}</p>
            `;
            summaryDiv.appendChild(div);
        });
    }

    // ACTUALIZAR RESUMEN POR USUARIO
    function updateUserSummary() {
        console.log('- Iniciando updateUserSummary -');
        console.log('Longitud de inventoryData:', inventoryData ? inventoryData.length : 'inventoryData es undefined/null');

        const summaryDiv = document.getElementById('user-summary');
        if (!summaryDiv) {
            console.error('No se encontró el div #user-summary');
            return;
        }
        summaryDiv.innerHTML = ''; // Limpiar contenido anterior

        if (!inventoryData || inventoryData.length === 0) {
            console.log('inventoryData está vacío o no definido.');
            summaryDiv.innerHTML = '<p class="text-gray-500">No hay datos de inventario para mostrar.</p>';
            return;
        }

        const userTotals = {};
        inventoryData.forEach(item => {
            const user = item.usuario_asignado;
            if (!user) return; // Saltar si no hay usuario asignado
            if (!userTotals[user]) {
                userTotals[user] = { total: 0, counted: 0, pending: 0 };
            }
            // Contar total de registros asignados
            userTotals[user].total += 1;
            // Contar registros contados y pendientes
            if (item.cantidad_contada) {
                userTotals[user].counted += 1;
            } else {
                userTotals[user].pending += 1;
            }
        });

        console.log('Totales por Usuario calculados:', userTotals);

        // Crear un array de usuarios y ordenarlo alfabéticamente
        const sortedUsers = Object.keys(userTotals).sort();

        sortedUsers.forEach(user => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4';
            div.innerHTML = `
                <h3 class="font-semibold text-navy">${user}</h3>
                <p class="text-lg"><span class="font-bold">Total:</span> ${userTotals[user].total}</p>
                <p class="text-lg"><span class="text-green-500 font-bold">Contados:</span> ${userTotals[user].counted}</p>
                <p class="text-lg"><span class="text-red-500 font-bold">Pendientes:</span> ${userTotals[user].pending}</p>
            `;
            summaryDiv.appendChild(div);
        });
    }

    // ACTUALIZAR REGISTROS DE INVENTARIO
    function updateInventoryRecords() {
        console.log('- Iniciando updateInventoryRecords -');
        console.log('Longitud de inventoryData:', inventoryData ? inventoryData.length : 'inventoryData es undefined/null');

        const tableBody = document.getElementById('inventory-table-body');
        if (!tableBody) {
            console.error('No se encontró el tbody #inventory-table-body');
            return;
        }
        tableBody.innerHTML = ''; // Limpiar contenido anterior

        if (!inventoryData || inventoryData.length === 0) {
            console.log('inventoryData está vacío o no definido.');
            tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros de inventario</td></tr>';
            return;
        }

        // Filtrar solo los registros que NO son asignaciones pendientes ni reconteos
        const filteredData = inventoryData.filter(item => !item.es_asignacion && !item.es_reconteo);

        if (filteredData.length === 0) {
            console.log('No hay registros de inventario general (no asignaciones ni reconteos).');
            tableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros de inventario general</td></tr>';
            return;
        }

        filteredData.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-700">${item.rack}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.ubicacion}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.numero_parte}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.descripcion}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.usuario_asignado}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.cantidad}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.modificaciones || 0}</td>
                <td class="px-6 py-4 text-sm">
                    <button onclick="editRecord(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2">Editar</button>
                    <button onclick="deleteRecord(${item.id})" class="text-red-600 hover:text-red-900">Eliminar</button>
                    <button onclick="reconteoRecord(${item.id})" class="text-yellow-600 hover:text-yellow-900 ml-2">Recontar</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // ACTUALIZAR TOTAL POR NÚMERO DE PARTE
    function updateTotalByPartNumber() {
        console.log('- Iniciando updateTotalByPartNumber -');
        console.log('Longitud de inventoryData:', inventoryData ? inventoryData.length : 'inventoryData es undefined/null');

        const summaryDiv = document.getElementById('total-by-part-number');
        if (!summaryDiv) {
            console.error('No se encontró el div #total-by-part-number');
            return;
        }
        summaryDiv.innerHTML = ''; // Limpiar contenido anterior

        if (!inventoryData || inventoryData.length === 0) {
            console.log('inventoryData está vacío o no definido.');
            summaryDiv.innerHTML = '<p class="text-gray-500">No hay datos de inventario para mostrar.</p>';
            return;
        }

        const partNumberTotals = {};
        inventoryData.forEach(item => {
            const partNumber = item.numero_parte;
            if (!partNumber) return; // Saltar si no hay número de parte
            if (!partNumberTotals[partNumber]) {
                partNumberTotals[partNumber] = { total: 0, description: item.descripcion };
            }
            // Solo sumar si el conteo ha sido realizado (cantidad_contada es true o cantidad > 0)
            if (item.cantidad_contada || item.cantidad > 0) {
                 partNumberTotals[partNumber].total += item.cantidad || 0;
            }
        });

        console.log('Totales por Número de Parte calculados:', partNumberTotals);

        // Crear un array de objetos [partNumber, details] y ordenarlo por número de parte
        const sortedPartNumbers = Object.entries(partNumberTotals).sort(([a], [b]) => a.localeCompare(b));

        sortedPartNumbers.forEach(([partNumber, details]) => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4';
            div.innerHTML = `
                <h3 class="font-semibold text-navy">${partNumber}</h3>
                <p class="text-sm text-gray-600">${details.description}</p>
                <p class="text-xl font-bold">${details.total}</p>
            `;
            summaryDiv.appendChild(div);
        });
    }

    // FUNCIONES GLOBALES PARA EDICIÓN Y ELIMINACIÓN
    window.editRecord = async function(id) {
        const record = inventoryData.find(item => item.id === id);
        if (!record) return;

        const { value: formValues } = await Swal.fire({
            title: 'Editar Registro',
            html: `<div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                            <input id="edit-rack" class="swal2-input" value="${record.rack}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                            <input id="edit-location" class="swal2-input" value="${record.ubicacion}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                            <input id="edit-user" class="swal2-input" value="${record.usuario_asignado}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número de Parte</label>
                            <input id="edit-part-number" class="swal2-input" value="${record.numero_parte}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                            <input id="edit-description" class="swal2-input" value="${record.descripcion}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                            <input type="number" id="edit-quantity" class="swal2-input" value="${record.cantidad}">
                        </div>
                   </div>`,
            focusConfirm: false,
            preConfirm: () => {
                return {
                    rack: document.getElementById('edit-rack').value,
                    location: document.getElementById('edit-location').value,
                    user: document.getElementById('edit-user').value,
                    partNumber: document.getElementById('edit-part-number').value,
                    description: document.getElementById('edit-description').value,
                    quantity: parseInt(document.getElementById('edit-quantity').value)
                };
            }
        });

        if (formValues) {
            try {
                await updateInventoryRecord({ id, ...formValues });
                await loadInventoryData();
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: 'Registro actualizado correctamente',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error al actualizar el registro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo actualizar el registro'
                });
            }
        }
    };

    window.deleteRecord = async function(id) {
        const result = await Swal.fire({
            title: '¿Eliminar registro?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                await deleteInventoryRecords(id);
                await loadInventoryData();
                Swal.fire({
                    icon: 'success',
                    title: 'Eliminado',
                    text: 'El registro ha sido eliminado',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error al eliminar el registro:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo eliminar el registro'
                });
            }
        }
    };

    window.reconteoRecord = async function(id) {
        const record = inventoryData.find(item => item.id === id);
        if (!record) return;

        const result = await Swal.fire({
            title: '¿Recontar este registro?',
            text: `El registro será marcado como pendiente y aparecerá en "Asignaciones Pendientes" para que ${record.usuario_asignado} vuelva a ingresar la cantidad contada.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, recontar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                // Actualizar el registro en Supabase para marcarlo como pendiente
                const { error } = await supabase
                    .from('conteoinventario')
                    .update({
                        cantidad: 0, // Reiniciar la cantidad
                        cantidad_contada: false, // Marcar como pendiente
                        es_asignacion: true, // Marcar como asignación pendiente
                        es_reconteo: true, // Marcar como reconteo (nuevo campo)
                        fecha_actualizacion: new Date().toISOString()
                    })
                    .eq('id', id);
                if (error) throw error;

                // Recargar los datos
                await loadAssignments();
                await loadInventoryData();
                Swal.fire({
                    icon: 'success',
                    title: 'Reconteo registrado',
                    text: 'El registro ha sido marcado como pendiente y aparecerá en "Asignaciones Pendientes".',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Error al registrar reconteo:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo registrar el reconteo'
                });
            }
        }
    };

async function loadPartNumbers(datalistId) {
    try {
        // Ajusta el nombre de la tabla y columna según tu base de datos
        const { data, error } = await supabase
            .from('numerosinventario') // ← ¡Cambia esto al nombre real de tu tabla!
            .select('inventario_id'); // ← ¡Y esto al nombre real de tu columna!

        if (error) throw error;

        const datalist = document.getElementById(datalistId);
        if (!datalist) {
            console.warn(`Datalist con ID "${datalistId}" no encontrado.`);
            return;
        }

        // Limpiar opciones anteriores
        datalist.innerHTML = '';

        // Agregar nuevas opciones
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.inventario_id; // ← ajusta al nombre de tu campo
            datalist.appendChild(option);
        });

    } catch (error) {
        console.error('Error al cargar números de parte:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error al cargar datos',
            text: 'No se pudieron cargar los números de parte.',
        });
    }
}


















  
    // FUNCIONES DE CARGA DE DATOS
    async function loadInventoryData() {
        console.log('Cargando datos de inventario...');
        inventoryData = await getAllInventoryRecords();
        updateUI();
    }

    async function loadUserData() {
        console.log('Cargando datos de usuarios...');
        userData = await getAllUsers();
        const userSelect = document.getElementById('user');
        const userAssignmentSelect = document.getElementById('user-assignment');
        const inventoryUserSelect = document.getElementById('inventory-user');
        if (userSelect) {
            userSelect.innerHTML = '<option value="">Seleccione usuario</option>';
            userData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.nombre;
                option.textContent = user.nombre;
                userSelect.appendChild(option);
            });
        }
         if (userAssignmentSelect) {
            userAssignmentSelect.innerHTML = '<option value="">Seleccione usuario</option>';
            userData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.nombre;
                option.textContent = user.nombre;
                userAssignmentSelect.appendChild(option);
            });
        }
        if (inventoryUserSelect) {
            inventoryUserSelect.innerHTML = '<option value="">Seleccione usuario</option>';
            userData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.nombre;
                option.textContent = user.nombre;
                inventoryUserSelect.appendChild(option);
            });
        }
    }

    // FUNCIONES DE ASIGNACIONES
    async function loadAssignments() {
        try {
            const { data, error } = await supabase
                .from('conteoinventario')
                .select('*')
                .or('es_asignacion.eq.true,es_reconteo.eq.true') // Condición OR
                .order('fecha_actualizacion', { ascending: false });
            if (error) throw error;
            console.log('Asignaciones y reconteos:', data);
            updateAssignmentList(data);
        } catch (error) {
            console.error('Error al cargar asignaciones:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudieron cargar las asignaciones'
            });
        }
    }

    function updateAssignmentList(assignments) {
        const assignmentList = document.getElementById('assignment-list');
        if (!assignmentList) {
            console.error('No se encontró el tbody #assignment-list');
            return;
        }
        assignmentList.innerHTML = ''; // Limpiar contenido anterior

        if (!assignments || assignments.length === 0) {
            assignmentList.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">No hay asignaciones pendientes para conteo o reconteo</td></tr>';
            return;
        }

        assignments.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50';
            row.setAttribute('data-assignment-id', item.id); // Añadir ID como atributo de datos
            row.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-700">
                    <div>Rack ${item.rack}</div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    <div>${item.ubicacion}</div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.numero_parte}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.descripcion}</td>
                <td class="px-6 py-4 text-sm text-gray-700">${item.usuario_asignado}</td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    <input type="number" min="0" class="count-input w-20 px-2 py-1 border border-gray-300 rounded" placeholder="Cantidad">
                </td>
                <td class="px-6 py-4 text-sm">
                    <button onclick="registerCount(${item.id})" class="bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600">Registrar Conteo</button>
                </td>
            `;
            assignmentList.appendChild(row);
        });
    }

    window.registerCount = async function(id) {
        const row = document.querySelector(`tr[data-assignment-id="${id}"]`);
        if (!row) return;

        const countInput = row.querySelector('.count-input');
        const quantity = parseInt(countInput.value);

        if (!quantity || quantity <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ingresa una cantidad válida mayor a cero'
            });
            return;
        }

        try {
            const button = row.querySelector('button');
            button.disabled = true;
            button.textContent = 'Procesando...';

            // Actualizar el registro en Supabase
            const { error } = await supabase
                .from('conteoinventario')
                .update({
                    cantidad: quantity,
                    cantidad_contada: true, // Marcar como contado
                    es_asignacion: false, // Desmarcar como asignación pendiente
                    es_reconteo: false, // Desmarcar como reconteo
                    fecha_actualizacion: new Date().toISOString()
                })
                .eq('id', id);
            if (error) throw error;

            // Recargar los datos
            await loadAssignments();
            await loadInventoryData();
            Swal.fire({
                icon: 'success',
                title: 'Conteo registrado',
                text: 'La cantidad ha sido registrada correctamente',
                timer: 2000,
                showConfirmButton: false
            });
        } catch (error) {
            console.error('Error al registrar conteo:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo registrar el conteo'
            });
        } finally {
            const button = row.querySelector('button');
            button.disabled = false;
            button.textContent = 'Registrar Conteo';
        }
    };

    window.startCountingAssignment = async function(id) {
        const row = document.querySelector(`tr[data-assignment-id="${id}"]`);
        if (!row) return;

        const rack = row.cells[0].querySelector('div').textContent.replace('Rack ', '');
        const location = row.cells[1].querySelector('div').textContent;
        const partNumber = row.cells[2].textContent;
        const description = row.cells[3].textContent;
        const user = row.cells[4].textContent;

        // Marcar la fila como en proceso (opcional)
        row.classList.add('bg-gray-100');

        // Crear un objeto para el nuevo registro de conteo
        const newRecord = {
            rack: rack,
            location: location,
            user: user,
            partNumber: partNumber,
            description: description,
            quantity: 0 // Se inicializa en 0, se actualizará con el input
        };

        // Obtener la entrada de cantidad
        const countInput = row.querySelector('.count-input');
        const quantity = parseInt(countInput.value);

        if (!quantity || quantity <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ingresa una cantidad válida mayor a cero'
            });
            row.classList.remove('bg-gray-100');
            return;
        }

        newRecord.quantity = quantity;

        try {
            const button = row.querySelector('button');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Procesando...';

            await insertInventoryRecord(newRecord);
            countInput.value = '';
            await loadInventoryData(); // Recargar inventario general
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: 'Conteo registrado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
        } catch (error) {
            console.error('Error saving inventory record:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al guardar el registro de inventario'
            });
        } finally {
            row.classList.remove('bg-gray-100');
            const button = row.querySelector('button');
            button.disabled = false;
            button.textContent = 'Registrar Conteo';
        }
    };

    // Manejar el envío del formulario de números de inventario
    document.getElementById('inventory-numbers-form')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('inventory-numbers-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Procesando...';

        const formData = {
            inventario_id: document.getElementById('inventory-number').value,
            rack: document.getElementById('inventory-rack').value,
            location: document.getElementById('inventory-location').value,
            user: document.getElementById('inventory-user').value,
            quantity: parseInt(document.getElementById('inventory-quantity').value),
        };

        try {
            // Insertar en la tabla de conteo de inventario
            const { error } = await supabase
                .from('conteoinventario')
                .insert([
                    {
                        rack: formData.rack,
                        ubicacion: formData.location,
                        usuario_asignado: formData.user,
                        numero_parte: formData.inventario_id,
                        descripcion: document.querySelector(`#inventory-number option[value="${formData.inventario_id}"]`).textContent.split(' - ')[1],
                        cantidad: formData.quantity,
                        cantidad_contada: true,
                        es_asignacion: false,
                    }
                ]);
            if (error) throw error;

            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: 'Número de inventario registrado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
            this.reset();
            await loadInventoryData();
        } catch (error) {
            console.error('Error al registrar número de inventario:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo registrar el número de inventario'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Registrar Número de Inventario';
        }
    });

    // Manejar cierre de sesión
    document.getElementById('logout-btn')?.addEventListener('click', async function () {
        try {
            console.log('🚪 Cerrando sesión...');
            const { error } = await authSupabase.auth.signOut(); // Usar el cliente de autenticación
            if (error) throw error;
            console.log('✅ Sesión cerrada correctamente.');
            // Limpiar datos de sesión almacenados localmente si es necesario
            // sessionStorage.removeItem('currentUser'); // Si lo usaste
            // Redirigir al login
            window.location.href = 'login_completo.html';
        } catch (error) {
            console.error('Error al cerrar sesión:', error.message);
            Swal.fire('Error', 'No se pudo cerrar la sesión.', 'error');
        }
    });

    // INICIALIZACIÓN DEL DOCUMENTO (COMBINADO)
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🔐 Verificando sesión de usuario y cargando datos iniciales...');
        try {
            // --- 1. Verificar sesión de usuario ---
            const { data: { session }, error } = await authSupabase.auth.getSession();
            if (error) {
                console.error('Error obteniendo sesión:', error.message);
                window.location.href = 'login_completo.html';
                return;
            }
            if (!session) {
                console.warn('⚠️ No hay sesión activa. Redirigiendo al login...');
                window.location.href = 'login_completo.html';
                return;
            }
            console.log('✅ Usuario autenticado:', session.user.email);

            // --- 2. Verificar rol del usuario ---
            const { data: userDataFromDB, error: userError } = await supabase
                .from('users')
                .select('role')
                .eq('email', session.user.email)
                .single();

            if (userError || !userDataFromDB) {
                console.error('Error al obtener el rol del usuario:', userError);
                return;
            }

            // Aplicar clase al body según el rol
            if (userDataFromDB.role === 'admin') {
                document.body.classList.add('is-admin');
                console.log('✅ Usuario es administrador. Mostrando todas las opciones.');
            } else {
                document.body.classList.remove('is-admin');
                console.log('ℹ️ Usuario es "viewer". Restringiendo acceso a pestañas.');
            }

            // --- 3. Configurar pestañas según el rol ---
            const tabAdmin = document.getElementById('tab-admin');
            const tabInventory = document.getElementById('tab-inventory');
            const tabView = document.getElementById('tab-view');
            const tabInventoryNumbers = document.getElementById('tab-inventory-numbers');
            const tabBulkUpload = document.getElementById('tab-bulk-upload'); // Añadir esta línea

            const contentAdmin = document.getElementById('content-admin');
            const contentInventory = document.getElementById('content-inventory');
            const contentView = document.getElementById('content-view');
            const contentInventoryNumbers = document.getElementById('content-inventory-numbers');
            const contentBulkUpload = document.getElementById('content-bulk-upload'); // Añadir esta línea

            // Si el usuario es "viewer", ocultar las pestañas de admin
            if (userDataFromDB.role !== 'admin') {
                tabAdmin.style.display = 'none';
                tabInventory.style.display = 'none';
                tabInventoryNumbers.style.display = 'none'; // Añadir esta línea
                tabBulkUpload.style.display = 'none'; // Añadir esta línea
            }

            // --- 4. Mostrar la pestaña adecuada según el rol ---
            if (userDataFromDB.role === 'admin') {
                // Mostrar la pestaña de Administración por defecto
                showTab(tabAdmin, contentAdmin, [tabInventory, tabView, tabInventoryNumbers, tabBulkUpload], [contentInventory, contentView, contentInventoryNumbers, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
            } else {
                // Mostrar la pestaña de Vista de Asignaciones por defecto
                showTab(tabView, contentView, [tabAdmin, tabInventory, tabInventoryNumbers, tabBulkUpload], [contentAdmin, contentInventory, contentInventoryNumbers, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
                loadAssignments();
            }

            // --- 5. Configurar los eventos de clic para las pestañas ---
            tabAdmin?.addEventListener('click', function() {
                if (!document.body.classList.contains('is-admin')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Acceso denegado',
                        text: 'No tienes permiso para acceder a esta sección.',
                    });
                    return;
                }
                showTab(tabAdmin, contentAdmin, [tabInventory, tabView, tabInventoryNumbers, tabBulkUpload], [contentInventory, contentView, contentInventoryNumbers, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
            });
            tabInventory?.addEventListener('click', function() {
                if (!document.body.classList.contains('is-admin')) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Acceso denegado',
                        text: 'No tienes permiso para acceder a esta sección.',
                    });
                    return;
                }
                showTab(tabInventory, contentInventory, [tabAdmin, tabView, tabInventoryNumbers, tabBulkUpload], [contentAdmin, contentView, contentInventoryNumbers, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
            });
            tabView?.addEventListener('click', function() {
                showTab(tabView, contentView, [tabAdmin, tabInventory, tabInventoryNumbers, tabBulkUpload], [contentAdmin, contentInventory, contentInventoryNumbers, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
                loadAssignments();
            });
            tabInventoryNumbers?.addEventListener('click', function() {
                showTab(tabInventoryNumbers, contentInventoryNumbers, [tabAdmin, tabInventory, tabView, tabBulkUpload], [contentAdmin, contentInventory, contentView, contentBulkUpload]); // Añadir tabBulkUpload y contentBulkUpload
                loadInventoryNumbers();
                loadUserData();
            });
            tabBulkUpload?.addEventListener('click', function() { // Añadir este bloque
                showTab(tabBulkUpload, contentBulkUpload, [tabAdmin, tabInventory, tabView, tabInventoryNumbers], [contentAdmin, contentInventory, contentView, contentInventoryNumbers]); // Añadir tabBulkUpload y contentBulkUpload
                // Opcional: Limpiar el formulario y resultados anteriores
                document.getElementById('bulk-upload-form').reset();
                document.getElementById('upload-result').classList.add('hidden');
                document.getElementById('upload-messages').innerHTML = '';
            });

            // CONFIGURACIÓN DE PESTAÑAS (dentro del DOMContentLoaded)
            function setupLocationSelects(rackSelectId, locationSelectId) {
                const rackSelect = document.getElementById(rackSelectId);
                const locationSelect = document.getElementById(locationSelectId);
                rackSelect.addEventListener('change', function() {
                    locationSelect.innerHTML = '<option value="">Seleccione ubicación</option>';
                    const selectedRack = this.value;
                    if (selectedRack === 'AREA_KITEO') {
                        // Caso especial para AREA KITEO
                        const ubicacionesKiteo = ['area piking', 'area kiteo'];
                        ubicacionesKiteo.forEach(ubicacion => {
                            const option = document.createElement('option');
                            option.value = ubicacion; // O un ID único si prefieres
                            option.textContent = ubicacion;
                            locationSelect.appendChild(option);
                        });
                    } else if (selectedRack && rackLocations[selectedRack]) {
                        // Lógica original para los racks A-G
                        for (let i = 1; i <= rackLocations[selectedRack]; i++) {
                            const option = document.createElement('option');
                            // Formato: Rack-Ubicacion (e.g., A-1, B-12)
                            option.value = `${selectedRack}-${i}`;
                            option.textContent = `${selectedRack}-${i}`;
                            locationSelect.appendChild(option);
                        }
                    }
                    // Si no se selecciona nada o rack no reconocido, deja solo la opción por defecto
                });
            }

            // Configurar ambos pares de selects
            setupLocationSelects('rack', 'location');
            setupLocationSelects('rack-assignment', 'location-assignment');
            setupLocationSelects('inventory-rack', 'inventory-location');

            // FORMULARIO DE INVENTARIO
            document.getElementById('inventory-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('submit-btn');
                const submitText = document.getElementById('submit-text');
                const submitLoader = document.getElementById('submit-loader');
                // Mostrar loading
                submitText.textContent = 'Procesando...';
                submitLoader.classList.remove('hidden');
                submitBtn.disabled = true;
                const formData = {
                    rack: document.getElementById('rack').value,
                    location: document.getElementById('location').value,
                    user: document.getElementById('user').value,
                    partNumber: document.getElementById('part-number').value,
                    description: document.getElementById('description').value,
                    quantity: parseInt(document.getElementById('quantity').value)
                };
                try {
                    await insertInventoryRecord(formData);
                    await loadInventoryData();
                    this.reset();
                    Swal.fire({
                        icon: 'success',
                        title: 'Éxito',
                        text: 'Conteo registrado correctamente',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo guardar el registro: ' + error.message
                    });
                } finally {
                    submitText.textContent = 'Registrar Conteo';
                    submitLoader.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            });

            // FORMULARIO DE REGISTRO DE USUARIOS
            document.getElementById('user-register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const userName = document.getElementById('new-user-name').value;
                const userArea = document.getElementById('new-user-area').value;
                if (userName && userArea) {
                    try {
                        const newUser = {
                            nombre: userName,
                            puesto: userArea
                        };
                        await insertUser(newUser);
                        await loadUserData();
                        this.reset();
                        Swal.fire({
                            icon: 'success',
                            title: 'Usuario Registrado',
                            text: 'El usuario ha sido agregado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo registrar el usuario'
                        });
                    }
                }
            });

            // FORMULARIO DE ASIGNACIONES
            document.getElementById('assignment-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const user = document.getElementById('user-assignment').value.trim();
                const rack = document.getElementById('rack-assignment').value.trim();
                const location = document.getElementById('location-assignment').value.trim();
                const partNumber = document.getElementById('part-number-assignment').value.trim();
                const esAsignacion = document.querySelector('input[name="es_asignacion"]:checked').value === 'true';
                console.log('Usuario:', user);
                console.log('Rack:', rack);
                console.log('Ubicación:', location);
                console.log('Número de parte:', partNumber);
                console.log('¿Es asignación pendiente?:', esAsignacion);
                if (!user || !rack || !location || !partNumber) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Todos los campos son obligatorios'
                    });
                    return;
                }
                const description = await getPartDescription(partNumber);
                console.log('Descripción:', description);
                try {
                    const { error } = await supabase
                        .from('conteoinventario')
                        .insert([
                            {
                                rack: rack,
                                ubicacion: location,
                                usuario_asignado: user,
                                numero_parte: partNumber,
                                descripcion: description,
                                cantidad: 0,
                                cantidad_contada: false,
                                es_asignacion: true
                            }
                        ]);
                    if (error) throw error;
                    Swal.fire({
                        icon: 'success',
                        title: 'Asignación registrada',
                        text: `Se asignó a ${user} para contar el rack ${rack}, ubicación ${location}, parte ${partNumber}`,
                        confirmButtonColor: '#0a192f'
                    });
                    await loadAssignments();
                    this.reset();
                } catch (error) {
                    console.error('Error al registrar asignación:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo registrar la asignación'
                    });
                }
            });

            // CARGAR DATOS INICIALES
            loadInventoryData();
            loadUserData();
            // CARGAR NÚMEROS DE PARTE PARA AUTOCOMPLETAR
            loadPartNumbers('part-number-list');
            loadPartNumbers('part-number-list-assignment');

            // AUTOCOMPLETAR DESCRIPCIÓN AL SELECCIONAR NÚMERO DE PARTE
            document.getElementById('part-number').addEventListener('blur', async function() {
                const partNumber = this.value.trim();
                if (partNumber) {
                    const description = await getPartDescription(partNumber);
                    if (!description) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Número de parte no encontrado',
                            text: 'El número de parte ingresado no existe en la base de datos.',
                        });
                        document.getElementById('description').value = '';
                    } else {
                        document.getElementById('description').value = description;
                    }
                }
            });

            // Event Listeners para filtros
            document.getElementById('filter-user').addEventListener('input', filterInventoryRecords);
            document.getElementById('filter-part').addEventListener('input', filterInventoryRecords);
            document.getElementById('clear-filters-btn').addEventListener('click', function() {
                document.getElementById('filter-user').value = '';
                document.getElementById('filter-part').value = '';
                filterInventoryRecords();
            });

            // Event Listeners para exportar
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);

            // Event Listeners para autocompletar
            document.getElementById('part-number-assignment').addEventListener('blur', async function() {
                const partNumber = this.value.trim();
                if (partNumber) {
                    const description = await getPartDescription(partNumber);
                    if (!description) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Número de parte no encontrado',
                            text: 'El número de parte ingresado no existe en la base de datos.',
                        });
                        document.getElementById('description').value = '';
                    }
                }
            });

            // --- 6. Cargar datos iniciales ---
            loadInventoryData();
            loadUserData();
            loadPartNumbers('part-number-list');
            loadPartNumbers('part-number-list-assignment');

        } catch (err) {
            console.error('Error inesperado al cargar la página:', err);
            Swal.fire('Error', 'Ocurrió un error al cargar la aplicación.', 'error');
        }
    }); // <-- CIERRE DEL ÚNICO document.addEventListener('DOMContentLoaded', ...)

    // --- Función para Carga Masiva ---
    async function handleBulkUpload(file) {
        const resultDiv = document.getElementById('upload-result');
        const messagesDiv = document.getElementById('upload-messages');
        const submitBtn = document.getElementById('upload-submit-btn');
        let successCount = 0;
        let errorCount = 0;
        let messages = [];

        resultDiv.classList.remove('hidden');
        messagesDiv.innerHTML = '<p class="text-blue-500">Procesando archivo...</p>';
        submitBtn.disabled = true;

        try {
            const data = await readFileAsArrayBuffer(file);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);

            if (jsonData.length === 0) {
                messages.push('<p class="text-yellow-500">Advertencia: El archivo está vacío o no tiene filas de datos.</p>');
                messagesDiv.innerHTML = messages.join('');
                return;
            }

            // Validar columnas
            const requiredHeaders = ['Rack', 'Ubicación', 'Número de Parte', 'Descripción', 'Usuario Asignado']; // Ajusta según las columnas exactas de tu Excel
            const fileHeaders = Object.keys(jsonData[0]).map(h => h.trim()); // Quitar espacios en blanco
            console.log('Headers encontrados en el archivo:', fileHeaders); // Debug

            const missingHeaders = requiredHeaders.filter(header => !fileHeaders.includes(header));
            if (missingHeaders.length > 0) {
                messages.push(`<p class="text-red-500">Error: Faltan las siguientes columnas obligatorias: ${missingHeaders.join(', ')}</p>`);
                messagesDiv.innerHTML = messages.join('');
                return;
            }

            // Procesar filas
            for (let i = 0; i < jsonData.length; i++) {
                const row = jsonData[i];
                let rowSuccess = true;
                let errorMsg = '';

                // Mapear columnas del Excel a las del objeto de Supabase
                // Asegúrate de que los nombres coincidan exactamente con las claves de tu objeto y Supabase
                const rack = row['Rack']?.toString().trim();
                const ubicacion = row['Ubicación']?.toString().trim();
                const numeroParte = row['Número de Parte']?.toString().trim();
                const descripcion = row['Descripción']?.toString().trim();
                const usuarioAsignado = row['Usuario Asignado']?.toString().trim();

                // Validaciones básicas
                if (!rack || !ubicacion || !numeroParte || !descripcion || !usuarioAsignado) {
                    errorMsg = `Fila ${i + 2}: Uno o más campos obligatorios están vacíos.`;
                    rowSuccess = false;
                } else if (rack.length !== 1 && rack !== 'AREA_KITEO') { // Ajusta según tus reglas de rack
                    errorMsg = `Fila ${i + 2}: El Rack '${rack}' no es válido.`;
                    rowSuccess = false;
                }

                if (rowSuccess) {
                    try {
                        // Buscar descripción si no se proporcionó o está vacía (opcional, dependiendo de tu flujo)
                        // if (!descripcion) {
                        //    const descFromDB = await getPartDescription(numeroParte);
                        //    if (descFromDB) {
                        //        descripcion = descFromDB;
                        //    } else {
                        //        errorMsg = `Fila ${i + 2}: Número de parte '${numeroParte}' no encontrado en la base de datos.`;
                        //        rowSuccess = false;
                        //    }
                        // }
                        if (rowSuccess) {
                            // Insertar en Supabase
                            const { error } = await supabase
                                .from('conteoinventario')
                                .insert([
                                    {
                                        rack: rack,
                                        ubicacion: ubicacion,
                                        numero_parte: numeroParte,
                                        descripcion: descripcion,
                                        usuario_asignado: usuarioAsignado,
                                        cantidad: 0, // Se deja en 0 para que sea contado
                                        cantidad_contada: false, // Se marca como no contado
                                        es_asignacion: true, // Se marca como asignación pendiente
                                        es_reconteo: false, // No es reconteo
                                        fecha_actualizacion: new Date().toISOString()
                                    }
                                ]);

                            if (error) {
                                throw error; // Lanza el error para que sea capturado por el catch del bucle
                            }
                            successCount++;
                        }
                    } catch (insertError) {
                        console.error('Error al insertar fila:', i + 2, insertError);
                        errorMsg = `Fila ${i + 2}: Error al insertar en la base de datos: ${insertError.message}`;
                        rowSuccess = false;
                    }
                }

                if (!rowSuccess) {
                    errorCount++;
                    messages.push(`<p class="text-red-500">${errorMsg}</p>`);
                }
            }

            // Mostrar resultados finales
            messages.unshift(`<p class="text-green-500">Carga completada. Éxito: ${successCount}, Errores: ${errorCount}</p>`);
            messagesDiv.innerHTML = messages.join('');
            console.log(`Carga masiva finalizada. Éxito: ${successCount}, Errores: ${errorCount}`);

            // Opcional: Recargar la vista de asignaciones si se insertaron registros exitosos
            if (successCount > 0) {
                await loadAssignments();
                await loadInventoryData(); // Tambien recargar el inventario general
            }

        } catch (error) {
            console.error('Error general al procesar el archivo:', error);
            messagesDiv.innerHTML = `<p class="text-red-500">Error general: ${error.message}</p>`;
        } finally {
            submitBtn.disabled = false;
        }
    }

    // --- Función auxiliar para leer archivo ---
    function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsArrayBuffer(file);
        });
    }

    // Añadir evento para el formulario de carga masiva (fuera del DOMContentLoaded, pero se ejecutará cuando el DOM esté listo)
    document.addEventListener('DOMContentLoaded', function() { // <-- Nuevo listener solo para el evento del formulario
        document.getElementById('bulk-upload-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('excel-file');
            if (fileInput.files.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Archivo no seleccionado',
                    text: 'Por favor, selecciona un archivo Excel para subir.'
                });
                return;
            }
            const file = fileInput.files[0];
            if (!['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'].includes(file.type)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Tipo de archivo no válido',
                    text: 'Por favor, selecciona un archivo Excel (.xlsx o .xls).'
                });
                return;
            }
            await handleBulkUpload(file);
        });
    }); // <-- Cierre del listener del formulario

 </script> <!-- AÑADIR ESTA ETIQUETA -->
</body>
</html>
