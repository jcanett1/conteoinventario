<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Conteo de Inventario PXG</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style id="app-style">
    /* ============================================ */
    /* ESTILOS MEJORADOS PARA GRID DE N√öMEROS DE PARTE */
    /* ============================================ */
    
    /* Estilos para cada item del grid */
    .part-number-grid-item {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1.5px solid #e5e7eb;
      background: white;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      min-height: 42px;
    }
    
    .part-number-grid-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.4);
      z-index: 10;
    }
    
    .part-number-grid-item:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 5px 15px -3px rgba(102, 126, 234, 0.3);
    }
    
    /* Efecto de brillo al pasar el mouse */
    .part-number-grid-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .part-number-grid-item:hover::before {
      left: 100%;
    }
    
    /* Grid responsive con m√∫ltiples columnas */
    .part-number-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    
    /* Pantallas peque√±as (sm: 640px+) - 3 columnas */
    @media (min-width: 640px) {
      .part-number-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    
    /* Tablets (md: 768px+) - 4 columnas */
    @media (min-width: 768px) {
      .part-number-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    
    /* Laptops (lg: 1024px+) - 6 columnas */
    @media (min-width: 1024px) {
      .part-number-grid {
        grid-template-columns: repeat(6, minmax(0, 1fr));
      }
    }
    
    /* Pantallas grandes (xl: 1280px+) - 8 columnas */
    @media (min-width: 1280px) {
      .part-number-grid {
        grid-template-columns: repeat(8, minmax(0, 1fr));
      }
    }
    
    /* Pantallas extra grandes (2xl: 1536px+) - 10 columnas */
    @media (min-width: 1536px) {
      .part-number-grid {
        grid-template-columns: repeat(10, minmax(0, 1fr));
      }
    }
    
    /* Scroll suave */
    .smooth-scroll {
      scroll-behavior: smooth;
    }
    
    /* Barra de scroll personalizada */
    .custom-scrollbar::-webkit-scrollbar {
      width: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      border: 2px solid #f1f5f9;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #5568d3 0%, #653a8b 100%);
    }
    
    /* Animaci√≥n de carga */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .part-number-grid-item {
      animation: fadeIn 0.3s ease-out;
    }
/* Ocultar elementos exclusivos del administrador por defecto */
.admin-only {
    display: none !important;
}

/* Mostrar elementos exclusivos del administrador si el usuario es admin */
.is-admin .admin-only {
    display: block !important;
}
    
    .bg-navy {
      background-color: #0a192f;
    }
    .text-navy {
      color: #0a192f;
    }
    .border-navy {
      border-color: #0a192f;
    }
    .hover-bg-navy:hover {
      background-color: #0a192f;
      color: white;
    }
    .transition-all {
      transition: all 0.3s ease;
    }
    .custom-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .table-hover tr:hover {
      background-color: #f9fafb;
    }
    body {
      font-family: 'Inter', sans-serif;
    }
    .loader {
      border-top-color: #0a192f;
      animation: spinner 1.5s linear infinite;
    }
    @keyframes spinner {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .cursor-pointer {
      cursor: pointer;
    }
    th.cursor-pointer:hover {
      background-color: #e5e7eb !important;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-navy shadow-md">
    <div class="container mx-auto px-4 py-5">
      <div class="flex justify-between items-center">
        <div class="flex items-center">
          <i class="fas fa-warehouse text-white text-3xl mr-3"></i>
          <h1 class="text-2xl font-bold text-white">Sistema de Conteo de Inventario PXG</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="user-info" class="text-white text-sm">
            <span id="user-name" class="font-medium"></span>
            <span id="user-role" class="text-gray-300 ml-2"></span>
          </div>
          <button id="logout-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded-md text-sm transition-all">
            <i class="fas fa-sign-out-alt mr-1"></i>Cerrar Sesi√≥n
          </button>
         
        </div>
      </div>
    </div>
  </header>

  <!-- Tab navigation -->
  <div class="flex border-b border-gray-200">
    <button id="tab-admin" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
      <i class="fas fa-cog"></i> Administraci√≥n
    </button>
    <button id="tab-inventory" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
      <i class="fas fa-boxes"></i> Conteo de Inventario
    </button>
    <button id="tab-view" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
      <i class="fas fa-tasks"></i> Vista de Asignaciones
    </button>
    <button id="tab-inventory-numbers" class="px-4 py-2 text-gray-500 font-medium hover:text-navy">
      <i class="fas fa-list"></i> Registro
    </button>
    <button id="tab-bulk-upload" class="px-4 py-2 text-gray-500 font-medium hover:text-navy admin-only">
      <i class="fas fa-file-upload"></i> Carga Masiva
    </button>
  </div>

  <!-- Modal de Selecci√≥n de N√∫meros de Parte -->
    <div id="part-number-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-900">Seleccionar N√∫mero de Parte</h3>
                <button onclick="closePartNumberModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mt-4">
                <input type="text" id="part-number-search" onkeyup="filterPartNumbers()" placeholder="Buscar n√∫mero de parte..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <p class="text-sm text-gray-600 mb-3"><span id="part-number-count">0</span> n√∫meros de parte encontrados</p>
                <div id="part-number-grid-container" class="grid part-number-grid gap-3 max-h-96 overflow-y-auto custom-scrollbar p-2 border border-gray-200 rounded-md">
                    <!-- Los n√∫meros de parte se cargar√°n aqu√≠ -->
                </div>
            </div>
            <div class="mt-5 text-right">
                <button onclick="closePartNumberModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancelar</button>
            </div>
        </div>
    </div>
    <!-- Main Content -->
  <main class="container mx-auto px-4 py-6">
    <!-- Tab 1: Administraci√≥n -->
    <div id="content-admin" class="block">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Left Column - User Assignment Form -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Asignaci√≥n de Usuario para Conteo</h2>
          <form id="assignment-form" class="space-y-4">
            <div>
              <label for="user-assignment" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input type="text" id="user-assignment" name="user-assignment" list="user-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
               <datalist id="user-list"> </datalist>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="rack-assignment" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack-assignment" name="rack-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                </select>
              </div>
              <div>
                <label for="location-assignment" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                <select id="location-assignment" name="location-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicaci√≥n</option>
                </select>
              </div>
            </div>
            <div>
              <label for="part-number-assignment" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
              <input type="text" id="part-number-assignment" name="part-number-assignment" list="part-number-list-assignment" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese n√∫mero de parte">
              <datalist id="part-number-list-assignment"></datalist>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">¬øEs una asignaci√≥n pendiente?</label>
              <div class="flex items-center space-x-4">
                <label class="flex items-center">
                  <input type="radio" name="es_asignacion" value="true" checked class="mr-2">
                  S√≠
                </label>
                <label class="flex items-center">
                  <input type="radio" name="es_asignacion" value="false" class="mr-2">
                  No
                </label>
              </div>
            </div>
            <div class="pt-2">
              <button type="submit" id="assignment-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
                Asignar Usuario
              </button>
            </div>
          </form>
        </div>

        <!-- Right Column - User Registration -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de Usuarios para Conteo</h2>
          <form id="user-register-form" class="mb-6 flex items-end space-x-2">
            <div class="flex-1">
              <label for="new-user-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
              <input type="text" id="new-user-name" name="new-user-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre del usuario">
            </div>
            <div class="flex-1">
              <label for="new-user-email" class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
              <input type="email" id="new-user-email" name="new-user-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="correo@empresa.com">
            </div>
            <button type="submit" class="bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Registrar Usuario
            </button>
          </form>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-hover">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correo</th>
                </tr>
              </thead>
              <tbody id="user-registry" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 2: Conteo de Inventario -->
    <div id="content-inventory" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
        <!-- Formulario de Registro Manual -->
        <div class="md:col-span-6 bg-white rounded-lg shadow-md p-6">
          <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro Manual de Inventario</h2>
          <form id="inventory-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
                <select id="rack" name="rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione un Rack</option>
                </select>
              </div>
              <div>
                <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n</label>
                <select id="location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <option value="">Seleccione ubicaci√≥n</option>
                </select>
              </div>
            </div>
            <div>
              <label for="user" class="block text-sm font-medium text-gray-700 mb-1">Usuario Asignado</label>
              <input type="text" id="user" name="user" list="user-list-inventory" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
              <datalist id="user-list-inventory"></datalist>
            </div>
            <div>
              <label for="part-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
              <input type="text" id="inventory-part-number" name="numero_parte" list="part-number-list" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o escriba n√∫mero de parte" oninput="handlePartNumberChange()">
              <datalist id="part-number-list"></datalist>
            </div>
            <div>
              <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
              <input type="text" id="description" name="description" required readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none" placeholder="La descripci√≥n aparecer√° autom√°ticamente">
            </div>
            <div>
              <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input type="number" id="quantity" name="quantity" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad contada">
            </div>
            <div class="pt-2">
              <button type="submit" id="inventory-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
                Registrar Inventario
              </button>
            </div>
          </form>
        </div>

        <!-- Resumen por Rack -->
        <div class="md:col-span-6">
          <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Resumen por Rack</h2>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-hover">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total √çtems</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Actualizaci√≥n</th>
                  </tr>
                </thead>
                <tbody id="rack-summary-body" class="bg-white divide-y divide-gray-200">
                  <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Conteo por Usuario -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Conteo por Usuario</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√çtems Contados</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad Total</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√öltimo Conteo</th>
              </tr>
            </thead>
            <tbody id="user-summary" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Cargando datos...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Botones de Exportaci√≥n y Filtros -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <div class="flex flex-col space-y-4">
          <!-- Botones de Exportaci√≥n -->
          <div class="flex space-x-2">
            <button id="export-inventory-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-all">
              <i class="fas fa-file-excel mr-2"></i>Exportar a Excel
            </button>
            <button id="export-inventory-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
              <i class="fas fa-file-pdf mr-2"></i>Exportar a PDF
            </button>
          </div>

          <!-- Filtros -->
          <div class="flex flex-col md:flex-row md:items-center md:space-x-4">
            <!-- Filtro por Usuario -->
            <div class="flex-1 mb-2 md:mb-0">
              <label for="filter-user" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Usuario</label>
              <input type="text" id="filter-user" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Alan Ramos">
            </div>

            <!-- Filtro por N√∫mero de Parte -->
            <div class="flex-1 mb-2 md:mb-0">
              <label for="filter-part" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por N√∫mero de Parte</label>
              <input type="text" id="filter-part" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: ABC123">
            </div>

            <!-- Bot√≥n para limpiar filtros -->
            <div class="flex items-end mb-2 md:mb-0">
              <button id="clear-filters-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition-all h-10">
                <i class="fas fa-times mr-2"></i>Limpiar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Registros de Inventario -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registros de Inventario</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rack</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicaci√≥n Te√≥rica</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicaci√≥n Real</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
              <tr>
                <td colspan="10" class="px-6 py-4 text-center text-sm text-gray-500">Cargando registros...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab 3: Vista de Asignaciones -->
    <div id="content-view" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-navy border-b pb-2">Vista de Asignaciones</h2>
          <div class="flex space-x-2">
            <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md transition-all">
              <i class="fas fa-file-excel mr-2"></i>Exportar Excel
            </button>
            <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md transition-all">
              <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
            </button>
          </div>
        </div>
        <div class="mb-4">
          <input type="text" id="search-filter" placeholder="Buscar por usuario, rack, ubicaci√≥n o n√∫mero de parte..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 table-hover">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortAssignmentsTable('rack')">
                  Rack <i id="sort-icon-rack" class="fas fa-sort ml-1"></i>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortAssignmentsTable('ubicacion')">
                  Ubicaci√≥n Te√≥rica <i id="sort-icon-ubicacion" class="fas fa-sort ml-1"></i>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N√∫mero de Parte</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci√≥n</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicaci√≥n Real</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              </tr>
            </thead>
            <tbody id="assignments-table" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab 4: N√∫meros de Inventario -->
    <div id="content-inventory-numbers" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Registro de N√∫meros de Inventario</h2>
        <form id="inventory-numbers-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div>
              <label for="inventory-part-number" class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Parte</label>
              <input type="text" id="inventory-numbers-part-number" name="numero_parte" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer" placeholder="Seleccione n√∫mero de parte" readonly onclick="openPartNumberModal()">
              <datalist id="part-number-list-inventory-numbers"></datalist>
            </div>
             <div>
            <label for="inventory-description" class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
            <input type="text" id="inventory-description" name="inventory-description" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none" placeholder="La descripci√≥n aparecer√° autom√°ticamente">
          </div>
            <div>
              <label for="inventory-rack" class="block text-sm font-medium text-gray-700 mb-1">Rack</label>
              <select id="inventory-rack" name="inventory-rack" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione un Rack</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="inventory-location" class="block text-sm font-medium text-gray-700 mb-1">Ubicaci√≥n Real</label>
              <select id="inventory-location" name="inventory-location" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Seleccione ubicaci√≥n</option>
              </select>
            </div>
      
          </div>
         
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="inventory-user" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
              <input type="text" id="inventory-user" name="inventory-user" list="user-list-inventory-numbers" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Seleccione o ingrese usuario">
              <datalist id="user-list-inventory-numbers"></datalist>
            </div>
            <div>
              <label for="inventory-quantity" class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
              <input type="number" id="inventory-quantity" name="inventory-quantity" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ingrese cantidad">
            </div>
          </div>
          <div class="pt-2">
            <button type="submit" id="inventory-numbers-submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Registrar N√∫mero de Inventario
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Tab 5: Carga Masiva -->
    <div id="content-bulk-upload" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4 text-navy border-b pb-2">Carga Masiva de Asignaciones</h2>
        <form id="bulk-upload-form" class="space-y-4">
          <div>
            <label for="excel-file" class="block text-sm font-medium text-gray-700 mb-1">Archivo Excel</label>
            <input type="file" id="excel-file" name="excel-file" accept=".xlsx,.xls" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p class="text-sm text-gray-500 mt-1">Seleccione un archivo Excel (.xlsx o .xls) con las columnas: Rack, Ubicaci√≥n, N√∫mero de Parte, Descripci√≥n, Usuario Asignado</p>
          </div>
          <div class="pt-2">
            <button type="submit" id="upload-submit-btn" class="w-full bg-navy text-white py-2 px-4 rounded-md hover:bg-opacity-90 transition-all">
              Cargar Archivo
            </button>
          </div>
        </form>
        <div id="upload-result" class="mt-6 hidden">
          <h3 class="text-lg font-semibold mb-2">Resultados de la Carga</h3>
          <div id="upload-messages" class="space-y-2"></div>
        </div>
      </div>
    </div>
  </main>

<script>
// Configuraci√≥n de Supabase
const supabaseUrl = 'https://bdrxcilsuxbkpmolfbgu.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcnhjaWxzdXhia3Btb2xmYmd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNTQ0NTcsImV4cCI6MjA2OTgzMDQ1N30.iSO9EoOMEoi_VARxPqMd2yMUvQvTmKJntxJvwAl-TVs';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Variables globales
let currentUser = null;
let isAdmin = false;

// Inicializaci√≥n cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', async function() {
    console.log('DOM cargado, iniciando aplicaci√≥n...');
    
    // Verificar autenticaci√≥n
    await checkAuthentication();
    
    // Configurar pesta√±as
    setupTabs();
    
    // Cargar datos iniciales
    await loadInitialData();
    
    // Configurar event listeners
    setupEventListeners();
    
    console.log('Aplicaci√≥n inicializada correctamente');
});

// Funci√≥n para verificar autenticaci√≥n
async function checkAuthentication() {
    try {
        console.log('üîç Verificando autenticaci√≥n...');
        
        // Obtener sesi√≥n actual
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('Error obteniendo sesi√≥n:', error);
            redirectToLogin();
            return;
        }
        
        if (!session) {
            console.log('‚ùå No hay sesi√≥n activa, redirigiendo al login');
            redirectToLogin();
            return;
        }
        
        console.log('‚úÖ Sesi√≥n activa encontrada para:', session.user.email);
        
        // Obtener datos del usuario desde la tabla users
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('email', session.user.email)
            .single();
        
        if (userError || !userData) {
            console.error('Error obteniendo datos del usuario:', userError);
            redirectToLogin();
            return;
        }
        
        // Configurar usuario actual
        currentUser = userData;
        isAdmin = userData.role === 'admin';
        
        // Configurar usuario de conteo vinculado
        currentUser.usuarioConteoVinculado = userData.usuario_conteo_vinculado || userData.full_name;
        
        console.log('üë§ Usuario autenticado:', userData.full_name, '- Rol:', userData.role);
        console.log('üîó Usuario de conteo vinculado:', currentUser.usuarioConteoVinculado);
        
        // Actualizar UI seg√∫n el rol
        updateUIForUser();
        
        // Configurar listener para cambios de autenticaci√≥n
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                redirectToLogin();
            }
        });
        
    } catch (error) {
        console.error('Error en verificaci√≥n de autenticaci√≥n:', error);
        redirectToLogin();
    }
}

// Funci√≥n para actualizar UI seg√∫n el usuario
function updateUIForUser() {
    // Mostrar informaci√≥n del usuario en el header
    const userNameElement = document.getElementById('user-name');
    const userRoleElement = document.getElementById('user-role');
    
    if (userNameElement) {
        userNameElement.textContent = currentUser.full_name;
    }
    
    if (userRoleElement) {
        const roleText = isAdmin ? '(Administrador)' : '(Usuario)';
        userRoleElement.textContent = roleText;
    }
    
    // Mostrar/ocultar elementos seg√∫n el rol
    if (isAdmin) {
        document.body.classList.add('is-admin');
        console.log('üîß Mostrando elementos de administrador');
    } else {
        document.body.classList.remove('is-admin');
        console.log('üëÅÔ∏è Ocultando elementos de administrador');
        
        // Para usuarios no admin, mostrar solo Vista de Asignaciones
        setTimeout(() => {
            const viewTab = document.getElementById('tab-view');
            if (viewTab) {
                viewTab.click();
            }
        }, 100);
    }
}

// Funci√≥n para redirigir al login
function redirectToLogin() {
    console.log('üîÑ Redirigiendo al login...');
    window.location.href = 'login_completo.html';
}

// Configuraci√≥n de pesta√±as
function setupTabs() {
    const tabs = {
        'tab-admin': 'content-admin',
        'tab-inventory': 'content-inventory',
        'tab-view': 'content-view',
        'tab-inventory-numbers': 'content-inventory-numbers',
        'tab-bulk-upload': 'content-bulk-upload'
    };

    Object.keys(tabs).forEach(tabId => {
        const tabButton = document.getElementById(tabId);
        if (tabButton) {
            tabButton.addEventListener('click', () => {
                // Ocultar todos los contenidos
                Object.values(tabs).forEach(contentId => {
                    const content = document.getElementById(contentId);
                    if (content) content.classList.add('hidden');
                });
                
                // Remover clase activa de todas las pesta√±as
                Object.keys(tabs).forEach(id => {
                    const tab = document.getElementById(id);
                    if (tab) tab.classList.remove('text-navy', 'border-b-2', 'border-navy');
                });
                
                // Mostrar contenido seleccionado
                const targetContent = document.getElementById(tabs[tabId]);
                if (targetContent) targetContent.classList.remove('hidden');
                
                // Activar pesta√±a seleccionada
                tabButton.classList.add('text-navy', 'border-b-2', 'border-navy');
            });
        }
    });
    
    // Activar primera pesta√±a por defecto seg√∫n el rol
    if (isAdmin) {
        const firstTab = document.getElementById('tab-admin');
        if (firstTab) firstTab.click();
    } else {
        const viewTab = document.getElementById('tab-view');
        if (viewTab) viewTab.click();
    }
}

// Cargar datos iniciales
async function loadInitialData() {
    console.log('üîÑ [DEBUG] Iniciando carga de datos iniciales...');
    console.log('üîÑ [DEBUG] currentUser al inicio:', currentUser);
    console.log('üîÑ [DEBUG] isAdmin al inicio:', isAdmin);
    
    await loadUserData();
    await loadPartNumbers('part-number-list-assignment');
    await loadPartNumbers('part-number-list');
    await loadPartNumbers('part-number-list-inventory-numbers');
    await loadAllRacks();
    
    console.log('üîÑ [DEBUG] Antes de loadAssignments - currentUser:', currentUser);
    console.log('üîÑ [DEBUG] Antes de loadAssignments - isAdmin:', isAdmin);
    await loadAssignments();
    
    await loadInventoryData();
    await loadInventoryNumbers();
    await loadRacksFromDatabase(); // Cargar racks para inventory-rack
    setCurrentUserInInventoryForm(); // Autoseleccionar usuario en formulario de n√∫meros de inventario
    
    console.log('‚úÖ [DEBUG] Carga de datos iniciales completada');
}

// Configurar event listeners
function setupEventListeners() {
    // Formulario de asignaci√≥n
    const assignmentForm = document.getElementById('assignment-form');
    if (assignmentForm) {
        assignmentForm.addEventListener('submit', handleAssignmentSubmit);
    }
    
    // Formulario de registro de usuario
    const userRegisterForm = document.getElementById('user-register-form');
    if (userRegisterForm) {
        userRegisterForm.addEventListener('submit', handleUserRegister);
    }
    
    // Formulario de inventario
    const inventoryForm = document.getElementById('inventory-form');
    if (inventoryForm) {
        inventoryForm.addEventListener('submit', handleInventorySubmit);
    }
    
    // Formulario de n√∫meros de inventario
    const inventoryNumbersForm = document.getElementById('inventory-numbers-form');
    if (inventoryNumbersForm) {
        inventoryNumbersForm.addEventListener('submit', handleInventoryNumbersSubmit);
    }
    
    // Formulario de carga masiva
    const bulkUploadForm = document.getElementById('bulk-upload-form');
    if (bulkUploadForm) {
        bulkUploadForm.addEventListener('submit', handleBulkUploadSubmit);
    }
    
    // Botones de exportaci√≥n
    const exportExcelBtn = document.getElementById('export-excel-btn');
    if (exportExcelBtn) {
        exportExcelBtn.addEventListener('click', exportToExcel);
    }
    
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    if (exportPdfBtn) {
        exportPdfBtn.addEventListener('click', exportToPDF);
    }
    
    // Filtro de b√∫squeda
    const searchFilter = document.getElementById('search-filter');
    if (searchFilter) {
        searchFilter.addEventListener('input', filterAssignments);
    }
    
    
    
    // Bot√≥n de cerrar sesi√≥n
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }
    
    // Listener para cambios en rack (asignaci√≥n)
    const rackAssignment = document.getElementById('rack-assignment');
    if (rackAssignment) {
        rackAssignment.addEventListener('change', handleRackAssignmentChange);
    }
    
    // Listener para cambios en rack (inventario)
    const rack = document.getElementById('rack');
    if (rack) {
        rack.addEventListener('change', handleRackChange);
    }
    
    // Listener para cambios en rack (n√∫meros de inventario)
    const inventoryRack = document.getElementById('inventory-rack');
    if (inventoryRack) {
        inventoryRack.addEventListener('change', handleInventoryRackChange);
    }
    
    // Listener para n√∫mero de parte en asignaci√≥n
    const partNumberAssignmentInput = document.getElementById('part-number-assignment');
    if (partNumberAssignmentInput) {
        partNumberAssignmentInput.addEventListener('blur', handlePartNumberAssignmentBlur);
    }
    
    // Listener para n√∫mero de parte en inventario manual
    const partNumberInventoryInput = document.getElementById('part-number');
    if (partNumberInventoryInput) {
        partNumberInventoryInput.addEventListener('blur', handlePartNumberInventoryBlur);
    }
    
    // Listener para n√∫mero de parte en n√∫meros de inventario
    const partNumberInventoryNumbersInput = document.getElementById('inventory-part-number');
    if (partNumberInventoryNumbersInput) {
        partNumberInventoryNumbersInput.addEventListener('blur', handlePartNumberInventoryNumbersBlur);
    }
    
    // Listeners para filtros de inventario
    const filterUser = document.getElementById('filter-user');
    const filterPart = document.getElementById('filter-part');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    
    if (filterUser) {
        filterUser.addEventListener('input', applyInventoryFilters);
    }
    if (filterPart) {
        filterPart.addEventListener('input', applyInventoryFilters);
    }
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearInventoryFilters);
    }
    
    // Listeners para botones de exportaci√≥n de inventario
    const exportInventoryExcelBtn = document.getElementById('export-inventory-excel-btn');
    const exportInventoryPdfBtn = document.getElementById('export-inventory-pdf-btn');
    
    if (exportInventoryExcelBtn) {
        exportInventoryExcelBtn.addEventListener('click', exportInventoryToExcel);
    }
    if (exportInventoryPdfBtn) {
        exportInventoryPdfBtn.addEventListener('click', exportInventoryToPDF);
    }
}

// Funciones de manejo de eventos
async function handleAssignmentSubmit(e) {
    e.preventDefault();
const formData = new FormData(e.target);
    
    const partNumber = formData.get('part-number-assignment');
    let descripcion = '';

    const userAssignmentValue = formData.get('user-assignment');
    let usuarioAsignado = userAssignmentValue;
    if (userAssignmentValue && userAssignmentValue.includes('(')) {
        usuarioAsignado = userAssignmentValue.split('(')[0].trim();
    }
    
    try {
        // Primero, obtener la descripci√≥n del n√∫mero de parte
        console.log(`üîç Obteniendo descripci√≥n para n√∫mero de parte: ${partNumber}`);
        
        const { data: partData, error: partError } = await supabase
            .from('numerosinventario')
            .select('descripcion')
            .eq('inventario_id', partNumber)
            .limit(1);
        
        if (partError) {
            console.warn('Error al obtener descripci√≥n:', partError);
        } else if (partData && partData.length > 0) {
            descripcion = partData[0].descripcion || '';
            console.log(`‚úÖ Descripci√≥n encontrada: \"${descripcion}\"`);
        } else {
            console.warn(`‚ö†Ô∏è No se encontr√≥ descripci√≥n para el n√∫mero de parte: ${partNumber}`);
        }
        
        // Crear la asignaci√≥n con la descripci√≥n obtenida
        const { error } = await supabase
            .from('conteoinventario')
            .insert([{
                rack: formData.get('rack-assignment'),
                ubicacion: formData.get('location-assignment'),
                numero_parte: partNumber,
                descripcion: descripcion,
                usuario_asignado: usuarioAsignado,
                cantidad: 0,
                cantidad_contada: false,
                es_asignacion: formData.get('es_asignacion') === 'true',
                es_reconteo: false,
                fecha_actualizacion: new Date().toISOString()
            }]);
        
        if (error) throw error;
        
        Swal.fire({
            icon: 'success',
            title: 'Asignaci√≥n creada',
            text: `Asignaci√≥n creada correctamente${descripcion ? ` con descripci√≥n: "${descripcion}"` : ''}`,
            timer: 3000,
            showConfirmButton: false
        });
        
        e.target.reset();
        await loadAssignments();
        
    } catch (error) {
        console.error('Error al crear asignaci√≥n:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al crear la asignaci√≥n: ' + error.message
        });
    }
}

async function handleUserRegister(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const { error } = await supabase
            .from('usuarioconteo')
            .insert([{
                nombre: formData.get('new-user-name'),
                correo: formData.get('new-user-email')
            }]);
        
        if (error) throw error;
        
        Swal.fire({
            icon: 'success',
            title: 'Usuario registrado',
            text: 'El usuario se ha registrado correctamente',
            timer: 2000,
            showConfirmButton: false
        });
        
        e.target.reset();
        await loadUserData();
        
    } catch (error) {
        console.error('Error al registrar usuario:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al registrar usuario: ' + error.message
        });
    }
}

async function handleInventorySubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const { error } = await supabase
            .from('conteoinventario')
            .insert([{
                rack: formData.get('rack'),
                ubicacion: formData.get('location'),
                numero_parte: formData.get('part-number'),
                descripcion: formData.get('description'),
                usuario_asignado: formData.get('user'),
                cantidad: parseInt(formData.get('quantity')),
                cantidad_contada: true,
                es_asignacion: false,
                es_reconteo: false,
                fecha_actualizacion: new Date().toISOString()
            }]);
        
        if (error) throw error;
        
        Swal.fire({
            icon: 'success',
            title: 'Inventario registrado',
            text: 'El inventario se ha registrado correctamente',
            timer: 2000,
            showConfirmButton: false
        });
        
        e.target.reset();
        await loadInventoryData();
        
    } catch (error) {
        console.error('Error al registrar inventario:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al registrar inventario: ' + error.message
        });
    }
}

async function handleInventoryNumbersSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const rack = formData.get('inventory-rack');
        const ubicacion = formData.get('inventory-location');
        
        // Determinar si es una variaci√≥n
        const esVariacion = (rack === 'VARIACIONES' && ubicacion === 'VARIACIONES');
        
        const { error } = await supabase
            .from('conteoinventario')
            .insert([{
                rack: rack,
                ubicacion: ubicacion,
                ubicacion_real: ubicacion,
                numero_parte: formData.get('inventory-part-number'),
                descripcion: formData.get('inventory-description') || '',
                usuario_asignado: formData.get('inventory-user'),
                cantidad: parseInt(formData.get('inventory-quantity')),
                cantidad_contada: true,
                es_asignacion: false,
                es_reconteo: false,
                variaciones: esVariacion,
                fecha_actualizacion: new Date().toISOString()
            }]);
        
        if (error) throw error;
        
        Swal.fire({
            icon: 'success',
            title: 'N√∫mero de inventario registrado',
            text: 'El n√∫mero de inventario se ha registrado correctamente',
            timer: 2000,
            showConfirmButton: false
        });
        
        e.target.reset();
        await loadInventoryData();
        
    } catch (error) {
        console.error('Error al registrar n√∫mero de inventario:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al registrar n√∫mero de inventario: ' + error.message
        });
    }
}

// Funci√≥n para manejar el submit del formulario de carga masiva (sin cambios)
async function handleBulkUploadSubmit(e) {
    e.preventDefault();
    const fileInput = document.getElementById('excel-file');
    
    if (!fileInput || fileInput.files.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Archivo no seleccionado',
            text: 'Por favor, selecciona un archivo Excel para subir.'
        });
        return;
    }
    
    const file = fileInput.files[0];
    if (!['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'].includes(file.type)) {
        Swal.fire({
            icon: 'error',
            title: 'Tipo de archivo no v√°lido',
            text: 'Por favor, selecciona un archivo Excel (.xlsx o .xls).'
        });
        return;
    }
    
    await handleBulkUpload(file);
}

// Funci√≥n para manejar carga masiva
async function handleBulkUpload(file) {
    const resultDiv = document.getElementById('upload-result');
    const messagesDiv = document.getElementById('upload-messages');
    const submitBtn = document.getElementById('upload-submit-btn');
    let successCount = 0;
    let errorCount = 0;
    let messages = [];

    if (resultDiv) resultDiv.classList.remove('hidden');
    if (messagesDiv) messagesDiv.innerHTML = '<p class="text-blue-500">Procesando archivo...</p>';
    if (submitBtn) submitBtn.disabled = true;

    try {
        const data = await readFileAsArrayBuffer(file);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        if (jsonData.length === 0) {
            messages.push('<p class="text-yellow-500">Advertencia: El archivo est√° vac√≠o o no tiene filas de datos.</p>');
            if (messagesDiv) messagesDiv.innerHTML = messages.join('');
            return;
        }

        // Validar columnas - FORMATO MODIFICADO PARA VISTA DE ASIGNACIONES
        const requiredHeaders = ['Usuario', 'Rack', 'Ubicaci√≥n', 'N√∫mero de Parte', 'Descripci√≥n'];
        const fileHeaders = Object.keys(jsonData[0]).map(h => h.trim());
        console.log('Headers encontrados en el archivo:', fileHeaders);

        const missingHeaders = requiredHeaders.filter(header => !fileHeaders.includes(header));
        if (missingHeaders.length > 0) {
            messages.push(`<p class="text-red-500">Error: Faltan las siguientes columnas obligatorias: ${missingHeaders.join(', ')}</p>`);
            messages.push(`<p class="text-blue-500">Formato esperado: Usuario, Rack, Ubicaci√≥n, N√∫mero de Parte, Descripci√≥n</p>`);
            if (messagesDiv) messagesDiv.innerHTML = messages.join('');
            return;
        }

        // Procesar filas
        for (let i = 0; i < jsonData.length; i++) {
            const row = jsonData[i];
            let rowSuccess = true;
            let errorMsg = '';

            // Mapear columnas del Excel - ORDEN MODIFICADO
            const usuarioAsignado = row['Usuario']?.toString().trim();
            const rack = row['Rack']?.toString().trim();
            const ubicacion = row['Ubicaci√≥n']?.toString().trim();
            const numeroParte = row['N√∫mero de Parte']?.toString().trim();
            const descripcion = row['Descripci√≥n']?.toString().trim();

            // Validaciones b√°sicas
            if (!usuarioAsignado || !rack || !ubicacion || !numeroParte || !descripcion) {
                rowSuccess = false;
                const camposFaltantes = [];
                if (!usuarioAsignado) camposFaltantes.push('Usuario');
                if (!rack) camposFaltantes.push('Rack');
                if (!ubicacion) camposFaltantes.push('Ubicaci√≥n');
                if (!numeroParte) camposFaltantes.push('N√∫mero de Parte');
                if (!descripcion) camposFaltantes.push('Descripci√≥n');
                errorMsg = `Campos obligatorios faltantes: ${camposFaltantes.join(', ')}`;
            }

            // VALIDACI√ìN DE RACK MODIFICADA - Ahora acepta letras, n√∫meros y AREA_KITEO
            if (rack && rowSuccess) {
                const rackUpper = rack.toUpperCase();
                
                // Validar que el rack sea:
                // 1. Una letra (A-Z)
                // 2. Un n√∫mero (1-999)
                // 3. AREA_KITEO
                const esLetra = /^[A-Z]$/.test(rackUpper);
                const esNumero = /^\d+$/.test(rack);
                const esAreaKiteo = rackUpper === 'AREA_KITEO';
                
                if (!esLetra && !esNumero && !esAreaKiteo) {
                    rowSuccess = false;
                    errorMsg += (errorMsg ? '; ' : '') + `Rack inv√°lido: ${rack}. Debe ser una letra (A-Z), un n√∫mero (1-999) o AREA_KITEO`;
                }
                
                // Validar que los n√∫meros est√©n en un rango razonable (1-999)
                if (esNumero) {
                    const numeroRack = parseInt(rack);
                    if (numeroRack < 1 || numeroRack > 999) {
                        rowSuccess = false;
                        errorMsg += (errorMsg ? '; ' : '') + `Rack num√©rico fuera de rango: ${rack}. Debe estar entre 1 y 999`;
                    }
                }
            }

            if (rowSuccess) {
                try {
                    // Insertar en la base de datos
                    const { error: insertError } = await supabase
                        .from('conteoinventario')
                        .insert([{
                            usuario_asignado: usuarioAsignado,
                            rack: rack, // Mantener el formato original (no convertir a may√∫sculas los n√∫meros)
                            ubicacion: ubicacion,
                            numero_parte: numeroParte,
                            descripcion: descripcion,
                            cantidad: 0,
                            cantidad_contada: false,
                            es_asignacion: true,
                            es_reconteo: false,
                            fecha_actualizacion: new Date().toISOString()
                        }]);

                    if (insertError) {
                        throw insertError;
                    }

                    successCount++;
                    console.log(`‚úÖ Fila ${i + 1} procesada correctamente - Rack: ${rack}`);

                } catch (dbError) {
                    rowSuccess = false;
                    errorCount++;
                    errorMsg = `Error de base de datos: ${dbError.message}`;
                    console.error(`‚ùå Error en fila ${i + 1}:`, dbError);
                }
            } else {
                errorCount++;
            }

            // Agregar mensaje de resultado para esta fila
            if (!rowSuccess) {
                messages.push(`<p class="text-red-500">Fila ${i + 1}: ${errorMsg}</p>`);
            }
        }

        // Mostrar resumen final
        messages.unshift(`<p class="text-green-500">‚úÖ Registros procesados exitosamente: ${successCount}</p>`);
        if (errorCount > 0) {
            messages.unshift(`<p class="text-red-500">‚ùå Registros con errores: ${errorCount}</p>`);
        }
        messages.unshift(`<p class="text-blue-500">üìä Total de filas procesadas: ${jsonData.length}</p>`);

        if (messagesDiv) messagesDiv.innerHTML = messages.join('');

        // Mostrar notificaci√≥n de √©xito
        if (successCount > 0) {
            Swal.fire({
                icon: 'success',
                title: 'Carga masiva completada',
                text: `Se procesaron ${successCount} registros correctamente${errorCount > 0 ? ` (${errorCount} errores)` : ''}`,
                timer: 4000,
                showConfirmButton: false
            });

            // Recargar datos
            await loadAssignments();
            await loadInventoryData();
        }

    } catch (error) {
        console.error('Error general al procesar el archivo:', error);
        if (messagesDiv) messagesDiv.innerHTML = `<p class="text-red-500">Error general: ${error.message}</p>`;
    } finally {
        if (submitBtn) submitBtn.disabled = false;
    }
}


// Funci√≥n auxiliar para leer archivo (sin cambios)
function readFileAsArrayBuffer(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsArrayBuffer(file);
    });
}

// Funciones de carga de datos
async function loadUserData() {
    try {
        const { data, error } = await supabase
            .from('usuarioconteo')
            .select('*')
            .order('nombre');
        
        if (error) throw error;
        
        // Actualizar tabla de usuarios
        const userRegistry = document.getElementById('user-registry');
        if (userRegistry) {
            userRegistry.innerHTML = data.map(user => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.correo || 'Sin correo'}</td>
                </tr>
            `).join('');
        }
        
        // Actualizar datalists
        const userLists = ['user-list', 'user-list-inventory', 'user-list-inventory-numbers'];
        userLists.forEach(listId => {
            const userList = document.getElementById(listId);
            if (userList) {
                userList.innerHTML = data.map(user => 
                    `<option value="${user.nombre} (${user.correo || 'Sin correo'})">`
                ).join('');
            }
        });
        
    } catch (error) {
        console.error('Error al cargar usuarios:', error);
    }
}

async function loadPartNumbers(datalistId) {
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('inventario_id')
            .order('inventario_id');
        
        if (error) throw error;
        
        const datalist = document.getElementById(datalistId);
        if (datalist) {
            datalist.innerHTML = data.map(item => 
                `<option value="${item.inventario_id}">`
            ).join('');
        }
        
    } catch (error) {
        console.error('Error al cargar n√∫meros de parte:', error);
    }
}

async function loadAllRacks() {
    const rackSelects = ['rack-assignment', 'rack'];
    
    // Racks con letras
    const racksLetras = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
    
    // Racks num√©ricos (puedes ajustar el rango seg√∫n tus necesidades)
    const racksNumericos = [];
    for (let i = 1; i <= 20; i++) { // Ajusta el rango seg√∫n tus racks
        racksNumericos.push(i.toString());
    }
    
    // Combinar todos los racks
    const todosLosRacks = [...racksLetras, ...racksNumericos, 'AREA_KITEO'];
    
    rackSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = '<option value="">Seleccione un Rack</option>' +
                todosLosRacks.map(rack => {
                    if (rack === 'AREA_KITEO') {
                        return `<option value="${rack}">AREA_KITEO</option>`;
                    } else if (/^\d+$/.test(rack)) {
                        return `<option value="${rack}">Rack ${rack}</option>`;
                    } else {
                        return `<option value="${rack}">Rack ${rack}</option>`;
                    }
                }).join('');
        }
    });
}

// Funci√≥n para cargar racks √∫nicos desde la base de datos para inventory-rack
async function loadRacksFromDatabase() {
    try {
        console.log('üì¶ [DEBUG] Cargando racks desde numerosinventario...');
        
        // Obtener TODOS los racks sin l√≠mite de paginaci√≥n
        let allData = [];
        let from = 0;
        const pageSize = 1000;
        let hasMore = true;
        
        while (hasMore) {
            const { data, error } = await supabase
                .from('numerosinventario')
                .select('rack')
                .range(from, from + pageSize - 1);
            
            if (error) {
                console.error('‚ùå Error al consultar numerosinventario:', error);
                throw error;
            }
            
            if (data && data.length > 0) {
                allData = allData.concat(data);
                if (data.length < pageSize) {
                    hasMore = false;
                } else {
                    from += pageSize;
                }
            } else {
                hasMore = false;
            }
        }
        
        // Obtener racks √∫nicos y filtrar valores vac√≠os o null
        const uniqueRacks = [...new Set(allData.map(item => item.rack).filter(rack => rack && rack.trim() !== ''))];
        uniqueRacks.sort(); // Ordenar alfab√©ticamente
        
        console.log('üì¶ [DEBUG] Racks √∫nicos encontrados:', uniqueRacks);
        console.log('üì¶ [DEBUG] Total de racks:', uniqueRacks.length);
        
        // Cargar en el select de inventory-rack
        const inventoryRackSelect = document.getElementById('inventory-rack');
        if (inventoryRackSelect) {
            inventoryRackSelect.innerHTML = '<option value="">Seleccione un Rack</option>' +
                uniqueRacks.map(rack => `<option value="${rack}">${rack}</option>`).join('');
            console.log('‚úÖ [DEBUG] Racks cargados en inventory-rack');
        }
        
    } catch (error) {
        console.error('‚ùå Error al cargar racks desde la base de datos:', error);
    }
}

// Funci√≥n para autoseleccionar el usuario logueado en el formulario de n√∫meros de inventario
function setCurrentUserInInventoryForm() {
    const inventoryUserInput = document.getElementById('inventory-user');
    
    if (!inventoryUserInput) {
        console.warn('‚ö†Ô∏è No se encontr√≥ el campo inventory-user');
        return;
    }
    
    if (currentUser) {
        // Si el usuario tiene usuarioConteoVinculado, usar ese, sino usar full_name
        const userName = currentUser.usuarioConteoVinculado || currentUser.full_name;
        inventoryUserInput.value = userName;
        console.log('‚úÖ [DEBUG] Usuario autoseleccionado en inventory-user:', userName);
    } else {
        console.warn('‚ö†Ô∏è currentUser no est√° definido, no se puede autoseleccionar usuario');
    }
}

async function loadAssignments() {
    try {
        console.log('üîç [DEBUG] Iniciando loadAssignments...');
        console.log('üîç [DEBUG] isAdmin:', isAdmin);
        console.log('üîç [DEBUG] currentUser:', currentUser);
        
        let query = supabase
            .from('conteoinventario')
            .select('*')
            .eq('cantidad_contada', false); // Solo mostrar pendientes
        
        // Si no es admin, filtrar solo las asignaciones del usuario actual
        if (!isAdmin && currentUser) {
            const usuarioParaFiltrar = currentUser.usuarioConteoVinculado;
            console.log('üëÅÔ∏è [DEBUG] Filtrando asignaciones para usuario de conteo:', usuarioParaFiltrar);
            console.log('üëÅÔ∏è [DEBUG] Usuario de login:', currentUser.full_name);
            query = query.eq('usuario_asignado', usuarioParaFiltrar);
        } else if (isAdmin) {
            console.log('üîß [DEBUG] Usuario admin - mostrando todas las asignaciones');
        } else {
            console.log('‚ö†Ô∏è [DEBUG] No hay currentUser definido');
        }
        
        const { data, error } = await query.order('fecha_actualizacion', { ascending: false });
        
        console.log('üìä [DEBUG] Resultado de la consulta:');
        console.log('üìä [DEBUG] Error:', error);
        console.log('üìä [DEBUG] Data length:', data ? data.length : 'null');
        console.log('üìä [DEBUG] Data:', data);
        
        if (error) throw error;
        
        // Guardar los datos en la variable global
        assignmentsData = data || [];
        
        // Renderizar la tabla usando la funci√≥n de renderizado
        renderAssignmentsTable();
        
    } catch (error) {
        console.error('Error al cargar asignaciones:', error);
        const assignmentsTable = document.getElementById('assignments-table');
        if (assignmentsTable) {
            assignmentsTable.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-4 text-center text-sm text-red-500">Error al cargar asignaciones</td>
                </tr>
            `;
        }
    }
}

// Funci√≥n para cargar ubicaciones reales en los selectores
async function loadRealLocationsForSelects() {
    try {
        console.log('üìç [DEBUG] Cargando ubicaciones reales...');
        
        // Obtener TODAS las ubicaciones sin l√≠mite de paginaci√≥n
        let allData = [];
        let from = 0;
        const pageSize = 1000;
        let hasMore = true;
        
        while (hasMore) {
            const { data, error } = await supabase
                .from('numerosinventario')
                .select('location')
                .range(from, from + pageSize - 1)
                .order('location');
            
            if (error) {
                console.error('‚ùå Error al consultar numerosinventario:', error);
                throw error;
            }
            
            if (data && data.length > 0) {
                allData = allData.concat(data);
                console.log(`üìÑ [DEBUG] P√°gina cargada: ${data.length} registros (total acumulado: ${allData.length})`);
                
                // Si obtuvimos menos registros que el tama√±o de p√°gina, ya no hay m√°s
                if (data.length < pageSize) {
                    hasMore = false;
                } else {
                    from += pageSize;
                }
            } else {
                hasMore = false;
            }
        }
        
        console.log('üìä [DEBUG] Total de registros obtenidos de numerosinventario:', allData.length);
        const data = allData;
        
        // Obtener ubicaciones √∫nicas y filtrar valores vac√≠os o null
        const uniqueLocations = [...new Set(allData.map(item => item.location).filter(loc => loc && loc.trim() !== ''))];
        uniqueLocations.sort(); // Ordenar alfab√©ticamente
        
        console.log('üìç [DEBUG] Ubicaciones √∫nicas encontradas:', uniqueLocations);
        console.log('üìç [DEBUG] Total de ubicaciones:', uniqueLocations.length);
        
        // Agregar opciones a todos los selectores de ubicaci√≥n real
        const selects = document.querySelectorAll('[id^="real-location-"]');
        console.log('üìã [DEBUG] Selectores encontrados:', selects.length);
        
        if (selects.length === 0) {
            console.warn('‚ö†Ô∏è No se encontraron selectores de ubicaci√≥n real');
            return;
        }
        
        selects.forEach((select, index) => {
            // Mantener la opci√≥n por defecto
            const defaultOption = '<option value="">Seleccionar ubicaci√≥n</option>';
            const options = uniqueLocations.map(location => 
                `<option value="${location}">${location}</option>`
            ).join('');
            select.innerHTML = defaultOption + options;
            console.log(`‚úÖ [DEBUG] Selector ${index + 1} actualizado con ${uniqueLocations.length} opciones`);
        });
        
        console.log('‚úÖ [DEBUG] Ubicaciones reales cargadas exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error al cargar ubicaciones reales:', error);
    }
}

// Funci√≥n para cargar resumen por rack
async function loadRackSummary() {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('rack, cantidad, fecha_actualizacion')
            .eq('cantidad_contada', true);
        
        if (error) throw error;
        
        // Agrupar por rack
        const rackSummary = {};
        data.forEach(item => {
            if (!rackSummary[item.rack]) {
                rackSummary[item.rack] = {
                    totalItems: 0,
                    totalQuantity: 0,
                    lastUpdate: item.fecha_actualizacion
                };
            }
            rackSummary[item.rack].totalItems++;
            rackSummary[item.rack].totalQuantity += item.cantidad;
            
            // Mantener la fecha m√°s reciente
            if (new Date(item.fecha_actualizacion) > new Date(rackSummary[item.rack].lastUpdate)) {
                rackSummary[item.rack].lastUpdate = item.fecha_actualizacion;
            }
        });
        
        const rackSummaryBody = document.getElementById('rack-summary-body');
        if (rackSummaryBody) {
            if (Object.keys(rackSummary).length === 0) {
                rackSummaryBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos de inventario</td>
                    </tr>
                `;
            } else {
                rackSummaryBody.innerHTML = Object.entries(rackSummary).map(([rack, summary]) => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rack}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.totalItems}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.totalQuantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(summary.lastUpdate).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        }
        
    } catch (error) {
        console.error('Error al cargar resumen por rack:', error);
        const rackSummaryBody = document.getElementById('rack-summary-body');
        if (rackSummaryBody) {
            rackSummaryBody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-red-500">Error al cargar datos</td>
                </tr>
            `;
        }
    }
}

// Funci√≥n para cargar resumen por usuario
async function loadUserSummary() {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('usuario_asignado, rack, cantidad, fecha_actualizacion')
            .eq('cantidad_contada', true);
        
        if (error) throw error;
        
        // Agrupar por usuario y rack
        const userSummary = {};
        data.forEach(item => {
            const key = `${item.usuario_asignado}-${item.rack}`;
            if (!userSummary[key]) {
                userSummary[key] = {
                    usuario: item.usuario_asignado,
                    rack: item.rack,
                    itemsCount: 0,
                    totalQuantity: 0,
                    lastCount: item.fecha_actualizacion
                };
            }
            userSummary[key].itemsCount++;
            userSummary[key].totalQuantity += item.cantidad;
            
            // Mantener la fecha m√°s reciente
            if (new Date(item.fecha_actualizacion) > new Date(userSummary[key].lastCount)) {
                userSummary[key].lastCount = item.fecha_actualizacion;
            }
        });
        
        const userSummaryBody = document.getElementById('user-summary');
        if (userSummaryBody) {
            if (Object.keys(userSummary).length === 0) {
                userSummaryBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No hay datos de conteo por usuario</td>
                    </tr>
                `;
            } else {
                userSummaryBody.innerHTML = Object.values(userSummary).map(summary => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${summary.usuario}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.rack}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.itemsCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${summary.totalQuantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(summary.lastCount).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            }
        }
        
    } catch (error) {
        console.error('Error al cargar resumen por usuario:', error);
        const userSummaryBody = document.getElementById('user-summary');
        if (userSummaryBody) {
            userSummaryBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">Error al cargar datos</td>
                </tr>
            `;
        }
    }
}

// Funci√≥n para generar el badge de estado din√°mico usando timestamps
function getStatusBadge(item) {
    // Detectar reconteos bas√°ndose en la diferencia entre fecha_creacion y fecha_actualizacion
    const fechaCreacion = new Date(item.fecha_creacion || item.created_at);
    const fechaActualizacion = new Date(item.fecha_actualizacion || item.updated_at);
    
    // Diferencia en minutos
    const diferenciaMinutos = Math.abs(fechaActualizacion - fechaCreacion) / (1000 * 60);
    
    if (diferenciaMinutos < 2) {
        // Si la diferencia es menor a 2 minutos, es conteo inicial
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    Contado
                </span>`;
    } else {
        // Si hay diferencia significativa, es reconteo/modificaci√≥n
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                    Recontado
                </span>`;
    }
}

// Funci√≥n para cargar registros detallados de inventario
async function loadInventoryData() {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('*')
            .eq('cantidad_contada', true)
            .order('fecha_actualizacion', { ascending: false });
        
        if (error) throw error;
        
        const inventoryTableBody = document.getElementById('inventory-table-body');
        if (inventoryTableBody) {
            if (data.length === 0) {
                inventoryTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-sm text-gray-500">No hay registros de inventario</td>
                    </tr>
                `;
            } else {
                inventoryTableBody.innerHTML = data.map(item => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.fecha_actualizacion).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.rack}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.ubicacion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.numero_parte}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.descripcion || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.ubicacion_real || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.usuario_asignado}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${getStatusBadge(item)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <button onclick="recountInventoryItem(${item.id})" class="text-orange-600 hover:text-orange-900 mr-2" title="Reconteo">
                                <i class="fas fa-book"></i>
                            </button>
                            <button onclick="editInventoryItem(${item.id})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteInventoryItem(${item.id})" class="text-red-600 hover:text-red-900" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        // Cargar tambi√©n los res√∫menes
        await loadRackSummary();
        await loadUserSummary();
        
    } catch (error) {
        console.error('Error al cargar datos de inventario:', error);
        const inventoryTableBody = document.getElementById('inventory-table-body');
        if (inventoryTableBody) {
            inventoryTableBody.innerHTML = `
                <tr>
                    <td colspan="10" class="px-6 py-4 text-center text-sm text-red-500">Error al cargar registros</td>
                </tr>
            `;
        }
    }
}

async function loadInventoryNumbers() {
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('inventario_id')
            .order('inventario_id');
        
        if (error) throw error;
        
        const inventoryNumberList = document.getElementById('inventory-number-list');
        if (inventoryNumberList) {
            inventoryNumberList.innerHTML = data.map(item => 
                `<option value="${item.inventario_id}">`
            ).join('');
        }
        
    } catch (error) {
        console.error('Error al cargar n√∫meros de inventario:', error);
    }
}

// Funciones de manejo de cambios
async function handleRackAssignmentChange() {
    const rackSelect = document.getElementById('rack-assignment');
    const locationSelect = document.getElementById('location-assignment');
    
    if (!rackSelect || !locationSelect) return;
    
    const selectedRack = rackSelect.value;
    locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
    
    if (selectedRack) {
        await loadLocationsForRack(selectedRack, 'location-assignment');
    }
}

async function handleRackChange() {
    const rackSelect = document.getElementById('rack');
    const locationSelect = document.getElementById('location');
    
    if (!rackSelect || !locationSelect) return;
    
    const selectedRack = rackSelect.value;
    locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
    
    if (selectedRack) {
        await loadLocationsForRack(selectedRack, 'location');
    }
}

async function handleInventoryRackChange() {
    const rackSelect = document.getElementById('inventory-rack');
    const locationSelect = document.getElementById('inventory-location');
    
    if (!rackSelect || !locationSelect) return;
    
    const selectedRack = rackSelect.value;
    locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
    
    if (selectedRack === 'VARIACIONES') {
        // Si el rack es VARIACIONES, agregar solo la opci√≥n VARIACIONES en ubicaci√≥n
        locationSelect.innerHTML += '<option value="VARIACIONES">VARIACIONES</option>';
    } else if (selectedRack) {
        await loadLocationsForRack(selectedRack, 'inventory-location');
    }
}

async function handlePartNumberAssignmentBlur() {
    const partNumberInput = document.getElementById('part-number-assignment');
    const rackSelect = document.getElementById('rack-assignment');
    const locationSelect = document.getElementById('location-assignment');
    
    if (!partNumberInput || !rackSelect || !locationSelect) {
        console.error('No se encontraron los elementos del DOM necesarios');
        return;
    }
    
    const partNumber = partNumberInput.value.trim();
    
    if (!partNumber) {
        // Si se borra el n√∫mero de parte, restaurar estado inicial
        await loadAllRacks();
        locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
        rackSelect.value = '';
        return;
    }
    
    console.log(`üîç Buscando informaci√≥n para n√∫mero de parte: ${partNumber}`);
    
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('rack, location')
            .eq('inventario_id', partNumber)
            .limit(1);
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            console.warn(`‚ùå N√∫mero de parte ${partNumber} no encontrado`);
            Swal.fire({
                icon: 'warning',
                title: 'N√∫mero de parte no encontrado',
                text: 'El n√∫mero de parte ingresado no existe en la base de datos.',
                timer: 3000,
                showConfirmButton: false
            });
            rackSelect.value = '';
            locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
            return;
        }
        
        const defaultRecord = data[0];
        console.log(`‚úÖ Informaci√≥n encontrada:`, defaultRecord);
        console.log(`üìã Rack de BD: "${defaultRecord.rack}" (tipo: ${typeof defaultRecord.rack})`);
        console.log(`üìã Ubicaci√≥n de BD: "${defaultRecord.location}" (tipo: ${typeof defaultRecord.location})`);
        
        // Cargar todos los racks primero
        await loadAllRacks();
        
        // Funci√≥n para forzar la selecci√≥n del rack con m√∫ltiples estrategias
        const forceRackSelection = () => {
            console.log(`üéØ Intentando seleccionar rack: "${defaultRecord.rack}"`);
            
            // Estrategia 1: Selecci√≥n directa
            rackSelect.value = defaultRecord.rack;
            console.log(`üìù Estrategia 1 - Valor despu√©s de asignaci√≥n directa: "${rackSelect.value}"`);
            
            if (rackSelect.value === defaultRecord.rack) {
                console.log(`‚úÖ Estrategia 1 exitosa - Rack seleccionado: "${rackSelect.value}"`);
                return true;
            }
            
            // Estrategia 2: Buscar por texto y seleccionar
            console.log(`üîÑ Estrategia 1 fall√≥, probando estrategia 2...`);
            const options = Array.from(rackSelect.options);
            console.log(`üìã Opciones disponibles:`, options.map(opt => `"${opt.value}" -> "${opt.text}"`));
            
            const matchingOption = options.find(option => 
                option.value === defaultRecord.rack || 
                option.text.includes(defaultRecord.rack) ||
                option.value.toLowerCase() === defaultRecord.rack.toLowerCase()
            );
            
            if (matchingOption) {
                rackSelect.value = matchingOption.value;
                console.log(`‚úÖ Estrategia 2 exitosa - Opci√≥n encontrada: "${matchingOption.value}" -> "${matchingOption.text}"`);
                return true;
            }
            
            // Estrategia 3: Crear la opci√≥n si no existe
            console.log(`üîÑ Estrategia 2 fall√≥, probando estrategia 3...`);
            const newOption = document.createElement('option');
            newOption.value = defaultRecord.rack;
            newOption.textContent = defaultRecord.rack === 'AREA_KITEO' ? defaultRecord.rack : `Rack ${defaultRecord.rack}`;
            rackSelect.appendChild(newOption);
            rackSelect.value = defaultRecord.rack;
            
            if (rackSelect.value === defaultRecord.rack) {
                console.log(`‚úÖ Estrategia 3 exitosa - Opci√≥n creada y seleccionada: "${defaultRecord.rack}"`);
                return true;
            }
            
            console.error(`‚ùå Todas las estrategias fallaron para seleccionar rack: "${defaultRecord.rack}"`);
            return false;
        };
        
        // Funci√≥n para forzar la selecci√≥n de ubicaci√≥n
        const forceLocationSelection = async () => {
            console.log(`üéØ Cargando ubicaciones para rack: "${defaultRecord.rack}"`);
            await loadLocationsForRack(defaultRecord.rack, 'location-assignment');
            
            setTimeout(() => {
                console.log(`üéØ Intentando seleccionar ubicaci√≥n: "${defaultRecord.location}"`);
                locationSelect.value = defaultRecord.location;
                
                if (locationSelect.value === defaultRecord.location) {
                    console.log(`‚úÖ Ubicaci√≥n seleccionada exitosamente: "${defaultRecord.location}"`);
                } else {
                    console.warn(`‚ùå No se pudo seleccionar ubicaci√≥n: "${defaultRecord.location}"`);
                    console.log(`üìã Opciones de ubicaci√≥n disponibles:`, 
                        Array.from(locationSelect.options).map(opt => `"${opt.value}"`));
                    
                    // Intentar crear la opci√≥n de ubicaci√≥n si no existe
                    const newLocationOption = document.createElement('option');
                    newLocationOption.value = defaultRecord.location;
                    newLocationOption.textContent = defaultRecord.location;
                    locationSelect.appendChild(newLocationOption);
                    locationSelect.value = defaultRecord.location;
                    
                    if (locationSelect.value === defaultRecord.location) {
                        console.log(`‚úÖ Ubicaci√≥n creada y seleccionada: "${defaultRecord.location}"`);
                    }
                }
            }, 200);
        };
        
        // Ejecutar selecci√≥n con delay
        setTimeout(async () => {
            const rackSuccess = forceRackSelection();
            if (rackSuccess) {
                await forceLocationSelection();
            }
            
            // Mostrar mensaje de √©xito
            setTimeout(() => {
                const finalRack = rackSelect.value;
                const finalLocation = locationSelect.value;
                
                console.log(`üèÅ Resultado final - Rack: "${finalRack}", Ubicaci√≥n: "${finalLocation}"`);
                
                Swal.fire({
                    icon: finalRack && finalLocation ? 'success' : 'warning',
                    title: finalRack && finalLocation ? 'Informaci√≥n cargada' : 'Carga parcial',
                    text: `Rack: ${finalRack || 'No seleccionado'}, Ubicaci√≥n: ${finalLocation || 'No seleccionada'}`,
                    timer: 3000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }, 300);
        }, 150);
        
    } catch (error) {
        console.error('‚ùå Error al buscar informaci√≥n del n√∫mero de parte:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de B√∫squeda',
            text: 'Ocurri√≥ un problema al buscar la informaci√≥n del n√∫mero de parte.'
        });
        rackSelect.value = '';
        locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
    }
}

// Funci√≥n para autocompletar en inventario manual
async function handlePartNumberInventoryBlur() {
    const partNumberInput = document.getElementById('part-number');
    const rackSelect = document.getElementById('rack');
    const locationSelect = document.getElementById('location');
    const descriptionInput = document.getElementById('description');
    
    if (!partNumberInput || !rackSelect || !locationSelect || !descriptionInput) {
        console.error('No se encontraron los elementos del DOM necesarios para inventario manual');
        return;
    }
    
    const partNumber = partNumberInput.value.trim();
    
    if (!partNumber) {
        // Si se borra el n√∫mero de parte, restaurar estado inicial
        await loadAllRacks();
        locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
        rackSelect.value = '';
        descriptionInput.value = '';
        return;
    }
    
    console.log(`üîç [Inventario Manual] Buscando informaci√≥n para n√∫mero de parte: ${partNumber}`);
    
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('rack, location, descripcion')
            .eq('inventario_id', partNumber)
            .limit(1);
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            console.warn(`‚ùå [Inventario Manual] N√∫mero de parte ${partNumber} no encontrado`);
            Swal.fire({
                icon: 'warning',
                title: 'N√∫mero de parte no encontrado',
                text: 'El n√∫mero de parte ingresado no existe en la base de datos.',
                timer: 3000,
                showConfirmButton: false
            });
            rackSelect.value = '';
            locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
            descriptionInput.value = '';
            return;
        }
        
        const defaultRecord = data[0];
        console.log(`‚úÖ [Inventario Manual] Informaci√≥n encontrada:`, defaultRecord);
        console.log(`üìã [Inventario Manual] Rack: "${defaultRecord.rack}", Ubicaci√≥n: "${defaultRecord.location}", Descripci√≥n: "${defaultRecord.descripcion}"`);
        
        // Cargar todos los racks primero
        await loadAllRacks();
        
        // Funci√≥n para forzar la selecci√≥n con m√∫ltiples estrategias
        const forceInventorySelection = () => {
            console.log(`üéØ [Inventario Manual] Intentando seleccionar rack: "${defaultRecord.rack}"`);
            
            // Seleccionar rack
            rackSelect.value = defaultRecord.rack;
            
            if (rackSelect.value === defaultRecord.rack) {
                console.log(`‚úÖ [Inventario Manual] Rack seleccionado: "${rackSelect.value}"`);
            } else {
                // Crear opci√≥n si no existe
                console.log(`üîß [Inventario Manual] Creando opci√≥n para rack: "${defaultRecord.rack}"`);
                const newOption = document.createElement('option');
                newOption.value = defaultRecord.rack;
                newOption.textContent = defaultRecord.rack === 'AREA_KITEO' ? defaultRecord.rack : `Rack ${defaultRecord.rack}`;
                rackSelect.appendChild(newOption);
                rackSelect.value = defaultRecord.rack;
            }
            
            // Llenar descripci√≥n inmediatamente
            descriptionInput.value = defaultRecord.descripcion || '';
            console.log(`‚úÖ [Inventario Manual] Descripci√≥n establecida: "${descriptionInput.value}"`);
        };
        
        // Funci√≥n para cargar y seleccionar ubicaci√≥n
        const forceLocationSelection = async () => {
            console.log(`üéØ [Inventario Manual] Cargando ubicaciones para rack: "${defaultRecord.rack}"`);
            await loadLocationsForRack(defaultRecord.rack, 'location');
            
            setTimeout(() => {
                console.log(`üéØ [Inventario Manual] Intentando seleccionar ubicaci√≥n: "${defaultRecord.location}"`);
                locationSelect.value = defaultRecord.location;
                
                if (locationSelect.value === defaultRecord.location) {
                    console.log(`‚úÖ [Inventario Manual] Ubicaci√≥n seleccionada: "${defaultRecord.location}"`);
                } else {
                    // Crear opci√≥n si no existe
                    const newLocationOption = document.createElement('option');
                    newLocationOption.value = defaultRecord.location;
                    newLocationOption.textContent = defaultRecord.location;
                    locationSelect.appendChild(newLocationOption);
                    locationSelect.value = defaultRecord.location;
                    
                    if (locationSelect.value === defaultRecord.location) {
                        console.log(`‚úÖ [Inventario Manual] Ubicaci√≥n creada y seleccionada: "${defaultRecord.location}"`);
                    }
                }
            }, 200);
        };
        
        // Ejecutar selecci√≥n con delay
        setTimeout(async () => {
            forceInventorySelection();
            await forceLocationSelection();
            
            // Mostrar mensaje de √©xito
            setTimeout(() => {
                const finalRack = rackSelect.value;
                const finalLocation = locationSelect.value;
                const finalDescription = descriptionInput.value;
                
                console.log(`üèÅ [Inventario Manual] Resultado final - Rack: "${finalRack}", Ubicaci√≥n: "${finalLocation}", Descripci√≥n: "${finalDescription}"`);
                
                Swal.fire({
                    icon: finalRack && finalLocation && finalDescription ? 'success' : 'warning',
                    title: finalRack && finalLocation && finalDescription ? 'Informaci√≥n cargada' : 'Carga parcial',
                    text: `Rack: ${finalRack || 'No seleccionado'}, Ubicaci√≥n: ${finalLocation || 'No seleccionada'}, Descripci√≥n: ${finalDescription || 'No encontrada'}`,
                    timer: 3000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }, 300);
        }, 150);
        
    } catch (error) {
        console.error('‚ùå [Inventario Manual] Error al buscar informaci√≥n del n√∫mero de parte:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de B√∫squeda',
            text: 'Ocurri√≥ un problema al buscar la informaci√≥n del n√∫mero de parte.'
        });
        rackSelect.value = '';
        locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>';
        descriptionInput.value = '';
    }
}

// Funci√≥n para autocompletar descripci√≥n en n√∫meros de inventario
async function handlePartNumberInventoryNumbersBlur() {
    const partNumberInput = document.getElementById('inventory-part-number');
    const descriptionInput = document.getElementById('inventory-description');
    
    if (!partNumberInput || !descriptionInput) {
        console.error('No se encontraron los elementos del DOM necesarios para n√∫meros de inventario');
        return;
    }
    
    const partNumber = partNumberInput.value.trim();
    
    if (!partNumber) {
        descriptionInput.value = '';
        return;
    }
    
    console.log(`üîç [N√∫meros Inventario] Buscando descripci√≥n para: ${partNumber}`);
    
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('descripcion')
            .eq('inventario_id', partNumber)
            .limit(1);
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            console.warn(`‚ö†Ô∏è [N√∫meros Inventario] N√∫mero de parte ${partNumber} no encontrado`);
            descriptionInput.value = 'No encontrado';
            return;
        }
        
        const description = data[0].descripcion || 'Sin descripci√≥n';
        descriptionInput.value = description;
        console.log(`‚úÖ [N√∫meros Inventario] Descripci√≥n cargada: ${description}`);
        
    } catch (error) {
        console.error('‚ùå [N√∫meros Inventario] Error al buscar descripci√≥n:', error);
        descriptionInput.value = 'Error al cargar';
    }
}

// Funci√≥n para cargar ubicaciones por rack
async function loadLocationsForRack(rack, locationSelectId) {
    try {
        const { data, error } = await supabase
            .from('numerosinventario')
            .select('location')
            .eq('rack', rack)
            .order('location');
        
        if (error) throw error;
        
        const locationSelect = document.getElementById(locationSelectId);
        if (locationSelect) {
            const uniqueLocations = [...new Set(data.map(item => item.location))];
            locationSelect.innerHTML = '<option value="">Seleccione ubicaci√≥n</option>' +
                uniqueLocations.map(location => 
                    `<option value="${location}">${location}</option>`
                ).join('');
        }
        
    } catch (error) {
        console.error('Error al cargar ubicaciones:', error);
    }
}

// Funciones de filtros para inventario
function applyInventoryFilters() {
    const userFilter = document.getElementById('filter-user').value.toLowerCase();
    const partFilter = document.getElementById('filter-part').value.toLowerCase();
    const rows = document.querySelectorAll('#inventory-table-body tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 1) { // Evitar la fila de "cargando" o "sin datos"
            const usuario = cells[6].textContent.toLowerCase(); // Columna Usuario
            const numeroParte = cells[3].textContent.toLowerCase(); // Columna N√∫mero de Parte
            
            const matchUser = !userFilter || usuario.includes(userFilter);
            const matchPart = !partFilter || numeroParte.includes(partFilter);
            
            row.style.display = (matchUser && matchPart) ? '' : 'none';
        }
    });
}

function clearInventoryFilters() {
    document.getElementById('filter-user').value = '';
    document.getElementById('filter-part').value = '';
    applyInventoryFilters();
}

// Funciones de exportaci√≥n para inventario
async function exportInventoryToExcel() {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('*')
            .eq('cantidad_contada', true)
            .order('fecha_actualizacion', { ascending: false });
        
        if (error) throw error;
        
        // Preparar datos para Excel
        const excelData = data.map(item => ({
            'Fecha/Hora': new Date(item.fecha_actualizacion).toLocaleString(),
            'Rack': item.rack,
            'Ubicaci√≥n': item.ubicacion,
            'N√∫mero de Parte': item.numero_parte,
            'Descripci√≥n': item.descripcion || 'N/A',
            'Cantidad': item.cantidad,
            'Usuario': item.usuario_asignado
        }));
        
        // Crear workbook y worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
        
        // Descargar archivo
        const fileName = `inventario_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        Swal.fire({
            icon: 'success',
            title: 'Exportaci√≥n exitosa',
            text: `Archivo ${fileName} descargado correctamente`,
            timer: 3000,
            showConfirmButton: false
        });
        
    } catch (error) {
        console.error('Error al exportar a Excel:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de exportaci√≥n',
            text: 'No se pudo exportar el archivo Excel'
        });
    }
}

async function exportInventoryToPDF() {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('*')
            .eq('cantidad_contada', true)
            .order('fecha_actualizacion', { ascending: false });
        
        if (error) throw error;
        
        // Crear contenido HTML para PDF
        let htmlContent = `
            <html>
            <head>
                <title>Reporte de Inventario</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #1e3a8a; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f3f4f6; font-weight: bold; }
                    tr:nth-child(even) { background-color: #f9fafb; }
                </style>
            </head>
            <body>
                <h1>Reporte de Inventario</h1>
                <p><strong>Fecha de generaci√≥n:</strong> ${new Date().toLocaleString()}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Rack</th>
                            <th>Ubicaci√≥n</th>
                            <th>N√∫mero de Parte</th>
                            <th>Descripci√≥n</th>
                            <th>Cantidad</th>
                            <th>Usuario</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.forEach(item => {
            htmlContent += `
                <tr>
                    <td>${new Date(item.fecha_actualizacion).toLocaleString()}</td>
                    <td>${item.rack}</td>
                    <td>${item.ubicacion}</td>
                    <td>${item.numero_parte}</td>
                    <td>${item.descripcion || 'N/A'}</td>
                    <td>${item.cantidad}</td>
                    <td>${item.usuario_asignado}</td>
                </tr>
            `;
        });
        
        htmlContent += `
                    </tbody>
                </table>
            </body>
            </html>
        `;
        
        // Abrir ventana para imprimir/guardar como PDF
        const printWindow = window.open('', '_blank');
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.print();
        
        Swal.fire({
            icon: 'success',
            title: 'PDF generado',
            text: 'Se abri√≥ una ventana para imprimir o guardar como PDF',
            timer: 3000,
            showConfirmButton: false
        });
        
    } catch (error) {
        console.error('Error al exportar a PDF:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error de exportaci√≥n',
            text: 'No se pudo generar el archivo PDF'
        });
    }
}

// Funciones de acciones para registros de inventario
async function editInventoryItem(id) {
    try {
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        const { value: formValues } = await Swal.fire({
            title: 'Editar Registro de Inventario',
            html: `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cantidad:</label>
                        <input id="edit-quantity" type="number" value="${data.cantidad}" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Descripci√≥n:</label>
                        <input id="edit-description" type="text" value="${data.descripcion || ''}" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
            `,
            focusConfirm: false,
            preConfirm: () => {
                return {
                    cantidad: document.getElementById('edit-quantity').value,
                    descripcion: document.getElementById('edit-description').value
                }
            }
        });
        
        if (formValues) {
            const { error: updateError } = await supabase
                .from('conteoinventario')
                .update({
                    cantidad: parseInt(formValues.cantidad),
                    descripcion: formValues.descripcion,
                    fecha_actualizacion: new Date().toISOString()
                })
                .eq('id', id);
            
            if (updateError) throw updateError;
            
            Swal.fire({
                icon: 'success',
                title: 'Registro actualizado',
                text: 'El registro se ha actualizado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
            
            await loadInventoryData();
        }
        
    } catch (error) {
        console.error('Error al editar registro:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo editar el registro'
        });
    }
}

async function deleteInventoryItem(id) {
    const result = await Swal.fire({
        title: '¬øEliminar registro?',
        text: 'Esta acci√≥n no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S√≠, eliminar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const { error } = await supabase
                .from('conteoinventario')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            
            Swal.fire({
                icon: 'success',
                title: 'Registro eliminado',
                text: 'El registro se ha eliminado correctamente',
                timer: 2000,
                showConfirmButton: false
            });
            
            await loadInventoryData();
            
        } catch (error) {
            console.error('Error al eliminar registro:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo eliminar el registro'
            });
        }
    }
}

// Funciones de exportaci√≥n originales
function exportToExcel() {
    // Implementar exportaci√≥n a Excel
    console.log('Exportando a Excel...');
}

function exportToPDF() {
    // Implementar exportaci√≥n a PDF
    console.log('Exportando a PDF...');
}

// Funci√≥n de filtrado
function filterAssignments() {
    const searchTerm = document.getElementById('search-filter').value.toLowerCase();
    const rows = document.querySelectorAll('#assignments-table tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}


    
  

// Funci√≥n para reconteo de inventario - Mover de vuelta a Vista de Asignaciones
async function recountInventoryItem(id) {
    try {
        // Obtener datos actuales del registro
        const { data, error } = await supabase
            .from('conteoinventario')
            .select('*')
            .eq('id', id)
            .single();
        
        if (error) throw error;
        
        const result = await Swal.fire({
            title: 'üìñ Solicitar Reconteo',
            html: `
                <div class="text-left space-y-4">
                    <div class="bg-gray-50 p-3 rounded">
                        <p><strong>N√∫mero de Parte:</strong> ${data.numero_parte}</p>
                        <p><strong>Descripci√≥n:</strong> ${data.descripcion || 'N/A'}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${data.rack} - ${data.ubicacion}</p>
                        <p><strong>Usuario Asignado:</strong> ${data.usuario_asignado}</p>
                        <p><strong>Cantidad Actual:</strong> ${data.cantidad}</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                        <p class="text-sm text-yellow-800">
                            <strong>¬øSolicitar reconteo?</strong><br>
                            Este registro se mover√° de vuelta a "Vista de Asignaciones" 
                            para que el usuario asignado pueda volver a contarlo.
                        </p>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'S√≠, solicitar reconteo',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#f97316',
            icon: 'question'
        });
        
        if (result.isConfirmed) {
            // Marcar el registro como pendiente de reconteo
            const { error: updateError } = await supabase
                .from('conteoinventario')
                .update({
                    cantidad_contada: false, // Mover de vuelta a pendientes
                    fecha_actualizacion: new Date().toISOString()
                })
                .eq('id', id);
            
            if (updateError) throw updateError;
            
            Swal.fire({
                icon: 'success',
                title: 'Reconteo solicitado',
                html: `
                    <div class="text-left">
                        <p>El registro se ha movido a "Vista de Asignaciones"</p>
                        <p><strong>Usuario:</strong> ${data.usuario_asignado}</p>
                        <p><strong>N√∫mero de Parte:</strong> ${data.numero_parte}</p>
                        <p class="text-sm text-gray-600 mt-2">
                            El usuario podr√° recontar desde la pesta√±a "Vista de Asignaciones"
                        </p>
                    </div>
                `,
                timer: 4000,
                showConfirmButton: false
            });
            
            // Recargar ambas tablas
            await loadInventoryData(); // Recargar registros de inventario
            await loadAssignments(); // Recargar asignaciones pendientes
        }
        
    } catch (error) {
        console.error('Error al solicitar reconteo:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'No se pudo solicitar el reconteo: ' + error.message
        });
    }
}

 // Funci√≥n para registrar cantidad desde Vista de Asignaciones - MODIFICADA CON ALERTA DE CONFIRMACI√ìN
    async function registerQuantity(assignmentId) {
        const quantityInput = document.getElementById(`quantity-${assignmentId}`);
        const realLocationInput = document.getElementById(`real-location-${assignmentId}`);
        const quantity = parseInt(quantityInput.value);
        const realLocation = realLocationInput.value.trim();
        
        // Validar que se haya ingresado una cantidad v√°lida (permitir 0)
        if (quantityInput.value === '' || quantity < 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Cantidad requerida',
                text: 'Por favor ingresa una cantidad v√°lida (0 o mayor)',
                timer: 3000,
                showConfirmButton: false
            });
            quantityInput.focus();
            return;
        }
        
        // NUEVA FUNCIONALIDAD: Mostrar alerta de confirmaci√≥n antes de registrar
        const result = await Swal.fire({
            title: '¬øConfirmar registro?',
            html: `¬øEst√°s seguro que deseas registrar la cantidad ${quantity}?${realLocation ? '<br><strong>Ubicaci√≥n Real:</strong> ' + realLocation : ''}`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#0a192f',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'S√≠, registrar',
            cancelButtonText: 'Cancelar',
            reverseButtons: true
        });
        
        // Si el usuario cancela, no continuar con el registro
        if (!result.isConfirmed) {
            return;
        }
        
        try {
            // Preparar datos para actualizar
            const updateData = {
                cantidad: quantity,
                cantidad_contada: true,
                fecha_actualizacion: new Date().toISOString()
            };
            
            // Agregar ubicaci√≥n real si se proporcion√≥
            if (realLocation) {
                updateData.ubicacion_real = realLocation;
            }
            
            // Actualizar el registro para marcarlo como contado
            const { error } = await supabase
                .from('conteoinventario')
                .update(updateData)
                .eq('id', assignmentId);
            
            if (error) throw error;
            
            // Mostrar mensaje de √©xito
            Swal.fire({
                icon: 'success',
                title: 'Cantidad registrada',
                text: `Se registr√≥ la cantidad ${quantity} correctamente`,
                timer: 2000,
                showConfirmButton: false
            });
            
            // Remover la fila de la tabla de asignaciones
            const row = document.getElementById(`assignment-row-${assignmentId}`);
            if (row) {
                row.remove();
            }
            
            // Recargar las tablas para reflejar los cambios
            await loadAssignments(); // Recargar asignaciones pendientes
            await loadInventoryData(); // Recargar registros de inventario
            
        } catch (error) {
            console.error('Error al registrar cantidad:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo registrar la cantidad: ' + error.message
            });
        }
    }
// Variables para controlar el ordenamiento
let currentSortColumn = null;
let currentSortDirection = 'asc'; // 'asc' o 'desc'
let assignmentsData = []; // Array para almacenar los datos de las asignaciones

// Funci√≥n para ordenar la tabla de asignaciones
function sortAssignmentsTable(column) {
    console.log('üîÑ Ordenando por:', column);
    
    // Si es la misma columna, cambiar direcci√≥n
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // Si es una columna diferente, empezar en ascendente
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Actualizar iconos
    updateSortIcons(column, currentSortDirection);
    
    // Ordenar los datos
    assignmentsData.sort((a, b) => {
        let valueA = a[column] || '';
        let valueB = b[column] || '';
        
        // Convertir a string para comparaci√≥n
        valueA = valueA.toString().toLowerCase();
        valueB = valueB.toString().toLowerCase();
        
        if (currentSortDirection === 'asc') {
            return valueA.localeCompare(valueB, 'es', { numeric: true });
        } else {
            return valueB.localeCompare(valueA, 'es', { numeric: true });
        }
    });
    
    // Renderizar la tabla con los datos ordenados
    renderAssignmentsTable();
}

// Funci√≥n para actualizar los iconos de ordenamiento
function updateSortIcons(column, direction) {
    // Resetear todos los iconos
    const allIcons = ['sort-icon-rack', 'sort-icon-ubicacion'];
    allIcons.forEach(iconId => {
        const icon = document.getElementById(iconId);
        if (icon) {
            icon.className = 'fas fa-sort ml-1';
        }
    });
    
    // Actualizar el icono de la columna activa
    const activeIcon = document.getElementById(`sort-icon-${column}`);
    if (activeIcon) {
        if (direction === 'asc') {
            activeIcon.className = 'fas fa-sort-up ml-1';
        } else {
            activeIcon.className = 'fas fa-sort-down ml-1';
        }
    }
}

// Funci√≥n para renderizar la tabla de asignaciones
function renderAssignmentsTable() {
    const assignmentsTable = document.getElementById('assignments-table');
    if (!assignmentsTable) return;
    
    if (assignmentsData.length === 0) {
        assignmentsTable.innerHTML = `
            <tr>
                <td colspan="9" class="px-6 py-4 text-center text-sm text-gray-500">No hay asignaciones pendientes</td>
            </tr>
        `;
        return;
    }
    
    assignmentsTable.innerHTML = assignmentsData.map(item => `
        <tr id="assignment-row-${item.id}">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.usuario_asignado}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.rack}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.ubicacion}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.numero_parte}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.descripcion || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <input type="number" 
                       id="quantity-${item.id}" 
                       min="0" 
                       step="1" 
                       placeholder="Cantidad"
                       class="w-20 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select id="real-location-${item.id}" 
                        class="w-40 px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Seleccionar ubicaci√≥n</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <button onclick="registerQuantity(${item.id})" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-all">
                    Registrar
                </button>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.fecha_actualizacion).toLocaleDateString()}</td>
        </tr>
    `).join('');
    
    // Cargar las ubicaciones en los selectores despu√©s de que el DOM se actualice
    setTimeout(async () => {
        await loadRealLocationsForSelects();
    }, 100);
}

async function handleLogout() {
    try {
        console.log('üö∫ Cerrando sesi√≥n...');
        
        // Cerrar sesi√≥n en Supabase
        const { error } = await supabase.auth.signOut();
        
        if (error) {
            console.error('Error al cerrar sesi√≥n:', error);
            throw error;
        }
        
        console.log('‚úÖ Sesi√≥n cerrada correctamente');
        
        // Limpiar variables globales
        currentUser = null;
        isAdmin = false;
        
        // Redirigir al login
        window.location.href = 'login_completo.html';
        
    } catch (error) {
        console.error('Error en logout:', error);
        // En caso de error, forzar redirecci√≥n al login
        window.location.href = 'login_completo.html';
    }
}

    console.log("Script cargado correctamente");

    let allPartNumbers = []; // Variable global para almacenar todos los n√∫meros de parte

    // Funci√≥n para abrir el modal
    async function openPartNumberModal() {
        console.log("üîç Abriendo modal de n√∫meros de parte...");
        const modal = document.getElementById("part-number-modal");
        if (modal) {
            modal.classList.remove("hidden");
            // Cargar los datos si a√∫n no se han cargado
            if (allPartNumbers.length === 0) {
                await loadAllPartNumbersForModal();
            }
        }
    }

    // Funci√≥n para cerrar el modal
    function closePartNumberModal() {
        console.log("‚ùå Cerrando modal de n√∫meros de parte...");
        const modal = document.getElementById("part-number-modal");
        if (modal) {
            modal.classList.add("hidden");
            // Limpiar el buscador
            const searchInput = document.getElementById("part-number-search");
            if (searchInput) searchInput.value = "";
        }
    }

    // Funci√≥n para cargar todos los n√∫meros de parte para el modal
    async function loadAllPartNumbersForModal() {
        try {
            console.log("üìä Cargando n√∫meros de parte para el modal...");
            
            const gridContainer = document.getElementById("part-number-grid-container");
            if (gridContainer) {
                gridContainer.innerHTML = '<div class="col-span-full px-6 py-4 text-center text-sm text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando n√∫meros de parte...</div>';
            }
            
            // Obtener TODOS los registros sin l√≠mite de paginaci√≥n
            let allData = [];
            let from = 0;
            const pageSize = 1000;
            let hasMore = true;
            
            while (hasMore) {
                const { data, error } = await supabase
                    .from("numerosinventario")
                    .select("inventario_id")
                    .order("inventario_id")
                    .range(from, from + pageSize - 1);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    allData = allData.concat(data);
                    console.log(`‚úÖ Cargados ${data.length} registros (total: ${allData.length})`);
                    from += pageSize;
                    
                    if (data.length < pageSize) {
                        hasMore = false;
                    }
                } else {
                    hasMore = false;
                }
            }
            
            // Eliminar duplicados y ordenar
            const uniqueIds = Array.from(new Set(allData.map(item => item.inventario_id)));
            allPartNumbers = uniqueIds.sort((a, b) => a.localeCompare(b, "es", { numeric: true }));
            
            console.log(`üìä Total de n√∫meros de parte √∫nicos: ${allPartNumbers.length}`);
            
            // Renderizar la tabla
            renderPartNumberTable(allPartNumbers);
            
        } catch (error) {
            console.error("Error al cargar n√∫meros de parte:", error);
            const gridContainer = document.getElementById("part-number-grid-container");
            if (gridContainer) {
                gridContainer.innerHTML = '<div class="col-span-full px-6 py-4 text-center text-sm text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Error al cargar los datos</div>';
            }
        }
    }

    // Funci√≥n para renderizar la tabla de n√∫meros de parte
    function renderPartNumberTable(partNumbers) {
        const gridContainer = document.getElementById("part-number-grid-container");
        const countElement = document.getElementById("part-number-count");
        
        if (!gridContainer) return;
        
        // Actualizar contador
        if (countElement) {
            countElement.textContent = partNumbers.length;
        }
        
        if (partNumbers.length === 0) {
            gridContainer.innerHTML = '<div class="col-span-full px-6 py-4 text-center text-sm text-gray-500"><i class="fas fa-search mr-2"></i>No se encontraron n√∫meros de parte</div>';
            return;
        }
        
        // Renderizar elementos del grid (limitado a 500 por rendimiento, se puede ajustar)
        const maxItems = 500; // Mostrar hasta 500 resultados
        const displayPartNumbers = partNumbers.slice(0, maxItems);
        
        gridContainer.innerHTML = displayPartNumbers.map(partNumber => 
            `<button onclick="selectPartNumber(\'${partNumber}\')" class="part-number-grid-item flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-150 ease-in-out">
                ${partNumber}
            </button>`
        ).join("");

        // Mostrar mensaje si hay m√°s resultados
        if (partNumbers.length > maxItems) {
            const infoDiv = document.createElement("div");
            infoDiv.className = "col-span-full px-6 py-4 text-center text-sm text-gray-500 bg-yellow-50 rounded-md";
            infoDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i>Mostrando ${maxItems} de ${partNumbers.length} resultados. Usa el buscador para filtrar.`;
            gridContainer.appendChild(infoDiv);
        }
    }

    // Funci√≥n para filtrar n√∫meros de parte
    function filterPartNumbers() {
        const searchInput = document.getElementById("part-number-search");
        if (!searchInput) return;
        
        const searchTerm = searchInput.value.toLowerCase().trim();
        
        if (searchTerm === "") {
            // Si no hay t√©rmino de b√∫squeda, mostrar todos
            renderPartNumberTable(allPartNumbers);
        } else {
            // Filtrar los n√∫meros de parte que contengan el t√©rmino de b√∫squeda
            const filtered = allPartNumbers.filter(partNumber => 
                partNumber.toLowerCase().includes(searchTerm)
            );
            renderPartNumberTable(filtered);
        }
    }

    // Funci√≥n para seleccionar un n√∫mero de parte
   async function selectPartNumber(partNumber) {
    console.log("N√∫mero de parte seleccionado:", partNumber);

    // Solo afecta al input de "Registro de N√∫meros de Inventario"
    const partNumberInput = document.getElementById("inventory-numbers-part-number");
    if (partNumberInput) {
        partNumberInput.value = partNumber;
    }

    // Buscar la descripci√≥n del n√∫mero de parte
    try {
        const { data, error } = await supabase
            .from("numerosinventario")
            .select("descripcion")
            .eq("inventario_id", partNumber)
            .limit(1);

        if (error) throw error;

        const descriptionInput = document.getElementById("inventory-description");
        if (descriptionInput && data && data.length > 0) {
            descriptionInput.value = data[0].descripcion || "";
        }
    } catch (error) {
        console.error("Error al obtener la descripci√≥n del n√∫mero de parte:", error);
        const descriptionInput = document.getElementById("inventory-description");
        if (descriptionInput) {
            descriptionInput.value = "Descripci√≥n no encontrada";
        }
    }

    // Cerrar el modal
    closePartNumberModal();
}

  async function handlePartNumberChange() {
    // Solo afectar si estamos en la pesta√±a de inventario manual (visible)
    const inventoryContent = document.getElementById('content-inventory');
    if (!inventoryContent || inventoryContent.classList.contains('hidden')) {
        return; // No hacer nada si la pesta√±a no est√° activa
    }

    const partNumberInput = document.getElementById("inventory-part-number");
    const descriptionInput = document.getElementById("description");
    
    if (!partNumberInput || !descriptionInput) {
        console.warn("Campos de inventario manual no encontrados");
        return;
    }

    const partNumber = partNumberInput.value.trim();
    if (partNumber === "") {
        descriptionInput.value = "";
        return;
    }

    try {
        const { data, error } = await supabase
            .from("numerosinventario")
            .select("descripcion")
            .eq("inventario_id", partNumber)
            .limit(1);
        if (error) throw error;
        descriptionInput.value = (data && data.length > 0) ? (data[0].descripcion || "") : "Descripci√≥n no encontrada";
    } catch (error) {
        console.error("Error al obtener la descripci√≥n:", error);
        descriptionInput.value = "Error al cargar descripci√≥n";
    }
}

    // Cerrar modal al hacer clic fuera de √©l
    document.addEventListener("click", function(event) {
        const modal = document.getElementById("part-number-modal");
        if (modal && event.target === modal) {
            closePartNumberModal();
        }
    });

    // Cerrar modal con tecla ESC
    document.addEventListener("keydown", function(event) {
        if (event.key === "Escape") {
            const modal = document.getElementById("part-number-modal");
            if (modal && !modal.classList.contains("hidden")) {
                closePartNumberModal();
            }
        }
    });
</script>
</body>
</html>
